---
title: "Predicting `r params$input_season` CFB Postseason Games"
output: 
  html_document:
    toc: TRUE #adds a Table of Contents
    theme: cerulean
    number_sections: F #number your headings/sections
    toc_float: TRUE #let your ToC follow you as you scroll
    keep_md: no
    fig.caption: yes
params:
        input_season: 2022
        nsims: 1000
        update: FALSE
---

```{r setup, include=F}

knitr::opts_chunk$set(echo = F,
                      error = F,
                      warning=F,
                      dev="png",
                      fig.width = 10,
                      fig.height = 6)
options(knitr.duplicate.label = "allow")
options(scipen=999)

```

```{r packages, include=F}

source(here::here("scripts/load_packages.R"))
library(jsonlite)
library(forcats)
library(TTR)
library(flextable)
conflict_prefer("lag", "dplyr")

```

```{r run postseason sims, include=F}

if (params$update == T) {
        source(here::here("run_postseason_sims.R"))
}


```


```{r load in results of postseason sims}

load(here::here("simulations", "postseason", params$input_season, "postseason_predictions.Rdata"))

```


```{r create tables}

# show last week's results
conference_championship_table = 
        games_and_outcomes %>%
        filter(CONFERENCE_CHAMPIONSHIP == T) %>%
        mutate(Correct = case_when(is.na(HOME_WIN) ~ NA_character_,
                                   HOME_PRED == 'yes' & HOME_WIN == 'yes' ~ 'Yes',
                                   HOME_PRED == 'no' & HOME_WIN == 'no' ~ 'Yes',
                                   TRUE ~ 'No')) %>%
        mutate(correct = case_when(is.na(HOME_WIN) ~ NA_real_,
                                   HOME_PRED == 'yes' & HOME_WIN == 'yes' ~ 1,
                                   HOME_PRED == 'no' & HOME_WIN == 'no' ~ 1,
                                   TRUE ~ 0)) %>%
        transmute(SEASON,
                  WEEK,
                  DATE = GAME_DATE,
                  QUALITY,
                  INTEREST,
                  HOME,
                  AWAY,
                  HOME_PROB,
                  PRED,
                  OUTCOME,
                  correct) %>%
        #   arrange(WEEK, desc(QUALITY)) %>%
        arrange(desc(WEEK), desc(INTEREST)) %>%
        mutate(SEASON = factor(SEASON),
               WEEK = factor(WEEK)) %>%
        mutate(HOME_PROB = case_when(HOME_PROB == 1 ~ .999,
                                     HOME_PROB == 0 ~ .001,
                                     TRUE ~ HOME_PROB)) %>%
        mutate(HOME_PROB = formatC(HOME_PROB, digits=3, format="f")) %>%
        rename(Season = SEASON,
               Date = DATE,
               Quality = QUALITY,
               #  Comp. = COMPETITIVE,
               Interest = INTEREST,
               Home = HOME,
               Away = AWAY,
               `Pr(HomeWin)` = HOME_PROB,
               Prediction = PRED,
               Result = OUTCOME) %>%
        #       Result = OUTCOME) %>%
        mutate(Quality = as.integer(Quality)) %>%
        mutate(Date = as.factor(Date)) %>%
        select(-Season, -WEEK) %>%
        datatable(escape=F,
                  rownames = F,
                  filter = list(position = 'top'),
                  class = list(stripe =F),
                  options = list(pageLength = 25,
                                 editable =T,
                                 initComplete = htmlwidgets::JS(
                                         "function(settings, json) {",
                                         paste0("$(this.api().table().container()).css({'font-size': '", '8pt', "'});"),
                                         "}"),
                                 scrollX=F,
                                 autowidth=T,
                                 columnDefs = list(
                                         list(className = 'dt-center',
                                              visible=T,
                                              targets=c("Date",
                                                        "Quality",
                                                        #    "Comp.",
                                                        "Interest",
                                                        "Pr(HomeWin)",
                                                        "Home",
                                                        "Away", 
                                                        "Prediction",
                                                        "Result")),
                                         list(className = 'dt-center',
                                              visible=F,
                                              targets=c("correct")))))  %>%
        # list(className = 'dt-center',
        #                visible=F,
        #                targets=c("correct"))))) %>%
        formatStyle(c("Quality"),
                    #  color = 'white',
                    backgroundColor = styleInterval(seq(-30, 130, 1),
                                                    qualityColorRamp(length(seq(-30, 130, 1))+1))) %>%     
        # formatStyle(c("Comp."),
        #           #  color = 'white',
        #              backgroundColor = styleInterval(seq(-30, 130, 1),
        #                                              qualityColorRamp(length(seq(-30, 130, 1))+1))) %>%    
        formatStyle(c("Interest"),
                    #  color = 'white',
                    backgroundColor = styleInterval(seq(-30, 130, 1),
                                                    qualityColorRamp(length(seq(-30, 130, 1))+1))) %>%   
        formatStyle(c("Pr(HomeWin)"),
                    backgroundColor = styleInterval(seq(0, 1.8, .01),
                                                    homeColorRamp(length(seq(0, 1.8, .01))+1))) %>%
        formatStyle('Result',
                    'correct',
                    backgroundColor = styleEqual(levels = c(1, 0),
                                                 c(homeColor,
                                                   'lightcoral')))

# show last week's results
postseason_table = 
        games_and_outcomes %>%
        filter(SEASON_TYPE == 'postseason') %>%
        mutate(Correct = case_when(is.na(HOME_WIN) ~ NA_character_,
                                   HOME_PRED == 'yes' & HOME_WIN == 'yes' ~ 'Yes',
                                   HOME_PRED == 'no' & HOME_WIN == 'no' ~ 'Yes',
                                   TRUE ~ 'No')) %>%
        mutate(correct = case_when(is.na(HOME_WIN) ~ NA_real_,
                                   HOME_PRED == 'yes' & HOME_WIN == 'yes' ~ 1,
                                   HOME_PRED == 'no' & HOME_WIN == 'no' ~ 1,
                                   TRUE ~ 0)) %>%
        transmute(SEASON,
                  WEEK,
                  DATE = GAME_DATE,
                  QUALITY,
                  INTEREST,
                  HOME,
                  AWAY,
                  HOME_PROB,
                  PRED,
                  OUTCOME,
                  correct) %>%
        #   arrange(WEEK, desc(QUALITY)) %>%
        arrange(desc(WEEK), desc(INTEREST)) %>%
        mutate(SEASON = factor(SEASON),
               WEEK = factor(WEEK)) %>%
        mutate(HOME_PROB = case_when(HOME_PROB == 1 ~ .999,
                                     HOME_PROB == 0 ~ .001,
                                     TRUE ~ HOME_PROB)) %>%
        mutate(HOME_PROB = formatC(HOME_PROB, digits=3, format="f")) %>%
        rename(Season = SEASON,
               Date = DATE,
               Quality = QUALITY,
               #  Comp. = COMPETITIVE,
               Interest = INTEREST,
               Home = HOME,
               Away = AWAY,
               `Pr(HomeWin)` = HOME_PROB,
               Prediction = PRED,
               Result = OUTCOME) %>%
        #       Result = OUTCOME) %>%
        mutate(Quality = as.integer(Quality)) %>%
        mutate(Date = as.factor(Date)) %>%
        select(-Season, -WEEK) %>%
        datatable(escape=F,
                  rownames = F,
                  filter = list(position = 'top'),
                  class = list(stripe =F),
                  options = list(pageLength = 25,
                                 editable =T,
                                 initComplete = htmlwidgets::JS(
                                         "function(settings, json) {",
                                         paste0("$(this.api().table().container()).css({'font-size': '", '8pt', "'});"),
                                         "}"),
                                 scrollX=F,
                                 autowidth=T,
                                 columnDefs = list(
                                         list(className = 'dt-center',
                                              visible=T,
                                              targets=c("Date",
                                                        "Quality",
                                                        #    "Comp.",
                                                        "Interest",
                                                        "Pr(HomeWin)",
                                                        "Home",
                                                        "Away", 
                                                        "Prediction",
                                                        "Result")),
                                         list(className = 'dt-center',
                                              visible=F,
                                              targets=c("correct")))))  %>%
        # list(className = 'dt-center',
        #                visible=F,
        #                targets=c("correct"))))) %>%
        formatStyle(c("Quality"),
                    #  color = 'white',
                    backgroundColor = styleInterval(seq(-30, 130, 1),
                                                    qualityColorRamp(length(seq(-30, 130, 1))+1))) %>%     
        # formatStyle(c("Comp."),
        #           #  color = 'white',
        #              backgroundColor = styleInterval(seq(-30, 130, 1),
        #                                              qualityColorRamp(length(seq(-30, 130, 1))+1))) %>%    
        formatStyle(c("Interest"),
                    #  color = 'white',
                    backgroundColor = styleInterval(seq(-30, 130, 1),
                                                    qualityColorRamp(length(seq(-30, 130, 1))+1))) %>%   
        formatStyle(c("Pr(HomeWin)"),
                    backgroundColor = styleInterval(seq(0, 1.8, .01),
                                                    homeColorRamp(length(seq(0, 1.8, .01))+1))) %>%
        formatStyle('Result',
                    'correct',
                    backgroundColor = styleEqual(levels = c(1, 0),
                                                 c(homeColor,
                                                   'lightcoral')))

```


# What is this? {.unnumbered}

This page displays predictions and results for college football bowl and conference champioship games for the `r params$input_season` CFB season. These predictions come from a model built on historical college football play by play and game data in order to simulate upcoming games. All data is from collegefootballdata.com. 

<!-- To see regular season win projections and conference championship / playoff / national championship probabilities for all teams as of this week, go to:  -->

# Game Predictions 

The following tables display the results of simulating postseason and conference championship games for the `r params$input_season` CFB season `r params$nsims` times. These simulations are run using information on all previous game outcomes in the lead up to each game.

**Quality** indicates the quality of the teams involved in the game. This is the (harmonic) mean of the two team's pregame ratings and is scaled to range from 0 to 100, with 100 indicating a game between highly rated opponents.

<!-- **Comp.** indicates how competitive a matchup is expected to be based on the the pre game home win probability. The rating itself is a quadratic formula applied**Pr(HomeWin)** and produces a score that ranges from 0 to 100, with 100 indicating a game between teams with nearly identical ratings and 0 indicating a game that that where the home team is extremely likely to win or lose. -->

**Interest** indicates how interesting/appealing a matchup is expected to be based on Quality and how close the game is expected to be. I assign every game a competitive rating using a quadratic formula applied to **Pr(HomeWin)**, which I use along with Quality in a weighted average to produce the **Interest** score. This ranges from 0 to 100, where 100 indicates a very competitive game between two highly rated opponents.

**Pr(HomeWin)** is the percentage of times that the home team won the game across every simulation. 

## Bowl Games

```{r bowl game table}

postseason_table

```

## Conference Championship Games

```{r conference championship table}

conference_championship_table

```