---
title: "College Football Team Predictions"
#author: "Phil Henrickson"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: TRUE #adds a Table of Contents
    theme: cerulean
  #  number_sections: TRUE #number your headings/sections
    toc_float: TRUE #let your ToC follow you as you scroll
    keep_md: no
    fig.caption: yes
params:
        team: "Texas"
        input_season: 2022
---

```{r setup, include=F}

knitr::opts_chunk$set(echo = F,
                      error = F,
                      warning=F,
                      dev="png",
                      fig.width = 10,
                      fig.height = 6)
options(knitr.duplicate.label = "allow")
options(scipen=999)

```

```{r packages, include=F}

source(here::here("scripts/load_packages.R"))
library(jsonlite)
library(forcats)
library(TTR)
library(flextable)
conflict_prefer("lag", "dplyr")

# parallelization
library(future.apply)
plan(multisession, workers = 7)

set_flextable_defaults(theme_fun = theme_alafoli,
                       font.color = "grey10",
                       font.size=10,
                       padding.bottom = 6, 
                       padding.top = 6,
                       padding.left = 6,
                       padding.right = 6,
                       background.color = "white")

```

```{r connect to snowflake}

library(DBI)
library(odbc)
library(RODBC)
library(keyring)

### connect to DBS
# connect to snowflake
myconn <- DBI::dbConnect(odbc::odbc(),
                         "SnowflakeDSII",
                         Database = "CFB_DEMO",
                         warehouse = "DEMO_WH",
                         uid="phil.henrickson",
                         pwd=keyring::key_get("AE_Snowflake"))

```

```{r functions and colors}

### functions
source(here::here("functions/get_expected_score.R"))
source(here::here("functions/get_new_elos.R"))
source(here::here("functions/calc_elo_ratings.R"))
source(here::here("functions", "simulateX.R"))
source(here::here("functions", "sim_game_margin.R"))
source(here::here("functions", "calc_elo_ratings.R"))
source(here::here("functions", "sim_elo_ratings.R"))
source(here::here("functions", "sim_rest_of_season.R"))
source(here::here("functions", "theme_phil.R"))

# color palettes
load(here::here("data", "team_colors.Rdata"))
custom_color_teams <- scale_colour_manual(name = "TEAM", values = team_colors)
custom_fill_teams <- scale_fill_manual(name = "TEAM", values = team_colors)

```

```{r data sources}

### get data sources
# teams raw
teams_raw = DBI::dbGetQuery(myconn,
                            paste('SELECT * FROM CFB_DEMO.CFD_RAW.TEAMS')) %>%
        as_tibble() %>%
        rename(TEAM = SCHOOL,
               TEAM_ID = ID,
               TEAM_MASCOT = MASCOT,
               TEAM_ABBREVIATION = ABBREVIATION)

# get games
games_raw = DBI::dbGetQuery(myconn,
                            paste('SELECT * FROM CFB_DEMO.CFD_RAW.ANALYSIS_GAMES')) %>%
        as_tibble() %>%
        mutate(CONFERENCE_GAME = case_when(CONFERENCE_GAME == 'true' ~ T,
                                           CONFERENCE_GAME == 'false' ~ F)) %>%
        mutate(GAME_DATE = as.Date(START_DATE)) %>%
        mutate(START_DATE = as_datetime(START_DATE)) %>%
        arrange(START_DATE) %>%
        # logic for flagging conference championship games
        group_by(SEASON, SEASON_TYPE, HOME_CONFERENCE) %>%
        mutate(LAST_GAME = START_DATE == max(START_DATE)) %>% 
        ungroup() %>%
        mutate(CONFERENCE_CHAMPIONSHIP = case_when(CONFERENCE_GAME == T & 
                                                           (HOME_CONFERENCE != 'FBS Independents') & 
                                                           (HOME_CONFERENCE != 'FCS Independents') &
                                                           !(HOME_CONFERENCE %in% 'Big Ten' & SEASON < 2014) &
                                                           !(HOME_CONFERENCE %in% 'Western Athletic') &
                                                           (NEUTRAL_SITE == T | 
                                                                    is.na(VENUE) |
                                                                    VENUE == 'Glass Bowl' |
                                                                    VENUE == 'Bright House Networks Stadium' |
                                                                    VENUE == 'Alamodome' |
                                                                    VENUE == 'Georgia Dome' |
                                                                    HOME_CONFERENCE == 'Sun Belt' |
                                                                    HOME_CONFERENCE == 'American Athletic') &
                                                           SEASON > 2000 &
                                                           SEASON_TYPE == 'regular' &
                                                           WEEK > 13 &
                                                           LAST_GAME == T ~ T,
                                                   TRUE ~ F)) %>%
        mutate(HOME_WIN = factor(case_when(HOME_POINTS > AWAY_POINTS ~ 'yes',
                                           HOME_POINTS < AWAY_POINTS ~ 'no',
                                           HOME_POINTS == AWAY_POINTS ~ 'no'),
                                 levels = c("no", "yes"))) %>%
        mutate(HOME_DIVISION  = replace_na(HOME_DIVISION, "missing"),
               AWAY_DIVISION = replace_na(AWAY_DIVISION, "missing")) %>%
        left_join(., teams_raw %>%
                          select(TEAM, TEAM_ABBREVIATION) %>%
                          rename(HOME_TEAM = TEAM,
                                 HOME_TEAM_ABBR = TEAM_ABBREVIATION),
                  by = c("HOME_TEAM")) %>%
        left_join(., teams_raw %>%
                          select(TEAM, TEAM_ABBREVIATION) %>%
                          rename(AWAY_TEAM = TEAM,
                                 AWAY_TEAM_ABBR = TEAM_ABBREVIATION),
                  by = c("AWAY_TEAM"))

# get team conference mapping
team_conference_season = DBI::dbGetQuery(myconn,
                                         paste('SELECT * FROM CFB_DEMO.CFD_RAW.ANALYSIS_TEAM_CONFERENCE_SEASON')) %>%
        as_tibble()

# team mapping function
team_mapping = teams_raw %>%
        mutate(TEAM_ABBR = gsub(" ", "\\.", gsub("[[:punct:]]", "\\.", TEAM))) %>%
        select(TEAM, TEAM_ABBR, TEAM_ABBREVIATION, COLOR, ALT_COLOR) %>%
        mutate(COLOR = case_when(TEAM == 'Toledo' ~ '#003E7E',
                                 TRUE ~ COLOR))

### get historical elo
# games
elo_games = DBI::dbGetQuery(myconn,
                                       paste('SELECT * FROM CFB_DEMO.CFD_ANALYTICS.ACTIVE_ELO_GAMES')) %>%
        as_tibble()

# teams
elo_teams = DBI::dbGetQuery(myconn,
                            paste('SELECT * FROM CFB_DEMO.CFD_ANALYTICS.ACTIVE_ELO_TEAMS')) %>%
        as_tibble() %>%
        select(-LOAD_DATE)

### recruiting 
recruiting_teams_raw = DBI::dbGetQuery(myconn,
                                       paste('SELECT * FROM CFB_DEMO.CFD_RAW.RECRUITING_TEAMS ')) %>%
        as_tibble() %>%
        mutate(POINTS = as.numeric(POINTS)) %>%
        rename(RECRUITING_POINTS = POINTS)

# expand
recruiting_teams = expand.grid(TEAM = unique(recruiting_teams_raw$TEAM),
                               YEAR = seq(min(recruiting_teams_raw$YEAR),
                                          max(recruiting_teams_raw$YEAR))) %>%
        left_join(., recruiting_teams_raw,
                  by = c("YEAR", "TEAM")) %>%
        mutate(RECRUITING_POINTS = replace_na(RECRUITING_POINTS, 0)) %>%
        filter(YEAR > 2001) %>%
        left_join(., team_conference_season,
                  by = c("YEAR"="SEASON", "TEAM")) %>%
        filter(DIVISION == 'fbs') %>%
        group_by(TEAM) %>%
        mutate(n = n()) %>%
        filter(n > 4) %>%
        group_by(TEAM) %>%
        select(-n) %>%
        mutate(EMA = EMA(RECRUITING_POINTS, n =4)) %>%
        # now fill with actual in the event that a team doesn't have yet have enough data
        mutate(EMA = case_when(is.na(EMA) & !is.na(RECRUITING_POINTS) ~ RECRUITING_POINTS,
                               TRUE ~ EMA)) %>%
        # mutate_at(c("EMA", "WMA"),
        #           replace_na, 0) %>%
        arrange(TEAM, YEAR)  %>%
        mutate(SEASON = YEAR) %>%
        ungroup() %>%
        select(TEAM, SEASON, CONFERENCE, DIVISION, RANK, RECRUITING_POINTS, EMA)

# get what we need
recruiting = recruiting_teams %>%
        select(TEAM, SEASON, CONFERENCE, RECRUITING_POINTS, EMA) %>%
        rename(RECRUITING_SCORE = EMA)


### efficiency
# season level efficiency rankings
season_team_rankings = DBI::dbGetQuery(myconn,
                paste('SELECT * FROM CFB_DEMO.CFD_ANALYTICS.EFFICIENCY_TEAM_SEASON')) %>%
        as_tibble()

### combine datasets to get games
games = games_raw %>%
        mutate(HOME_DIVISION = case_when(is.na(HOME_DIVISION) & SEASON < 1900 ~ 'fbs',
                                         TRUE ~ HOME_DIVISION)) %>%
        mutate(AWAY_DIVISION = case_when(is.na(AWAY_DIVISION) & SEASON < 1900 ~ 'fbs',
                                         TRUE ~ AWAY_DIVISION)) %>%
        mutate(FBS = HOME_DIVISION == 'fbs' | AWAY_DIVISION == 'fbs') %>%
        filter((FBS == T) | (FBS==F & SEASON < 1981)) %>%
        arrange(GAME_DATE) %>%
        select(GAME_ID, 
               SEASON, 
               WEEK,
               SEASON_TYPE,
               START_DATE,
               GAME_DATE,
               NEUTRAL_SITE, 
               HOME_TEAM,
               AWAY_TEAM,
               CONFERENCE_GAME,
               CONFERENCE_CHAMPIONSHIP,
               HOME_CONFERENCE,
               AWAY_CONFERENCE,
               HOME_DIVISION,
               AWAY_DIVISION,
               HOME_POINTS,
               AWAY_POINTS) %>%
        left_join(.,
                  recruiting %>%
                          select(SEASON,
                                 TEAM,
                                 RECRUITING_SCORE) %>%
                          rename(HOME_TEAM = TEAM,
                                 HOME_RECRUITING_SCORE = RECRUITING_SCORE),
                  by = c("SEASON",
                         "HOME_TEAM")) %>%
        left_join(.,
                  recruiting %>%
                          select(SEASON,
                                 TEAM,
                                 RECRUITING_SCORE) %>%
                          rename(AWAY_TEAM = TEAM,
                                 AWAY_RECRUITING_SCORE = RECRUITING_SCORE),
                  by = c("SEASON",
                         "AWAY_TEAM"))
```

```{r load from simulations folder}

# load in ratings
load(here::here("data", "season_team_rankings.Rdata"))
load(here::here("data", "season_team_rankings_type.Rdata"))
load(here::here("data", "weekly_team_rankings.Rdata"))
load(here::here("data", "weekly_team_rankings_type.Rdata"))

# preseason
load(here::here("simulations",
                "preseason",
                params$input_season,
                "preseason_ratings.Rdata"))

load(here::here("simulations",
                "preseason",
                params$input_season,
                "preseason_predictions.Rdata"))


# adjusted and base elo
load(here::here("simulations",
                "preseason",
                params$input_season,
                "adjusted_teams.Rdata"))

load(here::here("simulations", 
                "preseason",
                params$input_season,
                "base_teams.Rdata"))

# simulations
load(here::here("simulations",
                "preseason",
                params$input_season,
                "season_simulations.Rdata"))

load(here::here("simulations", 
                "preseason",
                params$input_season,
                "conference_champ_probs.Rdata"))

```


```{r functions for turning elo to list}

## functions for converting elo to list from specified year
teams_to_list = function(x) {
        
        setNames(unlist(x$ELO) %>%
                         split(., seq(nrow(x))),
                 rownames(x))
}

team_seasons_to_list = function(x) {
        
        setNames(unlist(x$SEASON) %>%
                         split(., seq(nrow(x))),
                 rownames(x))
}

```

```{r set team}

# set
team = params$team

# set pattern
url_pattern <- "http[s]?://(?:[a-zA-Z]|[0-9]|[$-_@.&+]|[!*\\(\\),]|(?:%[0-9a-fA-F][0-9a-fA-F]))+"

# make color function
team_color = team_mapping %>%
                filter(TEAM == team) %>%
                pull(COLOR)

# team logo
team_logos = teams_raw %>%
        filter(TEAM == team) %>%
        select(LOGOS) %>%
        separate(LOGOS, into = c("logo_1", "logo_2"), sep=",") %>%
        mutate(logo_1 = str_extract(logo_1, url_pattern),
               logo_2 = str_extract(logo_2, url_pattern))
        
# define a function based on that team's color
team_col_func =
        function(x) {

                breaks = seq(0, 2, 0.1)
                colorRamp=colorRampPalette(c("white", team_color))
                col_palette <- colorRamp(length(breaks))
                mycut <- cut(x,
                             breaks = breaks,
                             include.lowest = TRUE,
                             right=T,
                             label = FALSE)
                col_palette[mycut]
        }

# team outcome func
team_outcome_func =
        function(x) {

                breaks = c("loss", "win")
                colorRamp=c("white", team_color)
                col_palette <- colorRamp(length(breaks))
                mycut <- cut(x,
                             breaks = breaks,
                             include.lowest = TRUE,
                             right=T,
                             label = FALSE)
                col_palette[mycut]
        }

```

# Season Predictions

How many games will a college football team win in the upcoming season? How likely are they to win their conference championship? 

This notebook displays `r params$input_season` predictions and historical data for `r params$team`.

```{r proejction for teams}

# preseason_ratings %>%
#         arrange(desc(RATING)) %>%
#         mutate(RANK = row_number()) %>%
#         select(SEASON, CONFERENCE, TEAM, RANK, RATING, OFFENSE, DEFENSE, RECRUITING) %>%
#         mutate(RATING = round(RATING, 0),
#                RECRUITING = round(RECRUITING, 0)) %>%
#         mutate(SEASON = factor(SEASON),
#                CONFERENCE = factor(CONFERENCE)) %>%
#         rename(Season = SEASON,
#                Conference = CONFERENCE,
#                Team = TEAM,
#                Rank = RANK,
#                Rating = RATING,
#                Offense = OFFENSE,
#                Defense = DEFENSE,
#                Recruiting = RECRUITING) %>%
#         filter(Team == params$team) %>%
#         flextable() %>%
#         autofit()
#  

library(webshot)
team_preds = preseason_predictions %>%
        arrange(desc(TEAM_ELO)) %>%
        mutate(RANK = row_number()) %>%
        filter(TEAM == params$team) %>%
        mutate(TEAM_ELO = round(TEAM_ELO, 0)) %>%
                mutate(SEASON = factor(SEASON)) %>%
        mutate_at(c("CHAMPION"),
                  ~ replace_na(.,0)) %>%
        select(
                #TEAM,
               SEASON,
               CONFERENCE,
               RANK,
               TEAM_ELO,
               SCHEDULE_RANK,
               win,
               loss,
               BOWL,
               CHAMPION) %>%
       # mutate(record = paste(win, loss, sep='-')) %>%
        rename(Season = SEASON,
             #  Team = TEAM,
               `Preseason Rank` = RANK,
               `Preseason Rating` = TEAM_ELO,
               Conference = CONFERENCE,
               `Schedule Difficulty` = SCHEDULE_RANK,
               `Predicted Wins` = win,
               `Predicted Losses` = loss,
               `Pr(Bowl Game)` = BOWL,
               `Pr(Conf Champ)` = CHAMPION) %>%
        gather() %>%
        mutate(key = str_pad(key, max(nchar(key))+1, pad=" ", side = "right")) %>%
        mutate(value = str_pad(value, max(nchar(value))+1, pad = " ", side = "left"))
     #   mutate(key = paste(key, ":", sep=""))
        #         
        # flextable() %>%
        # autofit() %>%
        # fontsize(., size = 11) %>%
        # flextable:: align(j = "value",
        #                   align = "center",
        #                   part = "all") %>%
        # delete_part(part = "header") %>%
        # as_raster(zoom = 1.5, expand = 1.5)


# team_preds1 = team_preds %>%
# #         filter(key %in% c("Team:", "Season:", "Conference:")) %>%
#         flextable() %>%
#         autofit() %>%
#         fontsize(., size = 11) %>%
#         flextable:: align(j = "value",
#                           align = "center",
#                           part = "all") %>%
#         delete_part(part = "header") %>%
#         as_raster()
# 
# team_preds2 = team_preds %>%
#         filter(!(key %in% c("Team:", "Season:", "Conference:"))) %>%
#         flextable() %>%
#         autofit() %>%
#         fontsize(., size = 11) %>%
#         flextable:: align(j = "value",
#                           align = "center",
#                           part = "all") %>%
#         delete_part(part = "header") %>%
#         as_raster()


        # mutate(key = paste(key, ": ", sep="")) %>%
        # mutate(key = str_pad(key, max(nchar(key))+1, pad=" ", side = "right")) %>%
        # mutate(value = str_pad(value, max(nchar(value))+1, pad = " ", side = "left")) %>%
        # mutate(together = paste(key, value, sep=" ")) %>%
        # pull(together) %>%
        # paste0(., collapse="\n")

```

```{r make score card scorecard, fig.height=3, fig.width=8}

# make text
team_text = c(teams_raw %>%
                          filter(TEAM == params$team) %>%                 
                          mutate(name = paste(TEAM,TEAM_MASCOT)) %>%
                          pull(name))

library(cowplot)
p1 = ggdraw() + draw_image(team_logos$logo_1, 
                           scale = 0.5, 
                           x=-0.1)+
        draw_label(teams_raw %>%
                          filter(TEAM == params$team) %>%                 
                          mutate(name = paste(TEAM,TEAM_MASCOT)) %>%
                          pull(name),
                  hjust = 0.5,
                  fontfamily = 'mono',
                  fontface = 'bold',
                  size = 14,
                  color = muted(team_color),
                  y = 0.1)
                  
# p2 <- ggdraw() + draw_label(team_preds,
#                             color = team_color,
#                             fontfamily = 'mono',
#                          #   fontface = 'bold',
#                             size = 12,
#                             hjust = 0,
#                             x = -0.05)
# 
# p2 = ggplot() + theme_void()+
#         annotation_custom(rasterGrob(team_preds), xmin=-Inf, xmax=Inf, ymin=-Inf, ymax=Inf)

p2 = ggdraw() +
        draw_label(team_preds %>%
                          mutate(together = paste(key, value, sep=" ")) %>%
                          pull(together) %>%
                          paste0(., collapse="\n"),
                  fontfamily = 'mono',
                  fontface = 'bold',
                  hjust = 0.5,
                  color = muted(team_color))

plot_grid(p1, p2,
          nrow=1,
          ncol = 2,
          rel_widths = c(0.8, 1.2),
          rel_heights = c(1, 0.5))

```

## `r params$input_season` Game Predictions

Using each team's starting rating, I simulate the result and margin of victory for each game of the 2022 season 1000 times. 

The following table shows the percentage of times in which `r params$team` won each of the games on their upcoming schedule. The margin of victory is the average margin of victory across all simulations.

```{r team schedule}

# table
season_simulations %$%
        team_outcomes %>%
                filter(TEAM == team) %>%
                mutate(POSTGAME_ELO = round(POSTGAME_ELO,0)) %>%
                left_join(.,
                          games %>%
                                  select(GAME_ID, HOME_TEAM, AWAY_TEAM),
                          by = c("GAME_ID")) %>%
        left_join(., team_mapping %>%
                          rename(OPPONENT = TEAM,
                                 OPPONENT_ABBREVIATION = TEAM_ABBREVIATION),
                  by = c("OPPONENT")) %>%
                mutate(OPPONENT = case_when(OPPONENT == HOME_TEAM ~ paste("@", OPPONENT_ABBREVIATION),
                                                  OPPONENT == AWAY_TEAM ~ paste("vs", OPPONENT_ABBREVIATION))) %>%
                arrange(.id, SEASON, TEAM, GAME_DATE) %>%
                group_by(.id, SEASON, TEAM) %>%
                mutate(GAME = row_number()) %>%
                mutate(win = SIM_MARGIN > 0) %>% 
                group_by(SEASON, GAME_DATE, WEEK, OPPONENT, TEAM) %>% 
                summarize(wins = sum(win), 
                          games = n(),
                          margin = round(median(SIM_MARGIN), 1),
                          .groups = 'drop') %>%
                mutate(perc = round(wins / games, 3)) %>%
                mutate(perc = case_when(perc == 1 ~ (games-1)/100,
                                        perc == 0 ~ (1-games)/100,
                                        TRUE ~ perc)) %>%
                mutate(expected_win = case_when(perc > .5 ~ 'W',
                                                TRUE ~ 'L')) %>%
                select(SEASON, WEEK, GAME_DATE, TEAM, OPPONENT, perc, margin) %>%
                rename(PROB = perc) %>%
                #       PRED = expected_win) %>%
                mutate(SEASON = factor(SEASON)) %>%
                mutate(WEEK = factor(WEEK)) %>%
                arrange(GAME_DATE) %>%
        mutate(GAME_DATE = format(GAME_DATE, format="%b %d")) %>%
                mutate(GAME_DATE = factor(GAME_DATE)) %>%
                rename(Season = SEASON,
                       Week = WEEK,
                       Date = GAME_DATE,
                       Team = TEAM,
                       Opponent = OPPONENT,
                       `Prob.Win` = PROB,
                       `Pred.Margin` = margin) %>%
                #       `Prediction` = PRED) %>%
                flextable() %>%
                flextable::align(., j=c("Season", "Week", "Opponent", "Prob.Win"),
                      align = "center",
                      part = "all") %>%
                bg(., j=c("Prob.Win"),
                   bg = team_col_func) %>%
                color(part = "all",
                      color = "grey20")
```

It's important to note that within each simulation the results of each game are not independent. The the (simulated) results of each week update each team's rating for the following week, which will then influence how likely they are to win in following weeks. This means that a shocking upset early on in a simulation can have ramifications for other teams on the remaining schedule.

The table above indicates the aggregated result of every simulated game for the selected team. The visualization below shows the path of the team's rating in every simulation. This illustrates the most common paths a team's season is likely to take by showing how the result of one matchup tends to affect the trajectory of the rest of the season.

```{r show simulated elo path for team}

source(here::here("functions", "plot_elo_team_season.R"))

plot_elo_team_season(season_simulations %$%
                             team_outcomes,
                     games_raw,
                     params$team,
                     team_color = team_color,
                     params$input_season,
                     alpha = 0.15)

```

# Team Data

The simulations for this upcoming season make use of an (adjusted) Elo rating, which is a rating assigned to each team based on its historical wins and losses. 

## Elo Rating

The following visualizations shows `r params$team`'s Elo rating from 1900 to present.

```{r plot team historicalhistorical}

# dates
#min_date = min(elo_teams$GAME_DATE)[1]
min_date = as.Date(paste("1900-01-01"))
min_year = year(min_date)
#min_year = 1900

smooth = T

all_teams_data = elo_teams %>%
                filter(SEASON > min_year) %>%
                filter(DIVISION == 'fbs') 
        
all_teams_median = all_teams_data %>%
                summarize(median = median(POSTGAME_ELO)) %>%
                pull(median)
        
p = all_teams_data %>%
                ggplot(., aes(x=GAME_DATE,
                              by = TEAM,
                              y= POSTGAME_ELO))+
                geom_point(alpha = 0.005)+
                geom_hline(yintercept = all_teams_median,
                           linetype = 'dashed',
                           color = 'grey60')+
                annotate("text",
                         x = min_date,
                         y=all_teams_median + 40,
                         size = 3,
                         color = 'grey60',
                         label = paste("FBS", "\n", "Median"))
        
team_data = elo_teams %>%
                filter(SEASON > min_year) %>%
                filter(TEAM %in% team) %>%
                mutate(SELECTED_TEAM = TEAM) %>%
                group_by(TEAM) %>%
                mutate(TEAM_LABEL = case_when(GAME_DATE == max(GAME_DATE) ~ TEAM)) %>%
                ungroup()
        
        
if(smooth == T ) {p = p + geom_line(data =team_data,
                          aes(color = TEAM),
                          stat = 'smooth',
                          formula = 'y ~ x',
                          method = 'loess',
                          alpha =0.85,
                          span = 0.15,
                          lwd = 1.04)} else {p = p}
        
        p + 
                geom_text_repel(data = team_data %>%
                                        filter(POSTGAME_ELO == min(POSTGAME_ELO)),
                                aes(label = paste("Lowest Rating:", "\n", GAME_DATE, "vs", OPPONENT),
                                    color =TEAM),
                        fontface = "bold",
                        size = 3,
                  #      direction = "y",
                        # vjust = 
                        # hjust = -1.2,
                      #  segment.size = .7,
                       # segment.alpha = .5,
                        segment.linetype = "dotted",
                        box.padding = .4,
                        segment.curvature = -0.1,
                        segment.ncp = 3,
                        segment.angle = 20
                ) +
                  geom_text_repel(data = team_data %>%
                                        filter(POSTGAME_ELO == max(POSTGAME_ELO)),
                                aes(label = paste("Highest Rating:", "\n", GAME_DATE, "vs", OPPONENT),
                                    color =TEAM),
                        fontface = "bold",
                        size = 3,
                      #  direction = "y",
                        # vjust =
                        # hjust = -1.2,
                      #  segment.size = .7,
                       # segment.alpha = .5,
                        segment.linetype = "dotted",
                        box.padding = .4,
                        segment.curvature = -0.1,
                        segment.ncp = 3,
                        segment.angle = 20
                ) +
                        
                geom_point(data = team_data,
                           aes(color = TEAM),
                           alpha  =0.4)+
                theme_phil()+
                ggtitle(paste("Historical Elo Rating for", paste(team, collapse="-")),
                        subtitle = str_wrap(paste('Displaying Postagme Elo Ratings for all FBS teams from',
                                                  min_year, 'to present. Highlighted points/line indicate selected team.'), 120))+
                theme(plot.title = element_text(hjust = 0.5, size = 16),
                      plot.subtitle =  element_text(hjust = 0.5),
                      strip.text.x = element_text(size = 12))+
                custom_color_teams+
                guides(color = 'none')+
                xlab("Game Date")+
                ylab("Postgame Elo Rating")+
                scale_x_date(breaks = as.Date(paste(seq(min_year, 2020, 10), "01", "01", sep="-")),
                             #date_breaks = c("10 year"),
                             date_labels = c("%Y"))+
                xlab("Season (Game Date)")

```

<!-- ## Best Seasons -->

<!-- `r params$team`'s 10 best teams by end of season Elo rating -->

<!-- ```{r best teams for team based on elo} -->

<!-- elo_teams %>% -->
<!--         left_join(., elo_games %>% -->
<!--                           select(GAME_ID, NEUTRAL_SITE), -->
<!--                   by = c("GAME_ID")) %>% -->
<!--         filter(SEASON >= 1950) %>% -->
<!--         filter(TEAM == team) %>% -->
<!--         group_by(SEASON) %>% -->
<!--         filter(GAME_DATE == max(GAME_DATE)) %>% -->
<!--         ungroup() %>% -->
<!--         rename(ELO = POSTGAME_ELO) %>% -->
<!--         select(SEASON, TEAM, ELO) %>% -->
<!--         mutate_if(is.numeric, round, 2) %>% -->
<!--         arrange(desc(ELO)) %>% -->
<!--         mutate(SEASON = factor(SEASON)) %>% -->
<!--         mutate_if(is.numeric, round, 0) %>% -->
<!--         mutate(Rank = row_number()) %>% -->
<!--         rename(Season = SEASON, -->
<!--                Team = TEAM, -->
<!--                Rating = ELO) %>% -->
<!--         select(Rank, everything()) %>% -->
<!--         head(15) %>% -->
<!--         flextable() %>% -->
<!--         autofit() -->

<!-- ``` -->

<!-- ## Biggest Upsets for `r params$team` -->

<!-- Top 15 games that `r params$team` **won** in which were they were favored to win (since 1950). -->

<!-- ```{r historical upsets games should not have won} -->

<!-- # upset -->
<!-- elo_teams %>% -->
<!--         left_join(., elo_games %>% -->
<!--                           select(GAME_ID, NEUTRAL_SITE), -->
<!--                   by = c("GAME_ID")) %>% -->
<!--         filter(TEAM == team) %>% -->
<!--         filter(SEASON >=1950) %>% -->
<!--         filter(OUTCOME == 'win') %>% -->
<!--         arrange(WIN_PROB) %>% -->
<!--         rename(DATE = GAME_DATE) %>% -->
<!--         mutate(SCORE = paste(POINTS, "-", OPPONENT_POINTS)) %>% -->
<!--         mutate(OPPONENT = case_when(HOME == F ~ paste("@", OPPONENT), -->
<!--                                     HOME == T ~ paste("vs", OPPONENT))) %>% -->
<!--         mutate(RANK = row_number()) %>% -->
<!--         rename(ELO = PREGAME_ELO, -->
<!--                OPPONENT_ELO = OPPONENT_PREGAME_ELO) %>% -->
<!--         mutate(ELO_DIFF = case_when(HOME == T & NEUTRAL_SITE ==F ~ ((75 + ELO) - OPPONENT_ELO), -->
<!--                                     HOME == F & NEUTRAL_SITE == F~ -((OPPONENT_ELO + 75) - ELO), -->
<!--                                     NEUTRAL_SITE==T~ ELO - OPPONENT_ELO)) %>% -->
<!--         mutate(PRED_MARGIN = round(.05 * ELO_DIFF, 1))  %>% -->
<!--                 mutate(OPPONENT_ELO = round(OPPONENT_ELO, 0), -->
<!--                ELO = round(ELO, 0)) %>% -->
<!--         select(RANK, SEASON, WEEK, TEAM, OPPONENT, ELO, OPPONENT_ELO, WIN_PROB, PRED_MARGIN, OUTCOME, SCORE) %>% -->
<!--         mutate(SEASON = factor(SEASON)) %>% -->
<!--         rename(Rank = RANK, -->
<!--                Season = SEASON, -->
<!--                Week = WEEK, -->
<!--                Team = TEAM, -->
<!--                Team.Rating = ELO, -->
<!--                Opponent = OPPONENT, -->
<!--                Opp.Rating = OPPONENT_ELO, -->
<!--                Prob.Win = WIN_PROB, -->
<!--                Pred.Margin = PRED_MARGIN, -->
<!--                Outcome = OUTCOME, -->
<!--                Score = SCORE) %>% -->
<!--         mutate_if(is.numeric, round, 3) %>% -->
<!--         head(15) %>% -->
<!--         flextable() %>% -->
<!--         autofit() %>% -->
<!--         bg(., j= c("Prob.Win"), -->
<!--            bg = team_col_func) %>% -->
<!--         flextable::align(., j=c("Prob.Win", "Outcome", "Score"), -->
<!--                       align = "center", -->
<!--                       part = "all") %>% -->
<!--                 bg(., j=c("Prob.Win"), -->
<!--                    bg = team_col_func) %>% -->
<!--                 color(part = "all", -->
<!--                       color = "grey20") -->

<!-- ``` -->


<!-- ## Biggest Upsets against `r params$team` -->
<!-- Top 15 games that `r params$team` **lost** in which were they were favored to win (since 1950). -->

<!-- ```{r historical upsets} -->

<!-- # upset -->
<!-- elo_teams %>% -->
<!--         left_join(., elo_games %>% -->
<!--                           select(GAME_ID, NEUTRAL_SITE), -->
<!--                   by = c("GAME_ID")) %>% -->
<!--         filter(TEAM == team) %>% -->
<!--                 filter(SEASON >=1950) %>% -->
<!--         filter(OUTCOME == 'loss') %>% -->
<!--         arrange(desc(WIN_PROB)) %>% -->
<!--         rename(DATE = GAME_DATE) %>% -->
<!--         mutate(SCORE = paste(POINTS, "-", OPPONENT_POINTS)) %>% -->
<!--         mutate(OPPONENT = case_when(HOME == F ~ paste("@", OPPONENT), -->
<!--                                     HOME == T ~ paste("vs", OPPONENT))) %>% -->
<!--         mutate(RANK = row_number()) %>% -->
<!--         rename(ELO = PREGAME_ELO, -->
<!--                OPPONENT_ELO = OPPONENT_PREGAME_ELO) %>% -->
<!--         mutate(ELO_DIFF = case_when(HOME == T & NEUTRAL_SITE ==F ~ ((75 + ELO) - OPPONENT_ELO), -->
<!--                                     HOME == F & NEUTRAL_SITE == F~ -((OPPONENT_ELO + 75) - ELO), -->
<!--                                     NEUTRAL_SITE==T~ ELO - OPPONENT_ELO)) %>% -->
<!--         mutate(PRED_MARGIN = round(.05 * ELO_DIFF, 1))  %>% -->
<!--                 mutate(OPPONENT_ELO = round(OPPONENT_ELO, 0), -->
<!--                ELO = round(ELO, 0)) %>% -->
<!--         select(RANK, SEASON, WEEK, TEAM, OPPONENT, ELO, OPPONENT_ELO, WIN_PROB, PRED_MARGIN, OUTCOME, SCORE) %>% -->
<!--         mutate(SEASON = factor(SEASON)) %>% -->
<!--         rename(Rank = RANK, -->
<!--                Season = SEASON, -->
<!--                Week = WEEK, -->
<!--                Team = TEAM, -->
<!--                Team.Rating = ELO, -->
<!--                Opponent = OPPONENT, -->
<!--                Opp.Rating = OPPONENT_ELO, -->
<!--                Prob.Win = WIN_PROB, -->
<!--                Pred.Margin = PRED_MARGIN, -->
<!--                Outcome = OUTCOME, -->
<!--                Score = SCORE) %>% -->
<!--         mutate_if(is.numeric, round, 3) %>% -->
<!--         head(15) %>% -->
<!--         flextable() %>% -->
<!--         autofit() %>% -->
<!--         bg(., j= c("Prob.Win"), -->
<!--            bg = team_col_func) %>% -->
<!--         flextable::align(., j=c("Prob.Win", "Outcome", "Score"), -->
<!--                       align = "center", -->
<!--                       part = "all") %>% -->
<!--                 bg(., j=c("Prob.Win"), -->
<!--                    bg = team_col_func) %>% -->
<!--                 color(part = "all", -->
<!--                       color = "grey20") -->

<!-- ``` -->


## Efficiency

In addition to Elo rating, I also compute and use each team's offensive/defensive expected points metrics from recent seasons in simulating upcoming games. These ratings come from an expected points model I trained on on play by play data in order to identify the value of individual plays within a game. 

I score every play within a game with the model and then aggregate these results to the game and season level and adjust for opponent quality. These results re only available starting from the season of 2007, as this is when reliable play by play data becomes available.


For more details on what goes into creating these ratings, go to my [description of the expected points model](https://phenrickson.github.io/cfb/expected_points_01_model.html) and my [methodology for adjusting for opponent quality](https://phenrickson.github.io/cfb/expected_points_03_adjusted.html).

```{r table form for overall}

## make color func
col_type_func = 
        function(x) {
                
                breaks = c(-1, -0.9, -.75, -.5, -.4, -.35, -.3, -.25, -.2, -.15, -.1, -0.05, -0.025, -0.01, -0.001, 0, 0.001, 0.01, 0.025, 0.05, 0.1, 0.15, 0.2, 0.25, 0.3, 0.35, 0.4, 0.5, 0.75, 0.9, 1)
                
                colorRamp=colorRampPalette(c("red", "white", "deepskyblue1"))
                col_palette <- colorRamp(length(breaks))
                mycut <- cut(x, 
                             breaks = breaks,
                             include.lowest = TRUE, 
                             right=T,
                             label = FALSE)
                col_palette[mycut]
                
        }

# overall
season_team_rankings %>%
        filter(TYPE == 'adjusted') %>%
        filter(TEAM == team) %>% 
        arrange(SEASON) %>%
        select(SEASON, TEAM, OFFENSE, DEFENSE, OVERALL) %>%
        mutate(SEASON = factor(SEASON)) %>%
        flextable() %>%
        autofit() %>%
        bg(., j= c("OFFENSE",
                   "DEFENSE",
                   "OVERALL"),
           bg = col_type_func) %>%
        flextable::align(j = c("OFFENSE",
                               "DEFENSE",
                               "OVERALL"),
                         align = 'center',
                         part = 'all')

```

These efficiency ratings indicate a team's **expected points per play** when its offense or defense is on the field, adjusted for opponent quality. A team's overall rating is a combination of its offense and defense ratings, and indicates the net points per play a team would expect when playing an average opponent. 

For offenses, this indicates the average points the team scores against opponents per play. For defenses, this indicates the average points the team prevents opposing offenses from scoring per play. In both cases, I have set the scale of the variable to mean that positive is good while negative is bad.

The visualization below shows how a team has changed over time as well as their season end efficiency ranking.

```{r efficiency, fig.height=9}

plot_dat = season_team_rankings %>%
        select(-MARGIN) %>%
        filter(TYPE == 'adjusted') %>%
        gather("metric", "value",
               -SEASON, -TEAM, -TYPE) %>%
        left_join(., team_mapping,
                  by = c("TEAM")) %>%
        left_join(., team_conference_season,
                  by = c("TEAM", "SEASON")) %>%
        mutate(SEASON = factor(SEASON)) %>%
        mutate(metric = factor(metric, levels = c("OVERALL", "OFFENSE", "DEFENSE"))) %>%
        group_by(SEASON, TYPE, metric) %>%
        arrange(desc(value)) %>%
        mutate(RANK = row_number()) %>%
        ungroup() %>%
        group_by(metric) %>%
        mutate(min = min(value)) %>%
        ungroup()

all_teams = plot_dat %>%
        ggplot(., aes(x=SEASON,
                      y=value))+
        geom_point(position = position_auto(scale=F,
                                            seed = 1),
                           #position_jitternormal(sd_x= 0.12,
                            #                        sd_y = 0),
            #       fill = 'grey60',
             #      color = 'white',
            color = 'grey60',
            alpha = 0.4)+
        facet_wrap(metric ~.,
                   scales = "free_y",
                   ncol = 1)+
        theme_phil()+
        geom_hline(yintercept =0)+
        guides(color = 'none')+
        ylab("Team Net Predicted Points per Play")

all_teams + 
        geom_point(data = plot_dat %>%
                          filter(TEAM == team),
                  aes(color = TEAM,
                      group = TEAM),
                  lwd = 1.2)+
        geom_line(data = plot_dat %>%
                          filter(TEAM == team),
                  aes(color = TEAM,
                      group = TEAM),
                  lwd = 1.2)+
        geom_text(data = plot_dat %>%
                          filter(TEAM == team),
                  aes(color = TEAM,
                      x = SEASON,
                      label = RANK,
                      y = min),
                  size = 4)+
        custom_color_teams+
        guides(color = 'none')+
        theme(plot.title = element_text(hjust = 0.5,
                                                size = 18),
              axis.text.x = element_text(size = 12),
              plot.subtitle =  element_text(hjust = 0.5),
              strip.text.x = element_text(size = 12,
                                                  hjust = 0.5))+
        ggtitle(paste("College Football Efficiency Metrics by Season - ", team),
                subtitle = str_wrap(paste("Displaying opponent adjusted ratings for all teams based on net points added per play. The background points in grey show the distribution of all teams in a given season. The highlighted line shows ", team, "'s rating by season with their season rank above the year.", sep=""), 140))+
        xlab("")

```

### Efficiency by Play Type

In addition to examinig how a team performs overall, we can examine each team's efficiency based on the play type. How has `r params$team` performed when running/passing on offense vs defending the run/pass on defense?

```{r efficiency by type table}

# by type
season_team_rankings_type %>%
        filter(TEAM == team) %>%
        filter(TYPE == 'adjusted') %>%
        arrange(SEASON) %>%
        mutate(SEASON = factor(SEASON)) %>%
        select(SEASON, TEAM, OFFENSE_PASS, OFFENSE_RUN, DEFENSE_PASS, DEFENSE_RUN) %>%
        flextable() %>%
        autofit() %>%
        bg(., j= c("OFFENSE_RUN", "OFFENSE_PASS",
                   "DEFENSE_RUN", "DEFENSE_PASS"),
           bg = col_type_func) %>%
        flextable::align(j = c("OFFENSE_RUN", "OFFENSE_PASS",
                   "DEFENSE_RUN", "DEFENSE_PASS"),
              align = 'center')

```

The following visualization shows how efficient `r params$team`'s **offense** has been running/passing the ball each season since 2007.

```{r look at offense defense by type, fig.height=8}

plot_dat_type = season_team_rankings_type %>%
        filter(TYPE == 'adjusted') %>%
        gather("metric", "value",
               -SEASON, -TEAM, -TYPE) %>%
        filter(metric %in% c("OFFENSE_PASS", "OFFENSE_RUN","DEFENSE_PASS", "DEFENSE_RUN")) %>%
        separate(metric, into = c("SIDE", "PLAY"), sep="_") %>%
        left_join(., team_mapping,
                  by = c("TEAM")) %>%
        left_join(., team_conference_season,
                  by = c("TEAM", "SEASON")) %>%
        mutate(SEASON = factor(SEASON)) %>%
        mutate(PLAY = factor(PLAY, levels = c("PASS", "RUN")),
               SIDE = factor(SIDE, levels = c("OFFENSE", "DEFENSE"))) %>%
        group_by(SEASON, TYPE, SIDE, PLAY) %>%
        arrange(desc(value)) %>%
        mutate(RANK = row_number()) %>%
        ungroup() %>%
        group_by(TYPE, SIDE, PLAY) %>%
        mutate(min = min(value)) %>%
        ungroup()

all_teams_offense_type = plot_dat_type %>%
        filter(SIDE == 'OFFENSE') %>%
        ggplot(., aes(x=SEASON,
                      y=value))+
        geom_point(position = position_auto(scale=F,
                                            seed = 1),
                           #position_jitternormal(sd_x= 0.12,
                            #                        sd_y = 0),
            #       fill = 'grey60',
             #      color = 'white',
            color = 'grey60',
            alpha = 0.4)+
        facet_wrap(SIDE + PLAY ~.,
                   scales = "free_y",
                   ncol = 1)+
        theme_phil()+
        geom_hline(yintercept =0)+
        guides(color = 'none')+
        ylab("Team Net Predicted Points per Play")

all_teams_offense_type + 
       geom_point(data = plot_dat_type %>%
                          filter(SIDE == 'OFFENSE') %>%
                          filter(TEAM == team),
                  aes(color = TEAM,
                      group = TEAM),
                  lwd = 1.2)+
        geom_line(data = plot_dat_type %>%
                          filter(SIDE == 'OFFENSE') %>%
                          filter(TEAM == team),
                  aes(color = TEAM,
                      group = TEAM),
                  lwd = 1.2)+
        geom_text(data = plot_dat_type %>%
                          filter(SIDE == 'OFFENSE') %>%
                          filter(TEAM == team),
                  aes(color = TEAM,
                      x = SEASON,
                      label = RANK,
                      y = min))+
        custom_color_teams+
        guides(color = 'none')+
        theme(plot.title = element_text(hjust = 0.5,
                                                size = 18),
              axis.text.x = element_text(size = 12),
              plot.subtitle =  element_text(hjust = 0.5),
              strip.text.x = element_text(size = 12,
                                                  hjust = 0.5))+
        ggtitle(paste("College Football Offense Efficiency by Season - ", team),
                subtitle = str_wrap(paste("Displaying opponent adjusted ratings for all teams based on net points added per play. The background points in grey show the distribution of all teams in a given season. The highlighted line shows ", team, "'s rating by season with their season rank above the year.", sep=""), 140))+
        xlab("")
```

The following visualization shows how efficient `r params$team`'s **defense** has been in stopping the opponent's run/pass in each season since 2007.

```{r defense efficiency type, fig.height=8}

plot_dat_type = season_team_rankings_type %>%
        filter(TYPE == 'adjusted') %>%
        gather("metric", "value",
               -SEASON, -TEAM, -TYPE) %>%
        filter(metric %in% c("OFFENSE_PASS", "OFFENSE_RUN","DEFENSE_PASS", "DEFENSE_RUN")) %>%
        separate(metric, into = c("SIDE", "PLAY"), sep="_") %>%
        left_join(., team_mapping,
                  by = c("TEAM")) %>%
        left_join(., team_conference_season,
                  by = c("TEAM", "SEASON")) %>%
        mutate(SEASON = factor(SEASON)) %>%
        mutate(PLAY = factor(PLAY, levels = c("PASS", "RUN")),
               SIDE = factor(SIDE, levels = c("OFFENSE", "DEFENSE"))) %>%
        group_by(SEASON, TYPE, SIDE, PLAY) %>%
        arrange(desc(value)) %>%
        mutate(RANK = row_number()) %>%
        ungroup() %>%
        group_by(TYPE, SIDE, PLAY) %>%
        mutate(min = min(value)) %>%
        ungroup()

all_teams_defense_type = plot_dat_type %>%
        filter(SIDE == 'DEFENSE') %>%
        ggplot(., aes(x=SEASON,
                      y=value))+
        geom_point(position = position_auto(scale=F,
                                            seed = 1),
                           #position_jitternormal(sd_x= 0.12,
                            #                        sd_y = 0),
            #       fill = 'grey60',
             #      color = 'white',
            color = 'grey60',
            alpha = 0.4)+
        facet_wrap(SIDE + PLAY ~.,
                   scales = "free_y",
                   ncol = 1)+
        theme_phil()+
        geom_hline(yintercept =0)+
        guides(color = 'none')+
        ylab("Team Net Predicted Points per Play")

all_teams_defense_type + 
       geom_point(data = plot_dat_type %>%
                          filter(SIDE == 'DEFENSE') %>%
                          filter(TEAM == team),
                  aes(color = TEAM,
                      group = TEAM),
                  lwd = 1.2)+
        geom_line(data = plot_dat_type %>%
                          filter(SIDE == 'DEFENSE') %>%
                          filter(TEAM == team),
                  aes(color = TEAM,
                      group = TEAM),
                  lwd = 1.2)+
        geom_text(data = plot_dat_type %>%
                          filter(SIDE == 'DEFENSE') %>%
                          filter(TEAM == team),
                  aes(color = TEAM,
                      x = SEASON,
                      label = RANK,
                      y = min))+
        custom_color_teams+
        guides(color = 'none')+
        theme(plot.title = element_text(hjust = 0.5,
                                                size = 18),
              axis.text.x = element_text(size = 12),
              plot.subtitle =  element_text(hjust = 0.5),
              strip.text.x = element_text(size = 12,
                                                  hjust = 0.5))+
        ggtitle(paste("College Football Defense Efficiency by Season - ", team),
                subtitle = str_wrap(paste("Displaying opponent adjusted ratings for all teams based on net points added per play. The background points in grey show the distribution of all teams in a given season. The highlighted line shows ", team, "'s rating by season with their season rank above the year.", sep=""), 140))+
        xlab("")

```
