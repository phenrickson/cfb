---
title: "Measuring CFB Team Offense/Defense Efficiency"
author: "Phil Henrickson"
date: "6/7/2022"
output: 
  html_document:
    toc: TRUE #adds a Table of Contents
    theme: cerulean
    number_sections: TRUE #number your headings/sections
    toc_float: TRUE #let your ToC follow you as you scroll
    keep_md: no
    fig.caption: yes
    css: "styles.css"
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = F,
                      error = F,
                      warning=F,
                      dev="png",
                      fig.width = 10,
                      fig.height = 6)

options(knitr.duplicate.label = "allow")

options(scipen=999)

```

```{r connect to snowflake}

library(DBI)
library(odbc)
library(RODBC)
library(keyring)

# connect to snowflake
myconn <- DBI::dbConnect(odbc::odbc(),
                         "SnowflakeDSII",
                         Database = "CFB_DEMO",
                         warehouse = "DEMO_WH",
                         uid="phil.henrickson",
                         pwd=keyring::key_get("AE_Snowflake"))

```

```{r packages, include=F} 

source(here::here("scripts/load_packages.R"))
library(jsonlite)
library(forcats)
conflict_prefer("lag", "dplyr")

library(flextable)
set_flextable_defaults(theme_fun = theme_alafoli,
                       font.color = "grey10",
                       font.size=8,
                       padding.bottom = 6, 
                       padding.top = 6,
                       padding.left = 6,
                       padding.right = 6,
                       background.color = "white")
```

```{r get games}

# get games
games_raw = DBI::dbGetQuery(myconn,
                             paste('SELECT * FROM CFB_DEMO.CFD_RAW.ANALYSIS_GAMES')) %>%
        as_tibble() %>%
        mutate(GAME_DATE = as.Date(START_DATE)) %>%
        arrange(START_DATE)

# teams raw
teams_raw = DBI::dbGetQuery(myconn,
                             paste('SELECT * FROM CFB_DEMO.CFD_RAW.TEAMS')) %>%
        as_tibble() %>%
        rename(TEAM_ID = ID) %>%
        rename(TEAM = SCHOOL)

# get team conference mapping
team_conference_season = DBI::dbGetQuery(myconn,
                             paste('SELECT * FROM CFB_DEMO.CFD_RAW.ANALYSIS_TEAM_CONFERENCE_SEASON')) %>%
        as_tibble()

# make mapping for color
team_mapping = teams_raw %>%
        mutate(TEAM_ABBR = gsub(" ", "\\.", gsub("[[:punct:]]", "\\.", TEAM))) %>%
        select(TEAM, TEAM_ABBR, ABBREVIATION, COLOR, ALT_COLOR) %>%
        mutate(COLOR = case_when(TEAM == 'Toledo' ~ '#003E7E',
                                 TRUE ~ COLOR))

team_colors <- team_mapping %>%
        filter(!is.na(COLOR)) %>%
        pull(COLOR)

names(team_colors) = team_mapping %>%
        filter(!is.na(COLOR)) %>%
        pull(TEAM)

custom_color_teams <- scale_colour_manual(name = "TEAM", values = team_colors)
custom_fill_teams <- scale_fill_manual(name = "TEAM", values = team_colors)

```

```{r load functions}

source(here::here("functions/theme_phil.R"))
source(here::here("functions/clean_plays_func.R"))
source(here::here("functions/make_time_features_func.R"))
source(here::here("functions/expected_points_func.R"))
source(here::here("functions/get_points_added_func.R"))
source(here::here("functions/get_drive_score_events.R"))
source(here::here("functions/assign_play_score_events.R"))
rm(a)

```

```{r query games}

# get game
games_raw = DBI::dbGetQuery(myconn,
                             paste('SELECT * FROM CFB_DEMO.CFD_RAW.ANALYSIS_GAMES')) %>%
        as_tibble() %>%
        mutate(GAME_DATE = as.Date(START_DATE)) %>%
        arrange(START_DATE)
        
```

# Raw Offense and Defense Efficiency

I previously scored play from 2007 to 2021 in terms of expected/predicted points. By starting at the play level, I can then roll up each team's plays at the game or season level to compute their raw offensive/defensive efficiency. Tangibly, this indicates the net points per play for a team over the course of the season while on offense or defense.

```{r load in previously scored}

load(here::here("data/scored_plays.Rdata"))

# get scored plays for regular season
scored_regular = scored_plays %>%
        filter(SEASON > 2006) %>%
       # filter(SEASON_TYPE == 'regular') %>%
        left_join(.,
                  games_raw %>%
                          select(GAME_ID, WEEK, GAME_DATE),
                  by = c("GAME_ID")) %>%
        group_by(SEASON) %>%
        mutate(WEEK = case_when(SEASON_TYPE == 'postseason' ~ max(WEEK) + 1,
               TRUE ~ WEEK)) %>%
        ungroup() %>%
        filter(OFFENSE_DIVISION == 'fbs' & DEFENSE_DIVISION == 'fbs') %>%
        rename(EPA = EP_Added,
               PA = Points_Added) %>%
        mutate(PPA = case_when(is.na(EPA) & !is.na(PA) ~ PA,
                               !is.na(EPA) & is.na(PA) ~ EPA)) %>%
        # set offense defense ids
        mutate(OFFENSE_ID = case_when(OFFENSE_DIVISION == 'fbs' ~ OFFENSE,
                                      TRUE ~ 'fcs')) %>%
        mutate(DEFENSE_ID = case_when(DEFENSE_DIVISION == 'fbs' ~ DEFENSE,
                                      TRUE ~ 'fcs')) %>%
        # get neutral site
        left_join(., games_raw %>%
                          select(GAME_ID, NEUTRAL_SITE) %>%
                          mutate(NEUTRAL_SITE = case_when(NEUTRAL_SITE == T ~ 1,
                                                           TRUE ~ 0)),
                  by = c("GAME_ID")) %>%
        # define home field advantage
        mutate(HOME_FIELD_ADVANTAGE = case_when(NEUTRAL_SITE == 1 ~ 0,
                                                HOME == OFFENSE ~ 1,
                                                HOME == DEFENSE ~ -1)) %>%
        # garbage time
        mutate(HOME_MARGIN = HOME_SCORE - AWAY_SCORE) %>%
        mutate(GARBAGE_TIME = case_when(PERIOD == 2 & abs(HOME_MARGIN) >= 38 ~ 1,
                                        PERIOD ==3 & abs(HOME_MARGIN) > 28 ~ 1,
                                        PERIOD ==4 & abs(HOME_MARGIN) > 22 ~ 1,
                                        TRUE ~ 0)) %>%
        # play type 
        mutate(PLAY_CATEGORY =   case_when(grepl("pass|throw|incomplete|
                                                 incompletion|completion|sack|intercept|reception",
                                        tolower(PLAY_TYPE)) ~ 'PASS',
                                        grepl("run|rush", 
                                              tolower(PLAY_TYPE)) ~ 'RUN',
                                        TRUE ~ 'SPECIAL')) %>%
        select(SEASON, GAME_ID, 
               WEEK, GAME_DATE,
               NEUTRAL_SITE, 
               HOME, AWAY, HOME_SCORE, AWAY_SCORE, HOME_MARGIN,
               OFFENSE, DEFENSE, 
               OFFENSE_ID, DEFENSE_ID,
               OFFENSE_CONFERENCE, DEFENSE_CONFERENCE, 
               OFFENSE_DIVISION, DEFENSE_DIVISION,
               PLAY_TYPE, PLAY_CATEGORY, PLAY_TEXT,
               GARBAGE_TIME,
               HOME_FIELD_ADVANTAGE, 
               PLAY_TEXT, EPA, PPA)

# training set
scored_train = scored_regular %>%
        select(SEASON, GAME_ID,
               GAME_DATE, WEEK, 
               HOME, AWAY,
               OFFENSE_ID, DEFENSE_ID, 
               HOME_FIELD_ADVANTAGE, 
               GARBAGE_TIME,
               PLAY_CATEGORY,
               EPA, PPA) %>%
        # mutate(OFFENSE_ID = factor(OFFENSE_ID),
        #        DEFENSE_ID = factor(DEFENSE_ID)) %>%
        # mutate_at(c("OFFENSE_ID", "DEFENSE_ID"),
        #           ~ relevel(., "fcs")) %>%
        filter(SEASON < 2016)

# validation set
scored_valid = scored_regular %>%
        select(SEASON, GAME_ID,
               GAME_DATE, WEEK, 
               HOME, AWAY,
               OFFENSE_ID, DEFENSE_ID, 
               HOME_FIELD_ADVANTAGE, 
               GARBAGE_TIME,
               PLAY_CATEGORY,
               EPA, PPA) %>%
        # mutate(OFFENSE_ID = factor(OFFENSE_ID),
        #        DEFENSE_ID = factor(DEFENSE_ID)) %>%
        # mutate_at(c("OFFENSE_ID", "DEFENSE_ID"),
        #    ~ relevel(., "fcs")) %>%
        filter(SEASON >= 2016 & SEASON < 2020) 

# test set
scored_test = scored_regular %>%
        select(SEASON, GAME_ID,
               GAME_DATE, WEEK, 
               HOME, AWAY,
               OFFENSE_ID, DEFENSE_ID, 
               HOME_FIELD_ADVANTAGE, 
               GARBAGE_TIME,
               PLAY_CATEGORY,
               EPA, PPA) %>%
        # mutate(OFFENSE_ID = factor(OFFENSE_ID),
        #        DEFENSE_ID = factor(DEFENSE_ID)) %>%
        # mutate_at(c("OFFENSE_ID", "DEFENSE_ID"),
        #    ~ relevel(., "fcs")) %>%
        filter(SEASON >=2020)

```


```{r scored regular, include=F}

p = scored_train %>%
        filter(SEASON > 2006) %>%
        mutate(SEASON = factor(SEASON)) %>%
        ggplot(., aes(x=PPA,
                      y=SEASON)) + 
        stat_density_ridges(alpha = 0.8,
                            quantile_lines = T)

suppressMessages({print(p)})

```

Here are the top 5 teams based on overall efficiency from 2007 to 2015. 

```{r look at raw rankings}

raw_team_rankings = scored_train %>%
        filter(SEASON >=2007 & SEASON <= 2015) %>%
        filter(GARBAGE_TIME == 0) %>%
        group_by(SEASON, OFFENSE_ID) %>%
        summarize(OFFENSE = mean(PPA, na.rm=T),
                  .groups = 'drop') %>%
        mutate(TEAM = gsub(" ", "\\.", gsub("[[:punct:]]", "\\.", OFFENSE_ID))) %>%
        mutate(TYPE = 'raw') %>%
        select(SEASON, TEAM, TYPE, OFFENSE) %>%
        left_join(.,
                  scored_train %>%
                        filter(SEASON >=2007 & SEASON <= 2015) %>%
                          filter(GARBAGE_TIME == 0) %>%
                        group_by(SEASON, DEFENSE_ID) %>%
                        summarize(DEFENSE = mean(PPA, na.rm=T),
                                  .groups = 'drop') %>%
                          mutate(TEAM = gsub(" ", "\\.", gsub("[[:punct:]]", "\\.", DEFENSE_ID))) %>%
                        mutate(TYPE = 'raw') %>%
                        select(SEASON, TEAM, TYPE, DEFENSE) %>%
                          mutate(DEFENSE = -DEFENSE),
                  by = c("SEASON", "TEAM", "TYPE")) %>%
        mutate(OVERALL = OFFENSE + DEFENSE) %>%
        mutate(MARGIN = OVERALL * 65) %>%
        mutate_if(is.numeric, round, 3) %>%
        arrange(desc(MARGIN)) %>%
        rename(TEAM_ABBR = TEAM) %>%
        left_join(., team_mapping,
                  by = c("TEAM_ABBR")) %>%
        select(-TEAM_ABBR) %>%
        mutate(TYPE = 'raw') %>%
        select(SEASON, TEAM, TYPE, OFFENSE, DEFENSE, OVERALL, MARGIN)

# raw rankings
raw_team_rankings %>%
        group_by(SEASON) %>%
        slice_max(., n=5, order_by = OVERALL)  %>%
        mutate(RANK = row_number()) %>%
        mutate(SEASON = factor(SEASON)) %>%
        select(SEASON, RANK, TEAM, OFFENSE, DEFENSE, OVERALL) %>%
        flextable() %>%
        autofit() %>%
        bg(., i = ~ SEASON %in% paste(seq(2008, 2015, 2)),
           bg = 'grey80')

```

Based purely on their on field play, this measure highlights some teams that we would expect (2012 Alabama, 2013 Florida State), but it also rates certain teams very highly that we wouldn't expect (2010 Nevada, 2014 Marsall, 2015 Western Kentucky).

```{r raw offenses, include=F}

raw_team_rankings %>%
        arrange(desc(OFFENSE)) %>%
        head(15) %>%
        mutate(SEASON = factor(SEASON)) %>%
        mutate(RANK = row_number()) %>%
        select(SEASON, RANK, TEAM, OFFENSE, DEFENSE, OVERALL) %>%
        flextable() %>%
        autofit()

```

```{r raw defenses, include=F}

raw_team_rankings %>%
        arrange(desc(DEFENSE)) %>%
        head(15) %>%
        mutate(SEASON = factor(SEASON)) %>%
        mutate(RANK = row_number()) %>%
        select(SEASON, RANK, TEAM, OFFENSE, DEFENSE, OVERALL) %>%
        flextable() %>%
        autofit()

```

Why is that happening? The issue is that these estimates are simply the average predicted points per play for each team over the course of the season. They don't take into account the relative strength of the opposition faced - a 10 yard pass against UMass is considered the same as a 10 yard pass against Ohio State. 

## Alabama and Western Kentucky 

As an example, this means that in 2015, from a raw offense/defense efficiency perspective, Western Kentucky is rated pretty closely to Alabama. This is mainly because Alabama's raw offense is rated lower than Western Kentucky's - a year in which they Alabama went 14-1 and had Derrick Henry win the Heisman with over 2200 yards rushing.

```{r show example}

raw_team_rankings %>%
        filter(SEASON == 2015) %>%
        mutate(SEASON = factor(SEASON)) %>%
        filter(TEAM == 'Alabama' | TEAM == 'Western Kentucky') %>%
        select(SEASON, TEAM, OFFENSE, DEFENSE, OVERALL) %>%
        flextable() %>%
        autofit()

```

Why is Alabama lower? If we look at the overall (raw) strength of the teams they played that season, we can see that Alabama faced much stronger teams than Western Kentucky. 

```{r look at teams played for these two exmaple}

temp = scored_train %>%
        filter(SEASON == 2015) %>%
     #   filter(HOME == 'Alabama' | AWAY == 'Alabama' | HOME == 'Western Kentucky' | AWAY == 'Western Kentucky') %>%
        group_by(SEASON, OFFENSE_ID) %>%
        summarize(OFFENSE = mean(PPA, na.rm=T),
                  .groups = 'drop') %>%
        mutate(TEAM = gsub(" ", "\\.", gsub("[[:punct:]]", "\\.", OFFENSE_ID))) %>%
        mutate(TYPE = 'raw') %>%
        select(SEASON, TEAM, TYPE, OFFENSE) %>%
        left_join(.,
                  scored_train %>%
                          filter(SEASON == 2015) %>%
                                  group_by(SEASON, DEFENSE_ID) %>%
                        summarize(DEFENSE = mean(PPA, na.rm=T),
                                  .groups = 'drop') %>%
                          mutate(TEAM = gsub(" ", "\\.", gsub("[[:punct:]]", "\\.", DEFENSE_ID))) %>%
                        mutate(TYPE = 'raw') %>%
                        select(SEASON, TEAM, TYPE, DEFENSE) %>%
                          mutate(DEFENSE = -DEFENSE),
                  by = c("SEASON", "TEAM", "TYPE")) %>%
        mutate(OVERALL = OFFENSE + DEFENSE) %>%
        mutate(MARGIN = OVERALL * 65) %>%
        mutate_if(is.numeric, round, 3) %>%
        arrange(desc(MARGIN)) %>%
        rename(TEAM_ABBR = TEAM) %>%
        left_join(., team_mapping,
                  by = c("TEAM_ABBR")) %>%
        select(-TEAM_ABBR) %>%
        select(SEASON, TEAM, OFFENSE, DEFENSE, OVERALL, MARGIN) 

temp %>%
        filter(TEAM %in% c(scored_train %>%
                                   filter(SEASON == 2015) %>%
                                   filter(HOME == 'Western Kentucky' | AWAY == 'Western Kentucky')  %>% 
                                   select(HOME, AWAY) %>%
                                   gather() %>% 
                                   distinct(value) %>% 
                                   filter(value != 'Western Kentucky') %>%
                                   pull(value))) %>%
        select(SEASON, TEAM, OVERALL) %>%
        rename(OPPONENT = TEAM) %>%
        mutate(TEAM = 'Western Kentucky') %>%
        select(SEASON, OPPONENT, OVERALL) %>%
        mutate(SEASON = factor(SEASON)) %>%
        flextable() %>%
        autofit() %>%
        set_caption("Western Kentucky's 2015 Opponents")

temp %>%
        filter(TEAM %in% c(scored_train %>%
                                   filter(SEASON == 2015) %>%
                                   filter(HOME == 'Alabama' | AWAY == 'Alabama')  %>% 
                                   select(HOME, AWAY) %>%
                                   gather() %>% 
                                   distinct(value) %>% 
                                   filter(value != 'Alabama') %>%
                                   pull(value))) %>%
        select(SEASON, TEAM, OVERALL) %>%
        rename(OPPONENT = TEAM) %>%
        mutate(TEAM = 'Alabama') %>%
        select(SEASON, OPPONENT, OVERALL) %>%
        mutate(SEASON = factor(SEASON)) %>%
        flextable() %>%
        autofit() %>%
        set_caption("Alabama's 2015 Opponents")

```

Alabama had a *much* tougher schedule than Western Kentucky, and our measures of team offense/defense efficiency should account for that.

# Adjusting for Opponent Strength

How do we adjust team offense/defense efficiency based on the quality of their opponent? 

```{r set up for modeling}

# penalized linear regression
glmnet_reg_mod<- 
        linear_reg(penalty = 0.001,
                   mixture = 0.5) %>%
        set_engine("glmnet")

# lm
lm_reg_mod<- 
        linear_reg() %>%
        set_engine("lm")

# specify grid for tuning
glmnet_grid <- tibble(penalty = 10^seq(-3, -1, 
                                       length.out = 20))

# specify regression metrics
reg_metrics<-metric_set(yardstick::rmse)

# control for resamples
keep_pred <- control_resamples(save_pred = TRUE, 
                               save_workflow = TRUE)

```

This means regressing the predicted points per play on each team as well as home field advantage:

$$PPA  = Offense_i + Defense_j + HomeFieldAdvantage$$

## Recipes

```{r now set up recipe}

adjusted_recipe = recipe(x = scored_train) %>%
        update_role(all_numeric(),
                    all_nominal(),
                    GAME_DATE,
                    new_role = "ID") %>%
        step_filter(GARBAGE_TIME == 0) %>%
        update_role(c("OFFENSE_ID",
                      "DEFENSE_ID",
                      "HOME_FIELD_ADVANTAGE"),
                    new_role = "predictor") %>%
        # step_novel(c("OFFENSE_ID",
        #              "DEFENSE_ID"),
        #            new_level = "new_team") %>%
        step_dummy(c("OFFENSE_ID",
                     "DEFENSE_ID"),
                   one_hot = T)

```

```{r make recipe}

# set epa as the outcome
epa_recipe = adjusted_recipe %>%
        update_role(EPA,
                    new_role = "outcome") %>%
        step_filter(!is.na(EPA)) %>%
        check_missing(all_predictors())

# set ppa as the outcome
ppa_recipe = adjusted_recipe %>%
        update_role(PPA,
                    new_role = "outcome") %>%
        step_filter(!is.na(PPA)) %>%
        check_missing(all_predictors())

```


```{r create workflows}

# workflows
epa_wf = workflow() %>%
        add_recipe(epa_recipe) %>%
        add_model(glmnet_reg_mod)

ppa_wf = workflow() %>%
        add_recipe(ppa_recipe) %>%
        add_model(glmnet_reg_mod)

```

Now fit to each season in the training set.

```{r fit model to a season, include=F}

ppa_fits = scored_train %>%
                filter(SEASON >=2007 & SEASON <= 2015) %>%
        mutate(YEAR = SEASON) %>%
        nest(-YEAR) %>%
        rename(SEASON = YEAR) %>%
        mutate(workflow = map(data,
                              ~ ppa_wf %>%
                                      fit(.x))) %>%
        mutate(augmented = map2(workflow, data,
                           ~ augment(.x, .y))) %>%
        mutate(fit = map(workflow, 
                         ~ extract_fit_parsnip(.x))) %>%
        mutate(coefs = map(fit,
                           ~ tidy(.x))) %>%
        mutate(intercept = map(coefs,
                               ~ .x %>% filter(term == '(Intercept)') %>% pull())) %>%
        mutate(adjusted = map2(coefs, intercept,
                               ~ .x %>% 
                                       filter(term != '(Intercept)' & term != 'HOME_FIELD_ADVANTAGE') %>%
                                       mutate(intercept = .y) %>%
                                       mutate(adjusted = estimate + intercept) %>%
                                       mutate(type = case_when(grepl("OFFENSE", term) ~ 'OFFENSE',
                                                               grepl("DEFENSE", term) ~ 'DEFENSE')) %>%
                                       mutate(TEAM = gsub("DEFENSE_ID_", "", gsub("OFFENSE_ID_", "", term))) %>%
                                       select(TEAM, type, adjusted) %>%
                                       spread(type, adjusted) %>%
                                       mutate(DEFENSE = -DEFENSE) %>%
                                       mutate(OVERALL = OFFENSE + DEFENSE) %>%
                                       mutate(TYPE = 'adjusted')))

```

Now look at the coefficients. Good offenses will have positive coefficients (how much more the team scored on a given play than average).

```{r look at coefs for offense}

ppa_fits %>%
        filter(SEASON == 2013) %>%
        select(SEASON, coefs) %>%
        unnest() %>%
        filter(term == '(Intercept)' | 
                       term == 'HOME_FIELD_ADVANTAGE') %>%
        bind_rows(
                ppa_fits %>%
                        filter(SEASON == 2013) %>%
                        select(SEASON, coefs) %>%
                        unnest() %>%
                        filter(grepl("OFFENSE", term)) %>%
                        arrange(desc(estimate))
        ) %>%
        select(SEASON, term, estimate) %>%
        mutate_if(is.numeric, round, 3) %>%
        head(15) %>%
        mutate(SEASON = factor(SEASON)) %>%
        flextable() %>%
        autofit()

```

Good defenses will have negative coefficients (because they prevented other teams from scoring). For the purpose of evaluating offenses and defenses, I will flip this so positive always means good.

```{r now look at coefficients for defense}

ppa_fits %>%
        filter(SEASON == 2013) %>%
        select(SEASON, coefs) %>%
        unnest() %>%
        filter(term == '(Intercept)' | 
                       term == 'HOME_FIELD_ADVANTAGE') %>%
        bind_rows(
                ppa_fits %>%
                        filter(SEASON == 2013) %>%
                        select(SEASON, coefs) %>%
                        unnest() %>%
                        filter(grepl("DEFENSE", term)) %>%
                        arrange(estimate)
        ) %>%
        select(SEASON, term, estimate) %>%
        mutate_if(is.numeric, round, 3) %>%
        head(15) %>%
        mutate(SEASON = factor(SEASON)) %>%
        flextable() %>%
        autofit()

```

Putting this together (and reversing the sign on defense), we can get adjusted ratings for each team. How do Alabama and Western Kentucky compare for 2015 after adjusting for opponents?

```{r now look}

adjusted_team_rankings = ppa_fits %>%
        filter(SEASON >=2007 & SEASON <= 2015) %>%
        select(SEASON, adjusted) %>%
        unnest(adjusted) %>%
        mutate(TEAM_ABBR = gsub(" ", "\\.", TEAM)) %>%
        select(-TEAM) %>%
        mutate(MARGIN = OVERALL * 65) %>%
        mutate_if(is.numeric, round, 3) %>%
        arrange(desc(MARGIN)) %>%
        left_join(., team_mapping,
                  by = c("TEAM_ABBR")) %>%
        select(-TEAM_ABBR) %>%
        select(SEASON, TEAM, TYPE, OFFENSE, DEFENSE, OVERALL, MARGIN)
        
## pivot and then grab
team_rankings = bind_rows(adjusted_team_rankings,
                          raw_team_rankings) %>%
        pivot_wider(id_cols = c("SEASON", "TEAM"),
                    values_from = c("OFFENSE",
                                    "DEFENSE",
                                    "OVERALL",
                                    "MARGIN"),
                    names_from = c("TYPE")) %>%
        select(SEASON, TEAM, everything())

## look at 
```

Western Kentucky gets penalized due to the quality of the competition they faced - their offense gets an adjustment down while their defense gets a slight improvement. Alabama's offense receives a slight increase based on their opponents, but their defense is the most affected as they played a lot of strong offenses. With the adjustments, Bama moves from the #2 team to the #1, while Western Kentucky falls from #3 to a still respectable #16 - evidently the AP had them at #24 to finish the season, so this feels pretty reasonable.

```{r look at team rankings}

bind_rows(adjusted_team_rankings,
                          raw_team_rankings) %>%
        filter(SEASON == 2015) %>%
        group_by(TYPE, SEASON) %>%
        arrange(desc(OVERALL)) %>%
        mutate(RANK = row_number()) %>%
        filter(TEAM == 'Alabama' | TEAM == 'Western Kentucky') %>%
        arrange(TEAM) %>%
        mutate(SEASON = factor(SEASON)) %>%
        flextable() %>%
        autofit()

# team_rankings %>%
#         filter(SEASON == 2015) %>%
#         filter(TEAM == 'Alabama' | TEAM == 'Western Kentucky') %>%
#         arrange(desc(OVERALL_adjusted)) %>%
#         select(-contains("MARGIN")) %>%
#         mutate(SEASON = factor(SEASON)) %>%
#         flextable() %>%
#         autofit()

```

# Measuring Efficiency by Season

I trained the original expected points model on the years 2007 to 2015, so I can place every team in these seasons based on their offense and defense efficiency. The best teams are in the upper right quadrant, with strong offenses and defenses.

```{r overall, fig.height=9}

team_rankings %>%
        ggplot(., aes(x=OFFENSE_adjusted,
                      color = OVERALL_adjusted,
                      label = TEAM,
                      y=DEFENSE_adjusted))+
        geom_vline(xintercept = 0,
                   alpha = 0.8,
                   linetype = 'dashed')+
        geom_hline(yintercept = 0,
                   alpha = 0.8,
                   linetype = 'dashed')+
        geom_point()+
        geom_text(check_overlap=T,
                  size = 2.5,
                  vjust = -0.75)+
        facet_wrap(SEASON ~.)+
        theme_phil()+
        scale_color_gradient2(low = "red",
                              mid = "grey60",
                              high = "deepskyblue1",
                              limits = c(-0.2, 0.2),
                              oob = scales::squish)+
        theme(legend.title = element_text())+
        guides(color = guide_colorbar(barheight = 0.5,
                                      barwidth = 10,
                                      title = 'Team Net PPA per play',
                                      title.position = 'top'))+
        xlab("Offense PPA (opponent adjusted)")+
        ylab("Defense PPA (opponent adjusted)")

```

We can rank teams according to each of these dimensions and take a look at the overall distributions. Here are the top teams by each metric (overall, offense, defense) in 2012.

```{r look 2012 ratings, fig.height=9}


# overall 
adjusted_team_rankings %>%
        filter(SEASON == 2012) %>%
        gather("metric", "value",
               -SEASON, -TEAM, -TYPE) %>%
        filter(metric == 'OVERALL') %>%
        left_join(., team_mapping,
                  by = c("TEAM")) %>%
        left_join(., team_conference_season,
                  by = c("TEAM", "SEASON")) %>%
        filter(!is.na(CONFERENCE)) %>%
        ggplot(., aes(x = "1",
                      label = ABBREVIATION,
                      fill = TEAM,
                      y = value))+
        # geom_point(position = 'auto',
        #            jitter.width = 0.05)+
        geom_label_repel(position = position_auto(seed = 2,
                                                  jitter.width = 0.5,
                                            scale =T),
                   color = 'white',
                   size = 3,
                   alpha = 0.8)+
        custom_fill_teams+
        guides(fill = 'none')+
        theme_phil()+
        xlab("This axis has no meaning")+
        theme(axis.ticks.x=element_blank(),
              axis.text.x = element_blank())+
        facet_wrap(SEASON + metric ~.)+
  #      facet_wrap(SEASON + CONFERENCE + metric~.)+
        xlab("This axis has no meaning")+
        ylab("Team Net Predicted Points Added per play (opponent adjusted)")+
        geom_hline(yintercept = 0,
                   color = 'grey60')+
        theme(plot.title = element_text(hjust = 0.5,
                                                size = 16),
                      plot.subtitle =  element_text(hjust = 0.5),
                      strip.text.x = element_text(size = 16,
                                                  hjust = 0.5))

# offense
# overall 
adjusted_team_rankings %>%
        filter(SEASON == 2012) %>%
        gather("metric", "value",
               -SEASON, -TEAM, -TYPE) %>%
        filter(metric == 'OFFENSE') %>%
        left_join(., team_mapping,
                  by = c("TEAM")) %>%
        left_join(., team_conference_season,
                  by = c("TEAM", "SEASON")) %>%
        filter(!is.na(CONFERENCE)) %>%
        ggplot(., aes(x = "1",
                      label = ABBREVIATION,
                      fill = TEAM,
                      y = value))+
        # geom_point(position = 'auto',
        #            jitter.width = 0.05)+
        geom_label_repel(position = position_auto(seed = 2,
                                            scale =T),
                   color = 'white',
                   size = 3,
                   alpha = 0.8)+
        custom_fill_teams+
        guides(fill = 'none')+
        theme_phil()+
        xlab("This axis has no meaning")+
        theme(axis.ticks.x=element_blank(),
              axis.text.x = element_blank())+
        facet_wrap(SEASON + metric ~.)+
  #      facet_wrap(SEASON + CONFERENCE + metric~.)+
        xlab("This axis has no meaning")+
        ylab("Team Net Predicted Points Added per play")+
        geom_hline(yintercept = 0,
                   color = 'grey60')+
        theme(plot.title = element_text(hjust = 0.5,
                                                size = 16),
                      plot.subtitle =  element_text(hjust = 0.5),
                      strip.text.x = element_text(size = 16,
                                                  hjust = 0.5))

# defense
adjusted_team_rankings %>%
        filter(SEASON == 2012) %>%
        gather("metric", "value",
               -SEASON, -TEAM, -TYPE) %>%
        filter(metric == 'DEFENSE') %>%
        left_join(., team_mapping,
                  by = c("TEAM")) %>%
        left_join(., team_conference_season,
                  by = c("TEAM", "SEASON")) %>%
        filter(!is.na(CONFERENCE)) %>%
        ggplot(., aes(x = "1",
                      label = ABBREVIATION,
                      fill = TEAM,
                      y = value))+
        # geom_point(position = 'auto',
        #            jitter.width = 0.05)+
        geom_label_repel(position = position_auto(seed = 2,
                                            scale =T),
                   color = 'white',
                   size = 3,
                   alpha = 0.8)+
        custom_fill_teams+
        guides(fill = 'none')+
        theme_phil()+
        xlab("This axis has no meaning")+
        theme(axis.ticks.x=element_blank(),
              axis.text.x = element_blank())+
        facet_wrap(SEASON + metric ~.)+
  #      facet_wrap(SEASON + CONFERENCE + metric~.)+
        xlab("This axis has no meaning")+
        ylab("Team Net Predicted Points Added per play")+
        geom_hline(yintercept = 0,
                   color = 'grey60')+
        theme(plot.title = element_text(hjust = 0.5,
                                                size = 16),
                      plot.subtitle =  element_text(hjust = 0.5),
                      strip.text.x = element_text(size = 16,
                                                  hjust = 0.5))

        
```

## All Years

I trained the original expected points model on 2007-2015, but then I predicted the next four seaasons (then retrained, then predicted the remaining seaons). I'll add all seasons from 2016 to 2021 in here to get season level opponent adjusted metrics for all teams from 07 to 21.

```{r run through 2021}

# remove original
rm(ppa_fits,
   team_rankings,
   adjusted_team_rankings)

ppa_data = bind_rows(scored_train %>%
                filter(SEASON >=2007),
                scored_valid,
                scored_test)

ppa_fits = ppa_data %>%
        mutate(YEAR = SEASON) %>%
        nest(-YEAR) %>%
        rename(SEASON = YEAR) %>%
        mutate(workflow = map(data,
                              ~ ppa_wf %>%
                                      fit(.x))) %>%
        mutate(augmented = map2(workflow, data,
                           ~ augment(.x, .y))) %>%
        mutate(fit = map(workflow, 
                         ~ extract_fit_parsnip(.x))) %>%
        mutate(coefs = map(fit,
                           ~ tidy(.x))) %>%
        mutate(intercept = map(coefs,
                               ~ .x %>% filter(term == '(Intercept)') %>% pull())) %>%
        mutate(adjusted = map2(coefs, intercept,
                               ~ .x %>% 
                                       filter(term != '(Intercept)' & term != 'HOME_FIELD_ADVANTAGE') %>%
                                       mutate(intercept = .y) %>%
                                       mutate(adjusted = estimate + intercept) %>%
                                       mutate(type = case_when(grepl("OFFENSE", term) ~ 'OFFENSE',
                                                               grepl("DEFENSE", term) ~ 'DEFENSE')) %>%
                                       mutate(TEAM = gsub("DEFENSE_ID_", "", gsub("OFFENSE_ID_", "", term))) %>%
                                       select(TEAM, type, adjusted) %>%
                                       spread(type, adjusted) %>%
                                       mutate(DEFENSE = -DEFENSE) %>%
                                       mutate(OVERALL = OFFENSE + DEFENSE) %>%
                                       mutate(TYPE = 'adjusted')))

# get adjusted
adjusted_team_rankings = ppa_fits %>%
        select(SEASON, adjusted) %>%
        unnest(adjusted) %>%
        mutate(TEAM_ABBR = gsub(" ", "\\.", TEAM)) %>%
        select(-TEAM) %>%
        mutate(MARGIN = OVERALL * 65) %>%
        mutate_if(is.numeric, round, 3) %>%
        arrange(desc(OVERALL)) %>%
        left_join(., team_mapping,
                  by = c("TEAM_ABBR")) %>%
        select(-TEAM_ABBR) %>%
        select(SEASON, TEAM, TYPE, OFFENSE, DEFENSE, OVERALL, MARGIN)

```

As before, can look at individual seasons to see where teams stacked up in terms offensive/defensive efficiency at the end of the year.

```{r table with all data}

# color ramps
blueColorRamp = colorRampPalette(c("white", "deepskyblue1"))
blueRedColorRamp = colorRampPalette(c("red", "white", "deepskyblue1"))

# set up color mapping
breaks_df = data.frame(outcome = 'OVERALL',
                       breaks = quantile(adjusted_team_rankings %>% 
                                                 pull(OVERALL), 
                                         probs = seq(0, 1, .01), na.rm=T) %>%
                               as.vector) %>%
        bind_rows(.,
                  data.frame(outcome = 'OFFENSE',
                             breaks = quantile(adjusted_team_rankings %>% 
                                                 pull(OFFENSE), 
                                         probs = seq(0, 1, .01), na.rm=T) %>%
                               as.vector)) %>%
        bind_rows(.,
                  data.frame(outcome = 'DEFENSE',
                             breaks = quantile(adjusted_team_rankings %>% 
                                                 pull(DEFENSE), 
                                         probs = seq(0, 1, .01), na.rm=T) %>%
                               as.vector))
                          
                          
adjusted_team_rankings %>%
        select(-MARGIN) %>%
        mutate(SEASON = factor(SEASON)) %>%
             datatable(escape=F,
                       filter = 'top',
                  options = list(pageLength = 25,
                                 scrollX=F,
                                 autowidth=T,
                                 columnDefs = list(list(className = 'dt-center',
                                                        targets = which(names(adjusted_team_rankings %>% select(-MARGIN))!='TEAM')-1))),
                             #    columnDefs=list(list(width = '30px', targets = c(which(names(prob_table)!='Name')-1)))),
                                                # list(width = '400px', targets = c(which(names(prob_table)=='Name')-1)))),
                                       #  targets = seq(3, ncol(prob_table)-1))),
                  rownames = F) %>%
        formatStyle("OVERALL", backgroundColor = styleInterval(breaks_df %>%
                                                                          filter(outcome == 'OVERALL') %>%
                                                                          pull(breaks),
                                                                  blueRedColorRamp(breaks_df %>%
                                                                          filter(outcome == 'OVERALL') %>%
                                                                          pull(breaks) %>%
                                                                                  length()+1))) %>%
        formatStyle("OFFENSE", backgroundColor = styleInterval(breaks_df %>%
                                                                          filter(outcome == 'OFFENSE') %>%
                                                                          pull(breaks),
                                                                  blueRedColorRamp(breaks_df %>%
                                                                          filter(outcome == 'OFFENSE') %>%
                                                                          pull(breaks) %>%
                                                                                  length()+1))) %>%
                formatStyle("DEFENSE", backgroundColor = styleInterval(breaks_df %>%
                                                                          filter(outcome == 'DEFENSE') %>%
                                                                          pull(breaks),
                                                                  blueRedColorRamp(breaks_df %>%
                                                                          filter(outcome == 'DEFENSE') %>%
                                                                          pull(breaks) %>%
                                                                                  length()+1))) 


```


### 2021

Here is what teams looked like at the end of 2021.

```{r look 2021 ratings}

# overall 
adjusted_team_rankings %>%
        filter(SEASON == 2021) %>%
        gather("metric", "value",
               -SEASON, -TEAM, -TYPE) %>%
        filter(metric == 'OVERALL') %>%
        left_join(., team_mapping,
                  by = c("TEAM")) %>%
        left_join(., team_conference_season,
                  by = c("TEAM", "SEASON")) %>%
        filter(!is.na(CONFERENCE)) %>%
        ggplot(., aes(x = "1",
                      label = ABBREVIATION,
                      fill = TEAM,
                      y = value))+
        # geom_point(position = 'auto',
        #            jitter.width = 0.05)+
        geom_label_repel(position = position_auto(seed = 2,
                                                  jitter.width=0.5,
                                            scale =F),
                   color = 'white',
                   size = 3,
                   alpha = 0.8)+
        custom_fill_teams+
        guides(fill = 'none')+
        theme_phil()+
        xlab("This axis has no meaning")+
        theme(axis.ticks.x=element_blank(),
              axis.text.x = element_blank())+
        facet_wrap(SEASON + metric ~.)+
  #      facet_wrap(SEASON + CONFERENCE + metric~.)+
        xlab("This axis has no meaning")+
        ylab("Team Net Predicted Points Added per play")+
        geom_hline(yintercept = 0,
                   color = 'grey60')+
        theme(plot.title = element_text(hjust = 0.5,
                                                size = 16),
                      plot.subtitle =  element_text(hjust = 0.5),
                      strip.text.x = element_text(size = 16,
                                                  hjust = 0.5))

# offense
# overall 
adjusted_team_rankings %>%
        filter(SEASON == 2021) %>%
        gather("metric", "value",
               -SEASON, -TEAM, -TYPE) %>%
        filter(metric == 'OFFENSE') %>%
        left_join(., team_mapping,
                  by = c("TEAM")) %>%
        left_join(., team_conference_season,
                  by = c("TEAM", "SEASON")) %>%
        filter(!is.na(CONFERENCE)) %>%
        ggplot(., aes(x = "1",
                      label = ABBREVIATION,
                      fill = TEAM,
                      y = value))+
        # geom_point(position = 'auto',
        #            jitter.width = 0.05)+
        geom_label_repel(position = position_auto(seed = 2,
                                                  jitter.width=0.5,
                                            scale =F),
                   color = 'white',
                   size = 3,
                   alpha = 0.8)+
        custom_fill_teams+
        guides(fill = 'none')+
        theme_phil()+
        xlab("This axis has no meaning")+
        theme(axis.ticks.x=element_blank(),
              axis.text.x = element_blank())+
        facet_wrap(SEASON + metric ~.)+
  #      facet_wrap(SEASON + CONFERENCE + metric~.)+
        xlab("This axis has no meaning")+
        ylab("Team Net Predicted Points Added per play")+
        geom_hline(yintercept = 0,
                   color = 'grey60')+
        theme(plot.title = element_text(hjust = 0.5,
                                                size = 16),
                      plot.subtitle =  element_text(hjust = 0.5),
                      strip.text.x = element_text(size = 16,
                                                  hjust = 0.5))

# defense

adjusted_team_rankings %>%
        filter(SEASON == 2021) %>%
        gather("metric", "value",
               -SEASON, -TEAM, -TYPE) %>%
        filter(metric == 'DEFENSE') %>%
        left_join(., team_mapping,
                  by = c("TEAM")) %>%
        left_join(., team_conference_season,
                  by = c("TEAM", "SEASON")) %>%
        filter(!is.na(CONFERENCE)) %>%
        ggplot(., aes(x = "1",
                      label = ABBREVIATION,
                      fill = TEAM,
                      y = value))+
        # geom_point(position = 'auto',
        #            jitter.width = 0.05)+
        geom_label_repel(position = position_auto(seed = 2,
                                                  jitter.width=0.5,
                                            scale =F),
                   color = 'white',
                   size = 3,
                   alpha = 0.8)+
        custom_fill_teams+
        guides(fill = 'none')+
        theme_phil()+
        xlab("This axis has no meaning")+
        theme(axis.ticks.x=element_blank(),
              axis.text.x = element_blank())+
        facet_wrap(SEASON + metric ~.)+
  #      facet_wrap(SEASON + CONFERENCE + metric~.)+
        xlab("This axis has no meaning")+
        ylab("Team Net Predicted Points Added per play")+
        geom_hline(yintercept = 0,
                   color = 'grey60')+
        theme(plot.title = element_text(hjust = 0.5,
                                                size = 16),
                      plot.subtitle =  element_text(hjust = 0.5),
                      strip.text.x = element_text(size = 16,
                                                  hjust = 0.5))
        
```

## Tracking Team Performance

We can look at this to see changes within team overall strength year over year.

### Wisconsin

```{r look at wisconsinoffense defense over time period, fig.height=9}

team = 'Wisconsin'

plot_dat = adjusted_team_rankings %>%
        select(-MARGIN) %>%
        gather("metric", "value",
               -SEASON, -TEAM, -TYPE) %>%
        left_join(., team_mapping,
                  by = c("TEAM")) %>%
        left_join(., team_conference_season,
                  by = c("TEAM", "SEASON")) %>%
        mutate(SEASON = factor(SEASON)) %>%
        mutate(metric = factor(metric, levels = c("OVERALL", "OFFENSE", "DEFENSE"))) %>%
        group_by(SEASON, TYPE, metric) %>%
        arrange(desc(value)) %>%
        mutate(RANK = row_number()) %>%
        ungroup() %>%
        group_by(metric) %>%
        mutate(min = min(value)) %>%
        ungroup()

all_teams = plot_dat %>%
        ggplot(., aes(x=SEASON,
                      y=value))+
        geom_point(position = position_auto(scale=F,
                                            seed = 1),
                           #position_jitternormal(sd_x= 0.12,
                            #                        sd_y = 0),
            #       fill = 'grey60',
             #      color = 'white',
            color = 'grey60',
            alpha = 0.4)+
        facet_wrap(metric ~.,
                   scales = "free",
                   ncol = 1)+
        theme_phil()+
        geom_hline(yintercept =0)+
        guides(color = 'none')+
        ylab("Team Net Predicted Points per Play")

all_teams + 
        geom_point(data = plot_dat %>%
                          filter(TEAM == team),
                  aes(color = TEAM,
                      group = TEAM),
                  lwd = 1.2)+
        geom_line(data = plot_dat %>%
                          filter(TEAM == team),
                  aes(color = TEAM,
                      group = TEAM),
                  lwd = 1.2)+
        geom_text(data = plot_dat %>%
                          filter(TEAM == team),
                  aes(color = TEAM,
                      x = SEASON,
                      label = RANK,
                      y = min))+
        custom_color_teams+
        guides(color = 'none')+
        theme(plot.title = element_text(hjust = 0.5,
                                                size = 18),
              axis.text.x = element_text(size = 12),
              plot.subtitle =  element_text(hjust = 0.5),
              strip.text.x = element_text(size = 12,
                                                  hjust = 0.5))+
        ggtitle(paste("College Football Efficiency Metrics by Season - ", team),
                subtitle = str_wrap(paste("Displaying opponent adjusted ratings for all teams based on net points added per play. The background points in grey show the distribution of all teams in a given season. The highlighted line shows ", team, "'s rating by season with their season rank above the year.", sep=""), 140))+
        xlab("")

```

### Texas A&M

```{r look at tamu offense defense over time period, fig.height=9}

team = 'Texas A&M'

plot_dat = adjusted_team_rankings %>%
                select(-MARGIN) %>%
        gather("metric", "value",
               -SEASON, -TEAM, -TYPE) %>%
        left_join(., team_mapping,
                  by = c("TEAM")) %>%
        left_join(., team_conference_season,
                  by = c("TEAM", "SEASON")) %>%
        mutate(SEASON = factor(SEASON)) %>%
        mutate(metric = factor(metric, levels = c("OVERALL", "OFFENSE", "DEFENSE"))) %>%
        group_by(SEASON, TYPE, metric) %>%
        arrange(desc(value)) %>%
        mutate(RANK = row_number()) %>%
        ungroup() %>%
        group_by(metric) %>%
        mutate(min = min(value)) %>%
        ungroup()

all_teams = plot_dat %>%
        ggplot(., aes(x=SEASON,
                      y=value))+
        geom_point(position = position_auto(scale=F,
                                            seed = 1),
                           #position_jitternormal(sd_x= 0.12,
                            #                        sd_y = 0),
            #       fill = 'grey60',
             #      color = 'white',
            color = 'grey60',
            alpha = 0.4)+
        facet_wrap(metric ~.,
                   scales = "free_y",
                   ncol = 1)+
        theme_phil()+
        geom_hline(yintercept =0)+
        guides(color = 'none')+
        ylab("Team Net Predicted Points per Play")

all_teams + 
        geom_point(data = plot_dat %>%
                          filter(TEAM == team),
                  aes(color = TEAM,
                      group = TEAM),
                  lwd = 1.2)+
        geom_line(data = plot_dat %>%
                          filter(TEAM == team),
                  aes(color = TEAM,
                      group = TEAM),
                  lwd = 1.2)+
        geom_text(data = plot_dat %>%
                          filter(TEAM == team),
                  aes(color = TEAM,
                      x = SEASON,
                      label = RANK,
                      y = min))+
        custom_color_teams+
        guides(color = 'none')+
        theme(plot.title = element_text(hjust = 0.5,
                                                size = 18),
              axis.text.x = element_text(size = 12),
              plot.subtitle =  element_text(hjust = 0.5),
              strip.text.x = element_text(size = 12,
                                                  hjust = 0.5))+
        ggtitle(paste("College Football Efficiency Metrics by Season - ", team),
                subtitle = str_wrap(paste("Displaying opponent adjusted ratings for all teams based on net points added per play. The background points in grey show the distribution of all teams in a given season. The highlighted line shows ", team, "'s rating by season with their season rank above the year.", sep=""), 140))+
        xlab("")

```

### Texas

```{r look at ftexas offense defense over time period}

team = 'Texas'

plot_dat = adjusted_team_rankings %>%
                select(-MARGIN) %>%
        gather("metric", "value",
               -SEASON, -TEAM, -TYPE) %>%
        left_join(., team_mapping,
                  by = c("TEAM")) %>%
        left_join(., team_conference_season,
                  by = c("TEAM", "SEASON")) %>%
        mutate(SEASON = factor(SEASON)) %>%
        mutate(metric = factor(metric, levels = c("OVERALL", "OFFENSE", "DEFENSE"))) %>%
        group_by(SEASON, TYPE, metric) %>%
        arrange(desc(value)) %>%
        mutate(RANK = row_number()) %>%
        ungroup() %>%
        group_by(metric) %>%
        mutate(min = min(value)) %>%
        ungroup()

all_teams = plot_dat %>%
        ggplot(., aes(x=SEASON,
                      y=value))+
        geom_point(position = position_auto(scale=F,
                                            seed = 1),
                           #position_jitternormal(sd_x= 0.12,
                            #                        sd_y = 0),
            #       fill = 'grey60',
             #      color = 'white',
            color = 'grey60',
            alpha = 0.4)+
        facet_wrap(metric ~.,
                   scales = "free_y",
                   ncol = 1)+
        theme_phil()+
        geom_hline(yintercept =0)+
        guides(color = 'none')+
        ylab("Team Net Predicted Points per Play")

all_teams + 
        geom_point(data = plot_dat %>%
                          filter(TEAM == team),
                  aes(color = TEAM,
                      group = TEAM),
                  lwd = 1.2)+
        geom_line(data = plot_dat %>%
                          filter(TEAM == team),
                  aes(color = TEAM,
                      group = TEAM),
                  lwd = 1.2)+
        geom_text(data = plot_dat %>%
                          filter(TEAM == team),
                  aes(color = TEAM,
                      x = SEASON,
                      label = RANK,
                      y = min))+
        custom_color_teams+
        guides(color = 'none')+
        theme(plot.title = element_text(hjust = 0.5,
                                                size = 18),
              axis.text.x = element_text(size = 12),
              plot.subtitle =  element_text(hjust = 0.5),
              strip.text.x = element_text(size = 12,
                                                  hjust = 0.5))+
        ggtitle(paste("College Football Efficiency Metrics by Season - ", team),
                subtitle = str_wrap(paste("Displaying opponent adjusted ratings for all teams based on net points added per play. The background points in grey show the distribution of all teams in a given season. The highlighted line shows ", team, "'s rating by season with their season rank above the year.", sep=""), 140))+
        xlab("")
```

### Alabama

If we look at Alabama, we should see them basically be near the top this whole damn era.

```{r look at bama offense defense over time period}

team = 'Alabama'

plot_dat = adjusted_team_rankings %>%
                select(-MARGIN) %>%
        gather("metric", "value",
               -SEASON, -TEAM, -TYPE) %>%
        left_join(., team_mapping,
                  by = c("TEAM")) %>%
        left_join(., team_conference_season,
                  by = c("TEAM", "SEASON")) %>%
        mutate(SEASON = factor(SEASON)) %>%
        mutate(metric = factor(metric, levels = c("OVERALL", "OFFENSE", "DEFENSE"))) %>%
        group_by(SEASON, TYPE, metric) %>%
        arrange(desc(value)) %>%
        mutate(RANK = row_number()) %>%
        ungroup() %>%
        group_by(metric) %>%
        mutate(min = min(value)) %>%
        ungroup()

all_teams = plot_dat %>%
        ggplot(., aes(x=SEASON,
                      y=value))+
        geom_point(position = position_auto(scale=F,
                                            seed = 1),
                           #position_jitternormal(sd_x= 0.12,
                            #                        sd_y = 0),
            #       fill = 'grey60',
             #      color = 'white',
            color = 'grey60',
            alpha = 0.4)+
        facet_wrap(metric ~.,
                   scales = "free_y",
                   ncol = 1)+
        theme_phil()+
        geom_hline(yintercept =0)+
        guides(color = 'none')+
        ylab("Team Net Predicted Points per Play")

all_teams + 
        geom_point(data = plot_dat %>%
                          filter(TEAM == team),
                  aes(color = TEAM,
                      group = TEAM),
                  lwd = 1.2)+
        geom_line(data = plot_dat %>%
                          filter(TEAM == team),
                  aes(color = TEAM,
                      group = TEAM),
                  lwd = 1.2)+
        geom_text(data = plot_dat %>%
                          filter(TEAM == team),
                  aes(color = TEAM,
                      x = SEASON,
                      label = RANK,
                      y = min))+
        custom_color_teams+
        guides(color = 'none')+
        theme(plot.title = element_text(hjust = 0.5,
                                                size = 18),
              axis.text.x = element_text(size = 12),
              plot.subtitle =  element_text(hjust = 0.5),
              strip.text.x = element_text(size = 12,
                                                  hjust = 0.5))+
        ggtitle(paste("College Football Efficiency Metrics by Season - ", team),
                subtitle = str_wrap(paste("Displaying opponent adjusted ratings for all teams based on net points added per play. The background points in grey show the distribution of all teams in a given season. The highlighted line shows ", team, "'s rating by season with their season rank above the year.", sep=""), 140))+
        xlab("")

```

### Georgia

Georgia should take off in the last few years.

```{r look at georgia offense defense over time period}

team = 'Georgia'

plot_dat = adjusted_team_rankings %>%
                select(-MARGIN) %>%
        gather("metric", "value",
               -SEASON, -TEAM, -TYPE) %>%
        left_join(., team_mapping,
                  by = c("TEAM")) %>%
        left_join(., team_conference_season,
                  by = c("TEAM", "SEASON")) %>%
        mutate(SEASON = factor(SEASON)) %>%
        mutate(metric = factor(metric, levels = c("OVERALL", "OFFENSE", "DEFENSE"))) %>%
        group_by(SEASON, TYPE, metric) %>%
        arrange(desc(value)) %>%
        mutate(RANK = row_number()) %>%
        ungroup() %>%
        group_by(metric) %>%
        mutate(min = min(value)) %>%
        ungroup()

all_teams = plot_dat %>%
        ggplot(., aes(x=SEASON,
                      y=value))+
        geom_point(position = position_auto(scale=F,
                                            seed = 1),
                           #position_jitternormal(sd_x= 0.12,
                            #                        sd_y = 0),
            #       fill = 'grey60',
             #      color = 'white',
            color = 'grey60',
            alpha = 0.4)+
        facet_wrap(metric ~.,
                   scales = "free_y",
                   ncol = 1)+
        theme_phil()+
        geom_hline(yintercept =0)+
        guides(color = 'none')+
        ylab("Team Net Predicted Points per Play")

all_teams + 
        geom_point(data = plot_dat %>%
                          filter(TEAM == team),
                  aes(color = TEAM,
                      group = TEAM),
                  lwd = 1.2)+
        geom_line(data = plot_dat %>%
                          filter(TEAM == team),
                  aes(color = TEAM,
                      group = TEAM),
                  lwd = 1.2)+
        geom_text(data = plot_dat %>%
                          filter(TEAM == team),
                  aes(color = TEAM,
                      x = SEASON,
                      label = RANK,
                      y = min))+
        custom_color_teams+
        guides(color = 'none')+
        theme(plot.title = element_text(hjust = 0.5,
                                                size = 18),
              axis.text.x = element_text(size = 12),
              plot.subtitle =  element_text(hjust = 0.5),
              strip.text.x = element_text(size = 12,
                                                  hjust = 0.5))+
        ggtitle(paste("College Football Efficiency Metrics by Season - ", team),
                subtitle = str_wrap(paste("Displaying opponent adjusted ratings for all teams based on net points added per play. The background points in grey show the distribution of all teams in a given season. The highlighted line shows ", team, "'s rating by season with their season rank above the year.", sep=""), 140))+
        xlab("")

```

### Baylor

```{r look at baylor offense defense over time period}

team = 'Baylor'

plot_dat = adjusted_team_rankings %>%
                select(-MARGIN) %>%
        gather("metric", "value",
               -SEASON, -TEAM, -TYPE) %>%
        left_join(., team_mapping,
                  by = c("TEAM")) %>%
        left_join(., team_conference_season,
                  by = c("TEAM", "SEASON")) %>%
        mutate(SEASON = factor(SEASON)) %>%
        mutate(metric = factor(metric, levels = c("OVERALL", "OFFENSE", "DEFENSE"))) %>%
        group_by(SEASON, TYPE, metric) %>%
        arrange(desc(value)) %>%
        mutate(RANK = row_number()) %>%
        ungroup() %>%
        group_by(metric) %>%
        mutate(min = min(value)) %>%
        ungroup()

all_teams = plot_dat %>%
        ggplot(., aes(x=SEASON,
                      y=value))+
        geom_point(position = position_auto(scale=F,
                                            seed = 1),
                           #position_jitternormal(sd_x= 0.12,
                            #                        sd_y = 0),
            #       fill = 'grey60',
             #      color = 'white',
            color = 'grey60',
            alpha = 0.4)+
        facet_wrap(metric ~.,
                   scales = "free_y",
                   ncol = 1)+
        theme_phil()+
        geom_hline(yintercept =0)+
        guides(color = 'none')+
        ylab("Team Net Predicted Points per Play")

all_teams + 
        geom_point(data = plot_dat %>%
                          filter(TEAM == team),
                  aes(color = TEAM,
                      group = TEAM),
                  lwd = 1.2)+
        geom_line(data = plot_dat %>%
                          filter(TEAM == team),
                  aes(color = TEAM,
                      group = TEAM),
                  lwd = 1.2)+
        geom_text(data = plot_dat %>%
                          filter(TEAM == team),
                  aes(color = TEAM,
                      x = SEASON,
                      label = RANK,
                      y = min))+
        custom_color_teams+
        guides(color = 'none')+
        theme(plot.title = element_text(hjust = 0.5,
                                                size = 18),
              axis.text.x = element_text(size = 12),
              plot.subtitle =  element_text(hjust = 0.5),
              strip.text.x = element_text(size = 12,
                                                  hjust = 0.5))+
        ggtitle(paste("College Football Efficiency Metrics by Season - ", team),
                subtitle = str_wrap(paste("Displaying opponent adjusted ratings for all teams based on net points added per play. The background points in grey show the distribution of all teams in a given season. The highlighted line shows ", team, "'s rating by season with their season rank above the year.", sep=""), 140))+
        xlab("")

```

### Florida State

```{r look at florida state offense defense over time period}

team = 'Florida State'

plot_dat = adjusted_team_rankings %>%
                select(-MARGIN) %>%
        gather("metric", "value",
               -SEASON, -TEAM, -TYPE) %>%
        left_join(., team_mapping,
                  by = c("TEAM")) %>%
        left_join(., team_conference_season,
                  by = c("TEAM", "SEASON")) %>%
        mutate(SEASON = factor(SEASON)) %>%
        mutate(metric = factor(metric, levels = c("OVERALL", "OFFENSE", "DEFENSE"))) %>%
        group_by(SEASON, TYPE, metric) %>%
        arrange(desc(value)) %>%
        mutate(RANK = row_number()) %>%
        ungroup() %>%
        group_by(metric) %>%
        mutate(min = min(value)) %>%
        ungroup()

all_teams = plot_dat %>%
        ggplot(., aes(x=SEASON,
                      y=value))+
        geom_point(position = position_auto(scale=F,
                                            seed = 1),
                           #position_jitternormal(sd_x= 0.12,
                            #                        sd_y = 0),
            #       fill = 'grey60',
             #      color = 'white',
            color = 'grey60',
            alpha = 0.4)+
        facet_wrap(metric ~.,
                   scales = "free_y",
                   ncol = 1)+
        theme_phil()+
        geom_hline(yintercept =0)+
        guides(color = 'none')+
        ylab("Team Net Predicted Points per Play")

all_teams + 
        geom_point(data = plot_dat %>%
                          filter(TEAM == team),
                  aes(color = TEAM,
                      group = TEAM),
                  lwd = 1.2)+
        geom_line(data = plot_dat %>%
                          filter(TEAM == team),
                  aes(color = TEAM,
                      group = TEAM),
                  lwd = 1.2)+
        geom_text(data = plot_dat %>%
                          filter(TEAM == team),
                  aes(color = TEAM,
                      x = SEASON,
                      label = RANK,
                      y = min))+
        custom_color_teams+
        guides(color = 'none')+
        theme(plot.title = element_text(hjust = 0.5,
                                                size = 18),
              axis.text.x = element_text(size = 12),
              plot.subtitle =  element_text(hjust = 0.5),
              strip.text.x = element_text(size = 12,
                                                  hjust = 0.5))+
        ggtitle(paste("College Football Efficiency Metrics by Season - ", team),
                subtitle = str_wrap(paste("Displaying opponent adjusted ratings for all teams based on net points added per play. The background points in grey show the distribution of all teams in a given season. The highlighted line shows ", team, "'s rating by season with their season rank above the year.", sep=""), 140))+
        xlab("")

```

### Auburn

```{r look at auburn offense defense over time period}

team = 'Auburn'

plot_dat = adjusted_team_rankings %>%
                select(-MARGIN) %>%
        gather("metric", "value",
               -SEASON, -TEAM, -TYPE) %>%
        left_join(., team_mapping,
                  by = c("TEAM")) %>%
        left_join(., team_conference_season,
                  by = c("TEAM", "SEASON")) %>%
        mutate(SEASON = factor(SEASON)) %>%
        mutate(metric = factor(metric, levels = c("OVERALL", "OFFENSE", "DEFENSE"))) %>%
        group_by(SEASON, TYPE, metric) %>%
        arrange(desc(value)) %>%
        mutate(RANK = row_number()) %>%
        ungroup() %>%
        group_by(metric) %>%
        mutate(min = min(value)) %>%
        ungroup()

all_teams = plot_dat %>%
        ggplot(., aes(x=SEASON,
                      y=value))+
        geom_point(position = position_auto(scale=F,
                                            seed = 1),
                           #position_jitternormal(sd_x= 0.12,
                            #                        sd_y = 0),
            #       fill = 'grey60',
             #      color = 'white',
            color = 'grey60',
            alpha = 0.4)+
        facet_wrap(metric ~.,
                   scales = "free_y",
                   ncol = 1)+
        theme_phil()+
        geom_hline(yintercept =0)+
        guides(color = 'none')+
        ylab("Team Net Predicted Points per Play")

all_teams + 
        geom_point(data = plot_dat %>%
                          filter(TEAM == team),
                  aes(color = TEAM,
                      group = TEAM),
                  lwd = 1.2)+
        geom_line(data = plot_dat %>%
                          filter(TEAM == team),
                  aes(color = TEAM,
                      group = TEAM),
                  lwd = 1.2)+
        geom_text(data = plot_dat %>%
                          filter(TEAM == team),
                  aes(color = TEAM,
                      x = SEASON,
                      label = RANK,
                      y = min))+
        custom_color_teams+
        guides(color = 'none')+
        theme(plot.title = element_text(hjust = 0.5,
                                                size = 18),
              axis.text.x = element_text(size = 12),
              plot.subtitle =  element_text(hjust = 0.5),
              strip.text.x = element_text(size = 12,
                                                  hjust = 0.5))+
        ggtitle(paste("College Football Efficiency Metrics by Season - ", team),
                subtitle = str_wrap(paste("Displaying opponent adjusted ratings for all teams based on net points added per play. The background points in grey show the distribution of all teams in a given season. The highlighted line shows ", team, "'s rating by season with their season rank above the year.", sep=""), 140))+
        xlab("")

```

### Arkansas

```{r look at arkansas offense defense over time period}

team = 'Arkansas'

plot_dat = adjusted_team_rankings %>%
                select(-MARGIN) %>%
        gather("metric", "value",
               -SEASON, -TEAM, -TYPE) %>%
        left_join(., team_mapping,
                  by = c("TEAM")) %>%
        left_join(., team_conference_season,
                  by = c("TEAM", "SEASON")) %>%
        mutate(SEASON = factor(SEASON)) %>%
        mutate(metric = factor(metric, levels = c("OVERALL", "OFFENSE", "DEFENSE"))) %>%
        group_by(SEASON, TYPE, metric) %>%
        arrange(desc(value)) %>%
        mutate(RANK = row_number()) %>%
        ungroup() %>%
        group_by(metric) %>%
        mutate(min = min(value)) %>%
        ungroup()

all_teams = plot_dat %>%
        ggplot(., aes(x=SEASON,
                      y=value))+
        geom_point(position = position_auto(scale=F,
                                            seed = 1),
                           #position_jitternormal(sd_x= 0.12,
                            #                        sd_y = 0),
            #       fill = 'grey60',
             #      color = 'white',
            color = 'grey60',
            alpha = 0.4)+
        facet_wrap(metric ~.,
                   scales = "free_y",
                   ncol = 1)+
        theme_phil()+
        geom_hline(yintercept =0)+
        guides(color = 'none')+
        ylab("Team Net Predicted Points per Play")

all_teams + 
        geom_point(data = plot_dat %>%
                          filter(TEAM == team),
                  aes(color = TEAM,
                      group = TEAM),
                  lwd = 1.2)+
        geom_line(data = plot_dat %>%
                          filter(TEAM == team),
                  aes(color = TEAM,
                      group = TEAM),
                  lwd = 1.2)+
        geom_text(data = plot_dat %>%
                          filter(TEAM == team),
                  aes(color = TEAM,
                      x = SEASON,
                      label = RANK,
                      y = min))+
        custom_color_teams+
        guides(color = 'none')+
        theme(plot.title = element_text(hjust = 0.5,
                                                size = 18),
              axis.text.x = element_text(size = 12),
              plot.subtitle =  element_text(hjust = 0.5),
              strip.text.x = element_text(size = 12,
                                                  hjust = 0.5))+
        ggtitle(paste("College Football Efficiency Metrics by Season - ", team),
                subtitle = str_wrap(paste("Displaying opponent adjusted ratings for all teams based on net points added per play. The background points in grey show the distribution of all teams in a given season. The highlighted line shows ", team, "'s rating by season with their season rank above the year.", sep=""), 140))+
        xlab("")

```

### Conferences

What about each conference? I'll look at each team's rankings in their conference over this time period, filtering to the P5 conferences.

```{r conferecnes, fig.height=8}

int_breaks <- function(x, n = 10) {
  l <- pretty(x, n)
  l[abs(l %% 1) < .Machine$double.eps ^ 0.5] 
}

plot_dat = adjusted_team_rankings %>%
        arrange(SEASON) %>%
        left_join(., team_conference_season,
                  by = c("SEASON", "TEAM")) %>%
        left_join(., team_mapping,
                  by = c("TEAM")) %>%
        filter(!is.na(TEAM)) %>%
        mutate(CONFERENCE = case_when(CONFERENCE == 'Pac-10' | CONFERENCE == 'Pac-12' ~ 'Pac-10/Pac-12',
                                      TRUE ~ CONFERENCE)) %>%
        group_by(SEASON, CONFERENCE)  %>%
        arrange(desc(OVERALL)) %>%
        mutate(RANK = row_number()) %>%
        ungroup() %>%
        filter(CONFERENCE %in% c('ACC', 'SEC', 'Big 12', 'Big Ten', 'Pac-10/Pac-12')) %>%
        group_by(TEAM, CONFERENCE) %>%
        mutate(TEAM_LABEL = case_when(SEASON == max(SEASON) ~ TEAM)) %>%
        ungroup()

max_rank = max(plot_dat$RANK)

plot_dat %>%
        ggplot(., aes(x=SEASON,
                      label = ABBREVIATION,
                      fill = TEAM,
                      y=RANK,
                      )) +
        geom_tile(color = 'white',
                  lwd = 1.02)+
        geom_text(color = 'white',
                  size = 2)+
        custom_fill_teams+
        guides(fill = "none")+
        theme_phil()+
        facet_wrap(CONFERENCE ~.)+
        theme(panel.grid.major = element_blank())+
        xlab("Season")+
        ylab("Confernce Ranking by Team Efficiency")+
      #  coord_cartesian(ylim = c(0.5, 15))+
        scale_y_reverse(breaks = seq(1, max_rank, 1))+
        scale_x_continuous(breaks = int_breaks) +
        theme(plot.title = element_text(hjust = 0.5,
                                                size = 18),
              plot.subtitle =  element_text(hjust = 0.5),
              strip.text.x = element_text(size = 12,
                                                  hjust = 0.5))+
        ggtitle("Ranking Conference Members by Team Overall Efficiency, 2007-2021")

 
```

### Top 25s

```{r plot top 25s by end of seasonover time, warning=F}

int_breaks <- function(x, n = 10) {
  l <- pretty(x, n)
  l[abs(l %% 1) < .Machine$double.eps ^ 0.5] 
}

plot_dat = adjusted_team_rankings %>%
        arrange(SEASON) %>%
        left_join(., team_conference_season,
                  by = c("SEASON", "TEAM")) %>%
        left_join(., team_mapping,
                  by = c("TEAM")) %>%
        filter(!is.na(TEAM)) %>%
        group_by(SEASON)  %>%
        arrange(desc(OVERALL)) %>%
        mutate(RANK = row_number()) %>%
        ungroup() %>%
        filter(RANK <=25) %>%
        group_by(TEAM, CONFERENCE) %>%
        mutate(TEAM_LABEL = case_when(SEASON == max(SEASON) ~ TEAM)) %>%
        ungroup()

max_rank = max(plot_dat$RANK)

plot_dat %>%
        ggplot(., aes(x=SEASON,
                      label = ABBREVIATION,
                      fill = TEAM,
                      y=RANK,
                      )) +
        geom_tile(color = 'white',
                  lwd = 1.06)+
        geom_text(color = 'white',
                  size = 4)+
        custom_fill_teams+
        guides(fill = "none")+
        theme_phil()+
        theme(panel.grid.major = element_blank())+
        xlab("Season")+
        ylab("Ranking by Team Efficiency")+
      #  coord_cartesian(ylim = c(0.5, 15))+
        scale_y_reverse(breaks = seq(1, max_rank, 1))+
        scale_x_continuous(breaks = int_breaks) +
        theme(plot.title = element_text(hjust = 0.5,
                                                size = 18),
              plot.subtitle =  element_text(hjust = 0.5),
              strip.text.x = element_text(size = 12,
                                                  hjust = 0.5))+
        ggtitle("Top 25 Teams by Team Overall Efficiency, 2007-2021")

```

```{r rm from section 1}

rm(temp,
   raw_team_rankings,
   plot_dat,
   p,
   adjusted_recipe,
   max_rank)

```




```{r get ratings}

raw_team_rankings = bind_rows(scored_train,
          scored_valid,
          scored_test) %>%
        filter(GARBAGE_TIME == 0) %>%
        group_by(SEASON, OFFENSE_ID) %>%
        summarize(OFFENSE = mean(PPA, na.rm=T),
                  .groups = 'drop') %>%
        mutate(TEAM = gsub(" ", "\\.", gsub("[[:punct:]]", "\\.", OFFENSE_ID))) %>%
        mutate(TYPE = 'raw') %>%
        select(SEASON, TEAM, TYPE, OFFENSE) %>%
        left_join(.,
                  bind_rows(scored_train,
                            scored_valid,
                            scored_test) %>%
                          filter(GARBAGE_TIME == 0) %>%
                        group_by(SEASON, DEFENSE_ID) %>%
                        summarize(DEFENSE = mean(PPA, na.rm=T),
                                  .groups = 'drop') %>%
                          mutate(TEAM = gsub(" ", "\\.", gsub("[[:punct:]]", "\\.", DEFENSE_ID))) %>%
                        mutate(TYPE = 'raw') %>%
                        select(SEASON, TEAM, TYPE, DEFENSE) %>%
                          mutate(DEFENSE = -DEFENSE),
                  by = c("SEASON", "TEAM", "TYPE")) %>%
        mutate(OVERALL = OFFENSE + DEFENSE) %>%
        mutate(MARGIN = OVERALL * 65) %>%
        mutate_if(is.numeric, round, 3) %>%
        arrange(desc(MARGIN)) %>%
        rename(TEAM_ABBR = TEAM) %>%
        left_join(., team_mapping,
                  by = c("TEAM_ABBR")) %>%
        select(-TEAM_ABBR) %>%
        mutate(TYPE = 'raw') %>%
        select(SEASON, TEAM, TYPE, OFFENSE, DEFENSE, OVERALL, MARGIN)


season_team_rankings = bind_rows(adjusted_team_rankings,
          raw_team_rankings) 

save(season_team_rankings,
     file = here::here("data", "season_team_rankings.Rdata"))

```


## Passing and Rushing Efficiency

In addition to looking at a team's overall offense/defense, we can also break plays down by passing/rushing/special teams.

```{r save end of season ratings}

raw_team_rankings_type = bind_rows(scored_train,
          scored_valid,
          scored_test) %>%
        filter(GARBAGE_TIME == 0) %>%
        filter(PLAY_CATEGORY != 'SPECIAL') %>%
        group_by(SEASON, PLAY_CATEGORY, OFFENSE_ID) %>%
        summarize(OFFENSE = mean(PPA, na.rm=T),
                  PLAYS_OFFENSE = n(),
                  .groups = 'drop') %>%
        mutate(TEAM = gsub(" ", "\\.", gsub("[[:punct:]]", "\\.", OFFENSE_ID))) %>%
        mutate(TYPE = 'raw') %>%
        select(SEASON, TEAM, PLAY_CATEGORY, PLAYS_OFFENSE, OFFENSE) %>%
        left_join(.,
                  bind_rows(scored_train,
                            scored_valid,
                            scored_test) %>%
                          filter(GARBAGE_TIME == 0) %>%
                        group_by(SEASON, PLAY_CATEGORY, DEFENSE_ID) %>%
                        summarize(DEFENSE = mean(PPA, na.rm=T),
                                  PLAYS_DEFENSE = n(),
                                  .groups = 'drop') %>%
                          mutate(TEAM = gsub(" ", "\\.", gsub("[[:punct:]]", "\\.", DEFENSE_ID))) %>%
                        mutate(TYPE = 'raw') %>%
                        select(SEASON, TEAM, PLAY_CATEGORY, PLAYS_DEFENSE, DEFENSE) %>%
                          mutate(DEFENSE = -DEFENSE),
                  by = c("SEASON", "TEAM", "PLAY_CATEGORY")) %>%
    #    mutate(OVERALL = OFFENSE + DEFENSE) %>%
   #     mutate(MARGIN = OVERALL * 65) %>%
        mutate_if(is.numeric, round, 3) %>%
   #     arrange(desc(MARGIN)) %>%
        rename(TEAM_ABBR = TEAM) %>%
        left_join(., team_mapping,
                  by = c("TEAM_ABBR")) %>%
        select(-TEAM_ABBR) %>%
        mutate(TYPE = 'raw') %>%
        select(SEASON, TEAM, TYPE, PLAY_CATEGORY, PLAYS_OFFENSE, PLAYS_DEFENSE, OFFENSE, DEFENSE) %>%
        pivot_wider(id_cols = c("SEASON", "TEAM", "TYPE"),
                    names_from = c("PLAY_CATEGORY"),
                    values_from = c("OFFENSE", "DEFENSE", "PLAYS_OFFENSE", "PLAYS_DEFENSE")) %>%
        arrange(desc(OFFENSE_RUN))

```


```{r adjust this}

ppa_fits_type = ppa_data %>%
        mutate(YEAR = SEASON) %>%
        filter(PLAY_CATEGORY != 'SPECIAL') %>%
        mutate(PLAY_TYPE = PLAY_CATEGORY) %>%
        nest(-YEAR, -PLAY_TYPE) %>%
        rename(SEASON = YEAR,
               PLAY_CATEGORY = PLAY_TYPE) %>%
        mutate(workflow = map(data,
                              ~ ppa_wf %>%
                                      fit(.x))) %>%
        mutate(augmented = map2(workflow, data,
                           ~ augment(.x, .y))) %>%
        mutate(fit = map(workflow, 
                         ~ extract_fit_parsnip(.x))) %>%
        mutate(coefs = map(fit,
                           ~ tidy(.x))) %>%
        mutate(intercept = map(coefs,
                               ~ .x %>% filter(term == '(Intercept)') %>% pull())) %>%
        mutate(adjusted = map2(coefs, intercept,
                               ~ .x %>% 
                                       filter(term != '(Intercept)' & term != 'HOME_FIELD_ADVANTAGE') %>%
                                       mutate(intercept = .y) %>%
                                       mutate(adjusted = estimate + intercept) %>%
                                       mutate(type = case_when(grepl("OFFENSE", term) ~ 'OFFENSE',
                                                               grepl("DEFENSE", term) ~ 'DEFENSE')) %>%
                                       mutate(TEAM = gsub("DEFENSE_ID_", "", gsub("OFFENSE_ID_", "", term))) %>%
                                       select(TEAM, type, adjusted) %>%
                                       spread(type, adjusted) %>%
                                       mutate(DEFENSE = -DEFENSE) %>%
                                  #     mutate(OVERALL = OFFENSE + DEFENSE) %>%
                                       mutate(TYPE = 'adjusted')))

# get adjusted
adjusted_team_rankings_type = ppa_fits_type %>%
        select(SEASON, PLAY_CATEGORY, adjusted) %>%
        unnest(adjusted) %>%
        mutate(TEAM_ABBR = gsub(" ", "\\.", TEAM)) %>%
        select(-TEAM) %>%
    #    mutate(MARGIN = OVERALL * 65) %>%
        mutate_if(is.numeric, round, 3) %>%
        left_join(., team_mapping,
                  by = c("TEAM_ABBR")) %>%
        select(-TEAM_ABBR) %>%
        select(SEASON, TEAM, PLAY_CATEGORY, TYPE, OFFENSE, DEFENSE) %>%
        pivot_wider(id_cols = c("SEASON", "TEAM", "TYPE"),
                    names_from = c("PLAY_CATEGORY"),
                    values_from = c("OFFENSE", "DEFENSE"))

```

Look at a team like Wisconsin, which has had fairly weak passing efficiency since the days of Russell Wilson, though evidently their passing game was somewhat okay in 2016 and 2017 while their run game suffered?

```{r look at wisconsin by type}

col_type_func =  
                function(x) {
                        
                        breaks = c(-0.8, -.5, -.4, -.3, -.2, -.1, -0.05, -0.03, -0.01, -0.001, -0.0005,
                                   0, 0.0005, 0.001, 0.01,0.03, 0.05, 0.1, 0.2, 0.3, 0.4, 0.5, 0.8)
                        colorRamp=colorRampPalette(c("red", "white", "deepskyblue"))
                        col_palette <- colorRamp(length(breaks))
                        mycut <- cut(x, 
                                     breaks = breaks,
                                     include.lowest = TRUE, 
                                     right=T,
                                     label = FALSE)
                        col_palette[mycut]
                        
                }

adjusted_team_rankings_type %>%
        arrange(SEASON) %>%
        filter(TEAM == 'Wisconsin') %>%
        mutate(SEASON = factor(SEASON)) %>%
        select(SEASON, TEAM, TYPE, OFFENSE_PASS, OFFENSE_RUN, DEFENSE_PASS, DEFENSE_RUN) %>%
        flextable() %>%
        autofit() %>%
        bg(., j= c("OFFENSE_RUN", "OFFENSE_PASS",
                   "DEFENSE_RUN", "DEFENSE_PASS"),
           bg = col_type_func) %>%
        flextable::align(j = c("OFFENSE_RUN", "OFFENSE_PASS",
                   "DEFENSE_RUN", "DEFENSE_PASS"),
              align = 'center')
        
```

As opposed to team like Texas Tech, which has often had a spectacular passing offense at the expense of basically everything else.

```{r look at iowa}

adjusted_team_rankings_type %>%
        arrange(SEASON) %>%
        filter(TEAM == 'Texas Tech') %>%
        mutate(SEASON = factor(SEASON)) %>%
        select(SEASON, TEAM, TYPE, OFFENSE_PASS, OFFENSE_RUN, DEFENSE_PASS, DEFENSE_RUN) %>%
        flextable() %>%
        autofit() %>%
        bg(., j= c("OFFENSE_RUN", "OFFENSE_PASS",
                   "DEFENSE_RUN", "DEFENSE_PASS"),
           bg = col_type_func) %>%
        flextable::align(j = c("OFFENSE_RUN", "OFFENSE_PASS",
                   "DEFENSE_RUN", "DEFENSE_PASS"),
              align = 'center')

```

Alabama is an interesting one to look at, as they're generally strong across the board but their passing efficiency in recent years is what has really set them apart.

```{r look at arkansas}

adjusted_team_rankings_type %>%
        arrange(SEASON) %>%
        filter(TEAM == 'Alabama') %>%
        mutate(SEASON = factor(SEASON)) %>%
        select(SEASON, TEAM, TYPE, OFFENSE_PASS, OFFENSE_RUN, DEFENSE_PASS, DEFENSE_RUN) %>%
        flextable() %>%
        autofit() %>%
        bg(., j= c("OFFENSE_RUN", "OFFENSE_PASS",
                   "DEFENSE_RUN", "DEFENSE_PASS"),
           bg = col_type_func) %>%
        flextable::align(j = c("OFFENSE_RUN", "OFFENSE_PASS",
                   "DEFENSE_RUN", "DEFENSE_PASS"),
              align = 'center')

```

Oklahoma 2018 is an interesting because they were so strong passing offensively and so weak at preventing other teams from passing.

```{r oklahoma by type}

adjusted_team_rankings_type %>%
        arrange(SEASON) %>%
        filter(TEAM == 'Oklahoma') %>%
        mutate(SEASON = factor(SEASON)) %>%
        select(SEASON, TEAM, TYPE, OFFENSE_PASS, OFFENSE_RUN, DEFENSE_PASS, DEFENSE_RUN) %>%
        flextable() %>%
        autofit() %>%
        bg(., j= c("OFFENSE_RUN", "OFFENSE_PASS",
                   "DEFENSE_RUN", "DEFENSE_PASS"),
           bg = col_type_func) %>%
        flextable::align(j = c("OFFENSE_RUN", "OFFENSE_PASS",
                   "DEFENSE_RUN", "DEFENSE_PASS"),
              align = 'center')

```

Texas A&M is an interesting one on this because in Manziel's Heisman year A&M generated more points per play running the ball than throwing - I would imagine this is cause of all of the times Manziel scrambled in order to bail out the offense.

```{r opponent adjusted ohio state}

adjusted_team_rankings_type %>%
        arrange(SEASON) %>%
        filter(TEAM == 'Texas A&M') %>%
        mutate(SEASON = factor(SEASON)) %>%
        select(SEASON, TEAM, TYPE, OFFENSE_PASS, OFFENSE_RUN, DEFENSE_PASS, DEFENSE_RUN) %>%
        flextable() %>%
        autofit() %>%
        bg(., j= c("OFFENSE_RUN", "OFFENSE_PASS",
                   "DEFENSE_RUN", "DEFENSE_PASS"),
           bg = col_type_func) %>%
        flextable::align(j = c("OFFENSE_RUN", "OFFENSE_PASS",
                   "DEFENSE_RUN", "DEFENSE_PASS"),
              align = 'center')

```


```{r save type rankings}

season_team_rankings_type = bind_rows(raw_team_rankings_type,
                                      adjusted_team_rankings_type %>% 
                                              left_join(., raw_team_rankings_type %>%
                                                                select(SEASON, TEAM, starts_with("PLAYS")),
                                                        by = c("SEASON", "TEAM")))

save(season_team_rankings_type,
     file = here::here("data", "season_team_rankings_type.Rdata"))

```


# Measuring Efficiency in Season

So far, everything we've computed has been retrospective, evaluating teams on an entire season's worth of plays to measure their offense and defense strength. But suppose we are now going into the 2016 season. How do we rate teams? Before any games have been played, we could rely on previous seasons' efficiency data for every team. This is the lineup of Week 1 games using each team's power rating at the end of the previous season.

```{r show teams and their rankings going into week one}

col_power_func =  
                function(x) {
                        
                        breaks = c(-0.8, -.5, -.4, -.3, -.2, -.1, -0.05, -0.03, -0.01, -0.001,
                                   0, 0.001, 0.01,0.03, 0.05, 0.1, 0.2, 0.3, 0.4, 0.5, 0.8)*100
                        colorRamp=colorRampPalette(c("red", "white", "deepskyblue"))
                        col_palette <- colorRamp(length(breaks))
                        mycut <- cut(x, 
                                     breaks = breaks,
                                     include.lowest = TRUE, 
                                     right=T,
                                     label = FALSE)
                        col_palette[mycut]
                        
                }
        
ppa_data %>%
        filter(SEASON == 2016) %>%
        filter(WEEK ==1) %>%
        select(SEASON, GAME_ID, WEEK, HOME, AWAY) %>%
        distinct() %>%
        left_join(., games_raw %>%
                          select(GAME_ID, NEUTRAL_SITE),
                  by = c("GAME_ID")) %>%
        left_join(., adjusted_team_rankings %>%
                          filter(SEASON == 2016-1) %>%
                          mutate(SEASON = SEASON + 1) %>%
                          select(SEASON, TEAM, MARGIN, OFFENSE, DEFENSE) %>%
                          rename(HOME = TEAM,
                                 HOME_POWER = MARGIN,
                                 HOME_OFF_POWER = OFFENSE,
                                 HOME_DEF_POWER = DEFENSE),
                  by = c("SEASON", "HOME")) %>%
        left_join(., adjusted_team_rankings %>%
                          filter(SEASON == 2016-1) %>%
                          mutate(SEASON = SEASON + 1) %>%
                          select(SEASON, TEAM, MARGIN, OFFENSE, DEFENSE) %>%
                          rename(AWAY = TEAM,
                                 AWAY_POWER = MARGIN,
                                 AWAY_OFF_POWER = OFFENSE,
                                 AWAY_DEF_POWER = DEFENSE),
                  by = c("SEASON", "AWAY")) %>%
       # mutate(HOME_OFF)
        mutate(HOME_DIFF = case_when(NEUTRAL_SITE == T ~ HOME_POWER - AWAY_POWER,
                                     NEUTRAL_SITE == F ~ 3 +HOME_POWER - AWAY_POWER)) %>%
        select(SEASON, WEEK, HOME, AWAY, HOME_POWER, AWAY_POWER) %>%
        mutate_if(is.numeric, round, 1) %>%
        mutate(SEASON = factor(SEASON)) %>%
        flextable() %>%
        autofit() %>%
        bg(., j = c("HOME_POWER", "AWAY_POWER"),
           bg = col_power_func) %>%
        flextable::align(., j = c("HOME_POWER", "AWAY_POWER"),
              align = 'center')

```

We could use the difference in each team's power to predict week 1 - the power ratings themselves are the expected margin of victory for each team against an average team on a neutral field. So, we simply take the difference and add an adjustment based on home field advantage to predict the score of the game (this is a crude mapping of team ratings to predicting the score, I'll use a model for this later). How does this do in predicting week 1?

```{r show going into week 1}

week_one_preds = ppa_data %>%
        filter(SEASON == 2016) %>%
        filter(WEEK ==1) %>%
        select(SEASON, GAME_ID, WEEK, HOME, AWAY) %>%
        distinct() %>%
        left_join(., games_raw %>%
                          select(GAME_ID, NEUTRAL_SITE, HOME_POINTS, AWAY_POINTS),
                  by = c("GAME_ID")) %>%
        left_join(., adjusted_team_rankings %>%
                          filter(SEASON == 2016-1) %>%
                          mutate(SEASON = SEASON + 1) %>%
                          select(SEASON, TEAM, MARGIN, OFFENSE, DEFENSE) %>%
                          rename(HOME = TEAM,
                                 HOME_POWER = MARGIN,
                                 HOME_OFF_POWER = OFFENSE,
                                 HOME_DEF_POWER = DEFENSE),
                  by = c("SEASON", "HOME")) %>%
        left_join(., adjusted_team_rankings %>%
                          filter(SEASON == 2016-1) %>%
                          mutate(SEASON = SEASON + 1) %>%
                          select(SEASON, TEAM, MARGIN, OFFENSE, DEFENSE) %>%
                          rename(AWAY = TEAM,
                                 AWAY_POWER = MARGIN,
                                 AWAY_OFF_POWER = OFFENSE,
                                 AWAY_DEF_POWER = DEFENSE),
                  by = c("SEASON", "AWAY")) %>%
        mutate(PRED_MARGIN = case_when(NEUTRAL_SITE == T ~ HOME_POWER - AWAY_POWER,
                                     NEUTRAL_SITE == F ~ 3 +HOME_POWER - AWAY_POWER)) %>%
        mutate(HOME_MARGIN = HOME_POINTS - AWAY_POINTS)

week_one_preds %>%
        select(SEASON, WEEK, HOME, AWAY, PRED_MARGIN, HOME_MARGIN) %>%
        mutate_if(is.numeric, round, 1) %>%
        mutate(SEASON = factor(SEASON)) %>%
        flextable() %>%
        autofit() %>%
        bg(., j = c("HOME_MARGIN", "PRED_MARGIN"),
           bg = col_power_func) %>%
        flextable::align(., j = c("HOME_MARGIN", "PRED_MARGIN"),
              align = 'center')

```

How well do last year's rankings do in predicting games in terms of accuracy and the spread?

```{r how did week one do}

# week_one_preds %>%
#         mutate(PRED_CORRECT = case_when(PRED_MARGIN > 0 & HOME_MARGIN > 0 ~ 'yes',
#                                         PRED_MARGIN < 0 & HOME_MARGIN < 0 ~ 'yes',
#                TRUE ~ 'no')) %>%
#         ggplot(., aes(x= PRED_MARGIN,
#                       color = PRED_CORRECT,
#                       label = paste(HOME, AWAY),
#                       y= HOME_MARGIN))+
#         geom_point()+
#         geom_text_repel(show.legend=F)+
#         theme_phil()+
#         scale_color_manual(values = c("red", "deepskyblue1"))+
#         geom_vline(xintercept = 0,
#                    linetype = 'dashed')+
#         geom_hline(yintercept = 0,
#                    linetype = 'dashed')+
#         guides(label = "none")

week_one_preds %>%
        group_by(SEASON, WEEK) %>%
        yardstick::rmse(truth = HOME_MARGIN,
                        estimate = PRED_MARGIN) %>%
        mutate_if(is.numeric, round, 2)

week_one_preds %>%
        mutate(HOME_PRED = factor(case_when(PRED_MARGIN > 0 ~ 'yes',
                                     TRUE ~ 'no'),
                                  levels = c('no', 'yes'))) %>%
        mutate(HOME_WIN= factor(case_when(HOME_MARGIN > 0 ~ 'yes',
                                     TRUE ~ 'no'),
                                  levels = c('no', 'yes'))) %>%
        group_by(SEASON, WEEK) %>%
        yardstick::accuracy(truth = HOME_WIN,
                            estimate = HOME_PRED) %>%
        mutate_if(is.numeric, round, 3)
        
```

Not so great on the margin of victory, but about 70% of the games correct. Not too great, but it's a start.

But now let's say we've seen a week's worth of games. How do we predict *next* week's games? We could keep on using the power ratings from last season to predict week 2 (and it turns out that when we do, we get close to 90% accuracy - Week 1 in 2016 had a bunch more upsets), but we want our power ratings to update based on new information. 

```{r week two eval}

previous_season_accuracy = ppa_data %>%
        filter(SEASON == 2016) %>%
        select(SEASON, GAME_ID, WEEK, HOME, AWAY) %>%
        distinct() %>%
        left_join(., games_raw %>%
                          select(GAME_ID, NEUTRAL_SITE, HOME_POINTS, AWAY_POINTS),
                  by = c("GAME_ID")) %>%
        left_join(., adjusted_team_rankings %>%
                          filter(SEASON == 2016-1) %>%
                          mutate(SEASON = SEASON + 1) %>%
                          select(SEASON, TEAM, MARGIN, OFFENSE, DEFENSE) %>%
                          rename(HOME = TEAM,
                                 HOME_POWER = MARGIN,
                                 HOME_OFF_POWER = OFFENSE,
                                 HOME_DEF_POWER = DEFENSE),
                  by = c("SEASON", "HOME")) %>%
        left_join(., adjusted_team_rankings %>%
                          filter(SEASON == 2016-1) %>%
                          mutate(SEASON = SEASON + 1) %>%
                          select(SEASON, TEAM, MARGIN, OFFENSE, DEFENSE) %>%
                          rename(AWAY = TEAM,
                                 AWAY_POWER = MARGIN,
                                 AWAY_OFF_POWER = OFFENSE,
                                 AWAY_DEF_POWER = DEFENSE),
                  by = c("SEASON", "AWAY")) %>%
        mutate(PRED_MARGIN = case_when(NEUTRAL_SITE == T ~ HOME_POWER - AWAY_POWER,
                                     NEUTRAL_SITE == F ~ 3 +HOME_POWER - AWAY_POWER)) %>%
        mutate(HOME_MARGIN = HOME_POINTS - AWAY_POINTS) %>%
        mutate(HOME_PRED = factor(case_when(PRED_MARGIN > 0 ~ 'yes',
                                     TRUE ~ 'no'),
                                  levels = c('no', 'yes'))) %>%
        mutate(HOME_WIN= factor(case_when(HOME_MARGIN > 0 ~ 'yes',
                                     TRUE ~ 'no'),
                                  levels = c('no', 'yes'))) %>%
        group_by(SEASON, WEEK) %>%
        yardstick::accuracy(truth = HOME_WIN,
                            estimate = HOME_PRED) %>%
        mutate_if(is.numeric, round, 3)

previous_season_accuracy %>%
        mutate(type = 'previous season') %>%
        select(SEASON, WEEK,type, .metric, .estimate) %>%
        mutate(SEASON = factor(SEASON)) %>%
        flextable() %>%
        autofit()

```

If we rely only on previous season's data, we end up getting less and less accurate the further out we go, though it is kind of interesting looking at how well we do predicting bowl games using nothing other than how the teams were at the end of the previous season.

```{r here is the spread for postseason}

ppa_data %>%
    filter(SEASON == 2016) %>%
    select(SEASON, GAME_ID, WEEK, HOME, AWAY) %>%
    distinct() %>%
    left_join(., games_raw %>%
                  select(GAME_ID, SEASON_TYPE, NEUTRAL_SITE, HOME_POINTS, AWAY_POINTS),
              by = c("GAME_ID")) %>%
    left_join(., adjusted_team_rankings %>%
                  filter(SEASON == 2016-1) %>%
                  mutate(SEASON = SEASON + 1) %>%
                  select(SEASON, TEAM, MARGIN, OFFENSE, DEFENSE) %>%
                  rename(HOME = TEAM,
                         HOME_POWER = MARGIN,
                         HOME_OFF_POWER = OFFENSE,
                         HOME_DEF_POWER = DEFENSE),
              by = c("SEASON", "HOME")) %>%
    left_join(., adjusted_team_rankings %>%
                  filter(SEASON == 2016-1) %>%
                  mutate(SEASON = SEASON + 1) %>%
                  select(SEASON, TEAM, MARGIN, OFFENSE, DEFENSE) %>%
                  rename(AWAY = TEAM,
                         AWAY_POWER = MARGIN,
                         AWAY_OFF_POWER = OFFENSE,
                         AWAY_DEF_POWER = DEFENSE),
              by = c("SEASON", "AWAY")) %>%
    mutate(PRED_MARGIN = case_when(NEUTRAL_SITE == T ~ HOME_POWER - AWAY_POWER,
                                   NEUTRAL_SITE == F ~ 3 +HOME_POWER - AWAY_POWER)) %>%
    mutate(HOME_MARGIN = HOME_POINTS - AWAY_POINTS) %>% 
        filter(SEASON_TYPE == 'postseason') %>%
select(SEASON, SEASON_TYPE, WEEK, HOME, AWAY, HOME_POWER, AWAY_POWER, PRED_MARGIN, HOME_MARGIN) %>%
        mutate_if(is.numeric, round, 1) %>%
        mutate(SEASON = factor(SEASON)) %>%
        flextable() %>%
        autofit() %>%
                bg(., j = c("HOME_MARGIN", "PRED_MARGIN"),
           bg = col_power_func) %>%
        flextable::align(., j = c("HOME_MARGIN", "PRED_MARGIN"),
              align = 'center')

```


## Updating Ratings Week by Week

How do we incorporate new information from teams? As they play games in the new season, we should expect that this will outweigh the information about teams from previous seasons. I can calculate the raw ratings for Week 1 based on play by play data: here are the top 5 and bottom 5 teams based on Week 1 raw efficiency in 2016.

```{r get in one week}

one_week_raw = ppa_data %>%
        filter(SEASON == 2016 & WEEK ==1) %>%
        filter(GARBAGE_TIME == 0) %>%
        group_by(SEASON, OFFENSE_ID) %>%
        summarize(OFFENSE = mean(PPA, na.rm=T),
                  .groups = 'drop') %>%
        mutate(TEAM = gsub(" ", "\\.", gsub("[[:punct:]]", "\\.", OFFENSE_ID))) %>%
        mutate(TYPE = 'raw') %>%
        select(SEASON, TEAM, TYPE, OFFENSE) %>%
        left_join(.,
                  ppa_data %>%
                          filter(SEASON ==2016 & WEEK ==1) %>%
                          filter(GARBAGE_TIME == 0) %>%
                          group_by(SEASON, DEFENSE_ID) %>%
                          summarize(DEFENSE = mean(PPA, na.rm=T),
                                  .groups = 'drop') %>%
                          mutate(TEAM = gsub(" ", "\\.", gsub("[[:punct:]]", "\\.", DEFENSE_ID))) %>%
                          mutate(TYPE = 'raw') %>%
                          select(SEASON, TEAM, TYPE, DEFENSE) %>%
                          mutate(DEFENSE = -DEFENSE),
                  by = c("SEASON", "TEAM", "TYPE")) %>%
        mutate(OVERALL = OFFENSE + DEFENSE) %>%
        mutate(MARGIN = OVERALL * 65) %>%
        mutate_if(is.numeric, round, 3) %>%
        arrange(desc(MARGIN)) %>%
        rename(TEAM_ABBR = TEAM) %>%
        left_join(., team_mapping,
                  by = c("TEAM_ABBR")) %>%
        select(-TEAM_ABBR) %>%
        mutate(TYPE = 'raw') %>%
        select(SEASON, TEAM, TYPE, OFFENSE, DEFENSE, OVERALL, MARGIN)

one_week_raw %>%
        slice_max(., order_by = OVERALL, n= 5) %>%
        bind_rows(.,
                  one_week_raw %>%
                          slice_min(., order_by = OVERALL, n = 5)) %>%
        arrange(desc(OVERALL)) %>%
        mutate(SEASON = factor(SEASON)) %>%
        flextable() %>%
        autofit()

```

Because we're looking only at raw data, the best teams are simply the ones that won big in Week 1 (and the worst ones are the teams they beat) - Louisville beat Charlotte 70-14, Michigan beat Hawaii 63-3, Boise State beat Loisiana 45-10...

One week can only tell us so much about a team, but the bigger problem is the same as before: raw expected points per play doesn't take into account the quality of the opponent. The method I've used for adjusting based on opponent quality so far has been at the season level, and it relies on taking into account all games that have been playing to partial out how strong or weak each team's offense/defense is. 

## Updating Weekly Ratings

I can run the ridge regression on each week of data to get the coefficient for each team based on a week's worth of results. The Week 0 ratings are our prior, which should be pretty strong, as they're based on the last season's worth of data (and we can include even more previous seasons in computing that prior).

```{r look at how team changed}

# season to run
season = 2016

# set up grid of games by week
week_grid = ppa_data %>%
        filter(SEASON == season) %>%
        select(SEASON, WEEK) %>%
        distinct() %>%
        arrange(WEEK)

# make an empty grid for all fbs teams for each week of the season
team_week_grid = expand.grid(SEASON = season,
                             WEEK = c(0,
                                      ppa_data %>%
                                     filter(SEASON == season) %>%
                                     select(WEEK) %>%
                                     distinct %>%
                                     pull),
                             TEAM = ppa_data %>%
                                     filter(SEASON == season) %>%
                                     select(HOME, AWAY) %>%
                                     gather() %>%
                                     select(value) %>%
                                     distinct %>%
                                     pull) %>%
        arrange(SEASON, WEEK, TEAM)

# for each week, get coefficients using all data from that season through each week
weekly_updates = foreach(i = 1:nrow(week_grid),
        .combine = bind_rows) %do% {
                
                ppa_data %>%
                        filter(SEASON == season & WEEK <= week_grid[i,]$WEEK) %>%
                        filter(GARBAGE_TIME==0) %>%
                        mutate(YEAR = season) %>%
                        nest(-YEAR) %>%
                        rename(SEASON = YEAR) %>%
                        mutate(workflow = map(data,
                                              ~ ppa_wf %>%
                                                      fit(.x))) %>%
                        mutate(fit = map(workflow, 
                                         ~ extract_fit_parsnip(.x))) %>%
                        mutate(coefs = map(fit,
                                           ~ tidy(.x))) %>%
                        mutate(intercept = map(coefs,
                                               ~ .x %>% filter(term == '(Intercept)') %>% pull())) %>%
                        mutate(adjusted = map2(coefs, intercept,
                                               ~ .x %>% 
                                                       filter(term != '(Intercept)' & term != 'HOME_FIELD_ADVANTAGE') %>%
                                                       mutate(intercept = .y) %>%
                                                       mutate(adjusted = estimate + intercept) %>%
                                                       mutate(type = case_when(grepl("OFFENSE", term) ~ 'OFFENSE',
                                                                               grepl("DEFENSE", term) ~ 'DEFENSE')) %>%
                                                       mutate(TEAM = gsub("DEFENSE_ID_", "", gsub("OFFENSE_ID_", "", term))) %>%
                                                       select(TEAM, type, adjusted) %>%
                                                       spread(type, adjusted) %>%
                                                       mutate(DEFENSE = -DEFENSE) %>%
                                                       mutate(OVERALL = OFFENSE + DEFENSE) %>%
                                                       mutate(TYPE = 'adjusted'))) %>%
                        mutate(WEEK = week_grid[i,]$WEEK)

        }

# now join these up with our grid
weekly_team_rankings = team_week_grid %>%
        left_join(.,
                  adjusted_team_rankings %>%
                        filter(SEASON == 2015) %>%
                        mutate(SEASON = 2016,
                               WEEK = 0) %>%
                        bind_rows(.,
                                weekly_updates %>%
                                        select(SEASON, WEEK, adjusted) %>%
                                        unnest(adjusted) %>%
                                        rename(TEAM_ABBR = TEAM) %>%
                                        left_join(., team_mapping,
                                                  by = c("TEAM_ABBR")) %>%
                                        select(-TEAM_ABBR) %>%
                                        select(SEASON, WEEK, TEAM, TYPE, OFFENSE, DEFENSE) %>%
                                        mutate(OVERALL = OFFENSE + DEFENSE) %>%
                                        mutate_if(is.numeric, round, 3) %>%
                                        arrange(desc(OVERALL)) %>%
                                        arrange(SEASON, WEEK)
                        ) %>%
                select(SEASON, WEEK, TEAM, OFFENSE, DEFENSE, OVERALL),
                by = c("SEASON", "WEEK", "TEAM")) %>%
        group_by(TEAM) %>%
        fill(OFFENSE, DEFENSE, OVERALL, .direction = 'down') %>%
        mutate(MARGIN = OVERALL * 65)

rm(weekly_updates)
        
```

Each team's rating for Week 0 is based on previous season(s). If we run the ridge regression after the first week, each team's rating going into Week 2 is based *only* on a week's worth of games. Here are where Notre Dame and Texas end up after their matchup: Texas gets a big jump and Notre Dame drops a bunch.

```{r show texas and notre dame after week 1}

weekly_team_rankings  %>%
        left_join(., team_mapping,
                  by = c("TEAM")) %>%
        left_join(.,
                  team_conference_season,
                  by = c("SEASON", "TEAM")) %>%
        group_by(TEAM) %>%
        fill(OFFENSE, DEFENSE, OVERALL, .direction = 'down') %>%
        mutate(TEAM_LABEL = case_when(WEEK == max(WEEK) ~ ABBREVIATION)) %>%
        filter(TEAM %in% c("Texas", "Notre Dame")) %>%
        ungroup() %>%
        filter(WEEK < 2) %>%
        ggplot(., aes(x=WEEK,
                      label = TEAM_LABEL,
                      color = TEAM,
                      y= OVERALL))+
        facet_wrap(SEASON  ~.)+
        geom_hline(yintercept = 0,
                   linetype = 'dashed')+
        geom_point()+
        guides(color = 'none')+
        geom_line(lwd = 1.04)+
        # geom_line(stat = 'smooth',
        #               formula = 'y ~ x',
        #               method = 'loess',
        #               alpha =0.85,
        #               span = 0.25,
        #               lwd = 1.04)+
        geom_text_repel(fontface = "bold",
                        size = 4,
                        direction = "y",
                        hjust = -1.5,
                        segment.size = .7,
                        segment.alpha = .5,
                        segment.linetype = "dotted",
                        box.padding = .4,
                        segment.curvature = -0.1,
                        segment.ncp = 3,
                        segment.angle = 20)+
        coord_cartesian(xlim = c(-0.5, 18),
                        ylim = c(-0.5, 0.5))+
        custom_color_teams+
        theme_phil()+
        ylab("Net Team Efficiency per play")

```

If we let another week pass, we run the ridge regression on both weeks. Both Notre Dame and Texas beat their (fairly weak) opponents of Nevada and UTEP pretty handily, so both get an increase. This increase is enough for Notre Dame that they bounce above where they were after losing to Texas (quality loss?).

```{r notre dame bounces back}

weekly_team_rankings  %>%
        left_join(., team_mapping,
                  by = c("TEAM")) %>%
        left_join(.,
                  team_conference_season,
                  by = c("SEASON", "TEAM")) %>%
        group_by(TEAM) %>%
        fill(OFFENSE, DEFENSE, OVERALL, .direction = 'down') %>%
        mutate(TEAM_LABEL = case_when(WEEK == max(WEEK) ~ ABBREVIATION)) %>%
        filter(TEAM %in% c("Texas", "Notre Dame")) %>%
        ungroup() %>%
        filter(WEEK < 4) %>%
        ggplot(., aes(x=WEEK,
                      label = TEAM_LABEL,
                      color = TEAM,
                      y= OVERALL))+
        facet_wrap(SEASON  ~.)+
        geom_hline(yintercept = 0,
                   linetype = 'dashed')+
        geom_point()+
        guides(color = 'none')+
      #  geom_line(lwd = 1.04)+
        geom_line(stat = 'smooth',
                      formula = 'y ~ x',
                      method = 'loess',
                      alpha =0.85,
                      span = 0.8,
                      lwd = 1.04)+
        geom_text_repel(fontface = "bold",
                        size = 4,
                        direction = "y",
                        hjust = -1.5,
                        segment.size = .7,
                        segment.alpha = .5,
                        segment.linetype = "dotted",
                        box.padding = .4,
                        segment.curvature = -0.1,
                        segment.ncp = 3,
                        segment.angle = 20)+
        coord_cartesian(xlim = c(-0.5, 18),
                        ylim = c(-0.5, 0.5))+
        custom_color_teams+
        theme_phil()+
        ylab("Net Team Efficiency per play")

```

Roll forward a few more weeks and we can see how both teams started to crash around midseason before eventually recovering to reach medicrity by end season.

```{r both crash}

weekly_team_rankings  %>%
        left_join(., team_mapping,
                  by = c("TEAM")) %>%
        left_join(.,
                  team_conference_season,
                  by = c("SEASON", "TEAM")) %>%
        group_by(TEAM) %>%
        fill(OFFENSE, DEFENSE, OVERALL, .direction = 'down') %>%
        mutate(TEAM_LABEL = case_when(WEEK == max(WEEK) ~ ABBREVIATION)) %>%
        filter(TEAM %in% c("Texas", "Notre Dame")) %>%
        ungroup() %>%
     #   filter(WEEK < 12) %>%
        ggplot(., aes(x=WEEK,
                      label = TEAM_LABEL,
                      color = TEAM,
                      y= OVERALL))+
        facet_wrap(SEASON  ~.)+
        geom_hline(yintercept = 0,
                   linetype = 'dashed')+
        geom_point()+
        guides(color = 'none')+
        geom_line(stat = 'smooth',
                      formula = 'y ~ x',
                      method = 'loess',
                      alpha =0.85,
                      span = 0.25,
                      lwd = 1.04)+
        geom_text_repel(fontface = "bold",
                        size = 4,
                        direction = "y",
                        hjust = -1.5,
                        segment.size = .7,
                        segment.alpha = .5,
                        segment.linetype = "dotted",
                        box.padding = .4,
                        segment.curvature = -0.1,
                        segment.ncp = 3,
                        segment.angle = 20)+
        coord_cartesian(xlim = c(-0.5, 18),
                        ylim = c(-0.5, 0.5))+
        custom_color_teams+
        theme_phil()+
        ylab("Net Team Efficiency per play")

```

At the beginning of the season, relying only on games played so far can yield pretty unstable results. As we get more and more information, each team's rating starts to converge and become more stable, but the early season will see teams bounce around a lot.

This means if we try to predict games in the early part of the year based only on in-season results, we don't do nearly as well as when we use information from previous seasons.

```{r weighted average}

ppa_data %>%
        filter(SEASON == 2016) %>%
        select(SEASON, GAME_ID, WEEK, HOME, AWAY) %>%
        distinct() %>%
        arrange(SEASON, WEEK) %>%
        left_join(., games_raw %>%
                          select(GAME_ID, NEUTRAL_SITE, HOME_POINTS, AWAY_POINTS),
                  by = c("GAME_ID")) %>%
        left_join(., weekly_team_rankings %>%
                          mutate(WEEK = WEEK +1) %>%
                          select(SEASON, WEEK, TEAM, MARGIN, OFFENSE, DEFENSE) %>%
                          rename(HOME = TEAM,
                                 HOME_POWER = MARGIN,
                                 HOME_OFF_POWER = OFFENSE,
                                 HOME_DEF_POWER = DEFENSE),
                  by = c("SEASON", "WEEK", "HOME")) %>%
        arrange(SEASON, WEEK) %>%
        left_join(., weekly_team_rankings %>%
                          mutate(WEEK = WEEK +1) %>%
                          select(SEASON, WEEK, TEAM, MARGIN, OFFENSE, DEFENSE) %>%
                          rename(AWAY = TEAM,
                                 AWAY_POWER = MARGIN,
                                 AWAY_OFF_POWER = OFFENSE,
                                 AWAY_DEF_POWER = DEFENSE),
                  by = c("SEASON", "WEEK", "AWAY")) %>%
        mutate(PRED_MARGIN = case_when(NEUTRAL_SITE == T ~ HOME_POWER - AWAY_POWER,
                                     NEUTRAL_SITE == F ~ 3 +HOME_POWER - AWAY_POWER)) %>%
        mutate(HOME_MARGIN = HOME_POINTS - AWAY_POINTS) %>%
        group_by(SEASON, WEEK) %>%
        mutate(HOME_PRED = factor(case_when(PRED_MARGIN > 0 ~ 'yes',
                                     TRUE ~ 'no'))) %>%
        mutate(HOME_WIN = factor(case_when(HOME_MARGIN > 0 ~ 'yes',
                                    TRUE ~ 'no'))) %>%
        group_by(SEASON, WEEK) %>%
        yardstick::accuracy(truth = HOME_WIN,
                            estimate = HOME_PRED) %>%
        mutate_if(is.numeric, round, 3) %>%
        mutate(type = 'in_season') %>%
        bind_rows(.,
                  previous_season_accuracy %>%
                          mutate(type = 'previous_season')) %>%
        spread(type, .estimate) %>%
        select(-.estimator) %>%
        mutate(winner = case_when(in_season > previous_season ~ 'in_season',
                                  in_season < previous_season ~ 'previous_season',
                                  TRUE ~ 'tie')) %>%
        mutate(SEASON = factor(SEASON)) %>%
        flextable() %>%
        autofit()

```

In general, the early season sees a lot of swings using only in season data, but it starts to outperform using the previous season's rating as the season wears on. So our goal is to blend the two together using a weighted average. I'll use exponentially decaying weights over the course of the season, heavily weighting the prior season rating in early weeks and upping the weight to the in season data as the season wears on.

```{r create weighted average}

exp_weights = function(n, rho) {
        rho^((n-1):0)
}

weekly_weighting_func = function(input_rankings) {
        
        gather_teams = input_rankings %>%
                gather("metric", "value",
               -SEASON, -WEEK, -TEAM) %>%
                ungroup()
        
        team_priors = gather_teams %>%
                group_by(TEAM) %>%
                filter(WEEK ==0) %>%
                rename(prior = value) %>%
                select(SEASON, TEAM, metric, prior) %>%
                ungroup()
        
        weeks = tibble(WEEK = seq(0, 18))
        weights = tibble(weight = rev(exp_weights(nrow(weeks), 0.85)))
        week_weights = bind_cols(weeks, weights)
        
        out = gather_teams %>%
                left_join(.,
                          team_priors,
                          by = c("SEASON", "TEAM", "metric")) %>%
                left_join(.,
                          week_weights,
                          by = c("WEEK")) %>%
                mutate(averaged = (value*(1-weight)) + (prior*weight)) %>%
                select(SEASON, WEEK, TEAM, metric, averaged) %>%
                spread(metric, averaged)
        
        return(out)
        
}
                
        
```
        
I'll now run the weekly team ratings through the weighting function. This is what Texas and Notre Dame look like throughout the 2016 season using the combination vs just the in season.

```{r look at texas notre dame comparison}

weekly_team_rankings  %>%
        left_join(., team_mapping,
                  by = c("TEAM")) %>%
        left_join(.,
                  team_conference_season,
                  by = c("SEASON", "TEAM")) %>%
        group_by(TEAM) %>%
        fill(OFFENSE, DEFENSE, OVERALL, .direction = 'down') %>%
        mutate(TEAM_LABEL = case_when(WEEK == max(WEEK) ~ ABBREVIATION)) %>%
        filter(TEAM %in% c("Texas", "Notre Dame")) %>%
        ungroup() %>% 
        mutate(TYPE = 'in-season') %>%
        bind_rows(.,
                  weekly_team_rankings  %>%
                          weekly_weighting_func() %>%
                left_join(., team_mapping,
                          by = c("TEAM")) %>%
                left_join(.,
                          team_conference_season,
                          by = c("SEASON", "TEAM")) %>%
                group_by(TEAM) %>%
                fill(OFFENSE, DEFENSE, OVERALL, .direction = 'down') %>%
                mutate(TEAM_LABEL = case_when(WEEK == max(WEEK) ~ ABBREVIATION)) %>%
                filter(TEAM %in% c("Texas", "Notre Dame")) %>%
                ungroup() %>%
                        mutate(TYPE = 'weighted average')) %>%
     #   filter(WEEK < 12) %>%
        ggplot(., aes(x=WEEK,
                      label = TEAM_LABEL,
                      linetype = TYPE,
                      color = TEAM,
                      y= OVERALL))+
        facet_wrap(SEASON  ~.)+
        geom_hline(yintercept = 0,
                   linetype = 'dashed')+
        geom_point()+
        guides(color = 'none')+
        geom_line(stat = 'smooth',
                      formula = 'y ~ x',
                      method = 'loess',
                      alpha =0.85,
                      span = 0.25,
                      lwd = 1.04)+
        geom_text_repel(fontface = "bold",
                        size = 4,
                        direction = "y",
                        hjust = -1.5,
                        segment.size = .7,
                        segment.alpha = .5,
                        segment.linetype = "dotted",
                        box.padding = .4,
                        segment.curvature = -0.1,
                        segment.ncp = 3,
                        segment.angle = 20)+
        coord_cartesian(xlim = c(-0.5, 18),
                        ylim = c(-0.5, 0.5))+
        custom_color_teams+
        theme_phil()+
        ylab("Net Team Efficiency per play")+
        facet_wrap(TEAM ~.)

```

The weighted average approach tends to counterbalance the early season swings, which means we will be less reactive to early season results. The extent to which we *should* react to early season results is an interesting one - in the case of Texas and Notre Dame, we may have wanted to be more cynical about how good they were by the mid season. In the case of some teams that did emerge early in the 2016 season, such as Louisville, Washington, and Michigan, we could miss out on catching onto these teams as being better than previous seasons if we weight previous seasons too highly.

```{r look at lousiville and michigan}

weekly_team_rankings  %>%
        left_join(., team_mapping,
                  by = c("TEAM")) %>%
        left_join(.,
                  team_conference_season,
                  by = c("SEASON", "TEAM")) %>%
        group_by(TEAM) %>%
        fill(OFFENSE, DEFENSE, OVERALL, .direction = 'down') %>%
        mutate(TEAM_LABEL = case_when(WEEK == max(WEEK) ~ ABBREVIATION)) %>%
        filter(TEAM %in% c("Michigan", "Louisville", "Tennessee", "Washington")) %>%
        ungroup() %>% 
        mutate(TYPE = 'in-season') %>%
        bind_rows(.,
                  weekly_team_rankings  %>%
                          weekly_weighting_func() %>%
                left_join(., team_mapping,
                          by = c("TEAM")) %>%
                left_join(.,
                          team_conference_season,
                          by = c("SEASON", "TEAM")) %>%
                group_by(TEAM) %>%
                fill(OFFENSE, DEFENSE, OVERALL, .direction = 'down') %>%
                mutate(TEAM_LABEL = case_when(WEEK == max(WEEK) ~ ABBREVIATION)) %>%
        filter(TEAM %in% c("Michigan", "Louisville", "Tennessee", "Washington")) %>%
                ungroup() %>%
                        mutate(TYPE = 'weighted average')) %>%
     #   filter(WEEK < 12) %>%
        ggplot(., aes(x=WEEK,
                      label = TEAM_LABEL,
                      linetype = TYPE,
                      color = TEAM,
                      y= OVERALL))+
        facet_wrap(SEASON  ~.,
                   ncol = 2)+
        geom_hline(yintercept = 0,
                   linetype = 'dashed')+
        geom_point()+
        guides(color = 'none')+
        geom_line(stat = 'smooth',
                      formula = 'y ~ x',
                      method = 'loess',
                      alpha =0.85,
                      span = 0.25,
                      lwd = 1.04)+
        geom_text_repel(fontface = "bold",
                        size = 4,
                        direction = "y",
                        hjust = -1.5,
                        segment.size = .7,
                        segment.alpha = .5,
                        segment.linetype = "dotted",
                        box.padding = .4,
                        segment.curvature = -0.1,
                        segment.ncp = 3,
                        segment.angle = 20)+
        coord_cartesian(xlim = c(-0.5, 18))+
        custom_color_teams+
        theme_phil()+
        ylab("Net Team Efficiency per play")+
        facet_wrap(TEAM ~.)

```

Can also look at other teams. 

```{r weighting function for 2016 plays}

weekly_team_rankings  %>%
        # use custom function
        weekly_weighting_func() %>%
        left_join(., team_mapping,
                  by = c("TEAM")) %>%
        left_join(.,
                  team_conference_season,
                  by = c("SEASON", "TEAM")) %>%
        group_by(TEAM) %>%
        fill(OFFENSE, DEFENSE, OVERALL, .direction = 'down') %>%
        mutate(TEAM_LABEL = case_when(WEEK == max(WEEK) ~ ABBREVIATION)) %>%
        filter(CONFERENCE %in% c("Big 12", "Big Ten", "ACC", "SEC")) %>%
      #  filter(TEAM %in% c("Texas A&M", "Mississippi State", "Arkansas")) %>%
        ungroup() %>%
        ggplot(., aes(x=WEEK,
                      label = TEAM_LABEL,
                      color = TEAM,
                      y= DEFENSE))+
        facet_wrap(SEASON + CONFERENCE ~.)+
        geom_hline(yintercept = 0,
                   linetype = 'dashed')+
        geom_point()+
        guides(color = 'none')+
        geom_line(stat = 'smooth',
                      formula = 'y ~ x',
                      method = 'loess',
                      alpha =0.85,
                      span = 0.25,
                      lwd = 1.04)+
        geom_text_repel(fontface = "bold",
                        size = 4,
                        direction = "y",
                        hjust = -1.5,
                        segment.size = .7,
                        segment.alpha = .5,
                        segment.linetype = "dotted",
                        box.padding = .4,
                        segment.curvature = -0.1,
                        segment.ncp = 3,
                        segment.angle = 20)+
        coord_cartesian(xlim = c(-0.5, 18))+
        custom_color_teams+
        theme_phil()+
        ylab("Net Team Efficiency per play")

```

I can then compare how this does in comparison to using purely the previous season or the in season.

```{r now tune}

ppa_data %>%
        filter(SEASON == 2016) %>%
        select(SEASON, GAME_ID, WEEK, HOME, AWAY) %>%
        distinct() %>%
        arrange(SEASON, WEEK) %>%
        left_join(., games_raw %>%
                          select(GAME_ID, NEUTRAL_SITE, HOME_POINTS, AWAY_POINTS),
                  by = c("GAME_ID")) %>%
        left_join(., weekly_team_rankings %>%
                          mutate(WEEK = WEEK +1) %>%
                          select(SEASON, WEEK, TEAM, MARGIN, OFFENSE, DEFENSE) %>%
                          rename(HOME = TEAM,
                                 HOME_POWER = MARGIN,
                                 HOME_OFF_POWER = OFFENSE,
                                 HOME_DEF_POWER = DEFENSE),
                  by = c("SEASON", "WEEK", "HOME")) %>%
        arrange(SEASON, WEEK) %>%
        left_join(., weekly_team_rankings %>%
                          mutate(WEEK = WEEK +1) %>%
                          select(SEASON, WEEK, TEAM, MARGIN, OFFENSE, DEFENSE) %>%
                          rename(AWAY = TEAM,
                                 AWAY_POWER = MARGIN,
                                 AWAY_OFF_POWER = OFFENSE,
                                 AWAY_DEF_POWER = DEFENSE),
                  by = c("SEASON", "WEEK", "AWAY")) %>%
        mutate(PRED_MARGIN = case_when(NEUTRAL_SITE == T ~ HOME_POWER - AWAY_POWER,
                                     NEUTRAL_SITE == F ~ 3 +HOME_POWER - AWAY_POWER)) %>%
        mutate(HOME_MARGIN = HOME_POINTS - AWAY_POINTS) %>%
        group_by(SEASON, WEEK) %>%
        mutate(HOME_PRED = factor(case_when(PRED_MARGIN > 0 ~ 'yes',
                                     TRUE ~ 'no'))) %>%
        mutate(HOME_WIN = factor(case_when(HOME_MARGIN > 0 ~ 'yes',
                                    TRUE ~ 'no'))) %>%
        group_by(SEASON, WEEK) %>%
        yardstick::accuracy(truth = HOME_WIN,
                            estimate = HOME_PRED) %>%
        mutate_if(is.numeric, round, 3) %>%
        mutate(type = 'in_season') %>%
        bind_rows(.,
                  previous_season_accuracy %>%
                          mutate(type = 'previous_season')) %>%
        bind_rows(.,
                  ppa_data %>%
                filter(SEASON == 2016) %>%
                select(SEASON, GAME_ID, WEEK, HOME, AWAY) %>%
                distinct() %>%
                arrange(SEASON, WEEK) %>%
                left_join(., games_raw %>%
                                  select(GAME_ID, NEUTRAL_SITE, HOME_POINTS, AWAY_POINTS),
                          by = c("GAME_ID")) %>%
                left_join(., weekly_team_rankings %>%
                                  weekly_weighting_func() %>%
                                  mutate(WEEK = WEEK +1) %>%
                                  select(SEASON, WEEK, TEAM, MARGIN, OFFENSE, DEFENSE) %>%
                                  rename(HOME = TEAM,
                                         HOME_POWER = MARGIN,
                                         HOME_OFF_POWER = OFFENSE,
                                         HOME_DEF_POWER = DEFENSE),
                          by = c("SEASON", "WEEK", "HOME")) %>%
                arrange(SEASON, WEEK) %>%
                left_join(., weekly_team_rankings %>%
                                  weekly_weighting_func() %>%
                                  mutate(WEEK = WEEK +1) %>%
                                  select(SEASON, WEEK, TEAM, MARGIN, OFFENSE, DEFENSE) %>%
                                  rename(AWAY = TEAM,
                                         AWAY_POWER = MARGIN,
                                         AWAY_OFF_POWER = OFFENSE,
                                         AWAY_DEF_POWER = DEFENSE),
                          by = c("SEASON", "WEEK", "AWAY")) %>%
                mutate(PRED_MARGIN = case_when(NEUTRAL_SITE == T ~ HOME_POWER - AWAY_POWER,
                                             NEUTRAL_SITE == F ~ 3 +HOME_POWER - AWAY_POWER)) %>%
                mutate(HOME_MARGIN = HOME_POINTS - AWAY_POINTS) %>%
                group_by(SEASON, WEEK) %>%
                mutate(HOME_PRED = factor(case_when(PRED_MARGIN > 0 ~ 'yes',
                                             TRUE ~ 'no'))) %>%
                mutate(HOME_WIN = factor(case_when(HOME_MARGIN > 0 ~ 'yes',
                                            TRUE ~ 'no'))) %>%
                group_by(SEASON, WEEK) %>%
                yardstick::accuracy(truth = HOME_WIN,
                                    estimate = HOME_PRED) %>%
                mutate_if(is.numeric, round, 3) %>%
                mutate(type = 'weighted')) %>%
                mutate(SEASON = factor(SEASON)) %>%
                spread(type, .estimate) %>%
                select(-.estimator) %>%
                group_by(SEASON, WEEK) %>%
                mutate(best= max(c_across(in_season:weighted))) %>%
        # mutate(winner = case_when(in_season > previous_season ~ 'in_season',
        #                           in_season < previous_season ~ 'previous_season',
        #                           TRUE ~ 'tie')) %>%
        flextable() %>%
        autofit()

```

Well, it improves 2016; let's take a look to see for the previous years.

## All Weekly Ratings

I'll now apply this to all weeks from 2008 to 2021, but focus on testing the previous years.

```{r weekly ratings}

# make a grid of all weeks in these seasons
week_grid = ppa_data %>%
        filter(SEASON > 2007 & SEASON < 2022) %>%
        select(SEASON, WEEK) %>%
        distinct() %>%
        arrange(WEEK)

# run through each week of each season to get rolling week by 
weekly_updates = 
        foreach(i = 1:nrow(week_grid),
        .combine = bind_rows) %do% {
                
                ppa_data %>%
                        filter(SEASON == week_grid[i,]$SEASON & WEEK <= week_grid[i,]$WEEK) %>%
                        filter(GARBAGE_TIME==0) %>%
                        mutate(YEAR = week_grid[i,]$SEASON) %>%
                        nest(-YEAR) %>%
                        rename(SEASON = YEAR) %>%
                        mutate(workflow = map(data,
                                              ~ ppa_wf %>%
                                                      fit(.x))) %>%
                        mutate(fit = map(workflow, 
                                         ~ extract_fit_parsnip(.x))) %>%
                        mutate(coefs = map(fit,
                                           ~ tidy(.x))) %>%
                        mutate(intercept = map(coefs,
                                               ~ .x %>% filter(term == '(Intercept)') %>% pull())) %>%
                        mutate(adjusted = map2(coefs, intercept,
                                               ~ .x %>% 
                                                       filter(term != '(Intercept)' & term != 'HOME_FIELD_ADVANTAGE') %>%
                                                       mutate(intercept = .y) %>%
                                                       mutate(adjusted = estimate + intercept) %>%
                                                       mutate(type = case_when(grepl("OFFENSE", term) ~ 'OFFENSE',
                                                                               grepl("DEFENSE", term) ~ 'DEFENSE')) %>%
                                                       mutate(TEAM = gsub("DEFENSE_ID_", "", gsub("OFFENSE_ID_", "", term))) %>%
                                                       select(TEAM, type, adjusted) %>%
                                                       spread(type, adjusted) %>%
                                                       mutate(DEFENSE = -DEFENSE) %>%
                                                       mutate(OVERALL = OFFENSE + DEFENSE) %>%
                                                       mutate(TYPE = 'adjusted'))) %>%
                        mutate(WEEK = week_grid[i,]$WEEK)
        }

# make a grid of all seasons, weeks, and teams
team_week_grid = expand.grid(SEASON = week_grid %>%
                                     select(SEASON) %>%
                                     distinct() %>%
                                     pull(),
                             WEEK = c(0,
                                      ppa_data %>%
                                     select(WEEK) %>%
                                     distinct %>%
                                     pull),
                             TEAM = ppa_data %>%
                                     filter(SEASON > 2007 & SEASON < 2022) %>%
                                     select(HOME, AWAY) %>%
                                     gather() %>%
                                     select(value) %>%
                                     distinct %>%
                                     pull) %>%
        arrange(SEASON, WEEK, TEAM)
        
# now join up                             
weekly_team_rankings = team_week_grid %>%
        left_join(.,
                  adjusted_team_rankings %>%
                          mutate(SEASON = SEASON+1,
                                 WEEK = 0) %>%
                        bind_rows(.,
                                weekly_updates %>%
                                        select(SEASON, WEEK, adjusted) %>%
                                        unnest(adjusted) %>%
                                        rename(TEAM_ABBR = TEAM) %>%
                                        left_join(., team_mapping,
                                                  by = c("TEAM_ABBR")) %>%
                                        select(-TEAM_ABBR) %>%
                                        select(SEASON, WEEK, TEAM, TYPE, OFFENSE, DEFENSE) %>%
                                        mutate(OVERALL = OFFENSE + DEFENSE) %>%
                                        mutate_if(is.numeric, round, 3) %>%
                                        arrange(desc(OVERALL)) %>%
                                        arrange(SEASON, WEEK)
                        ) %>%
                select(SEASON, WEEK, TEAM, OFFENSE, DEFENSE, OVERALL),
                by = c("SEASON", "WEEK", "TEAM")) %>%
        group_by(TEAM) %>%
        fill(OFFENSE, DEFENSE, OVERALL, .direction = 'down') %>%
        mutate(MARGIN = OVERALL * 65) %>%
        ungroup() %>%
        weekly_weighting_func() 
        # now address new teams 
        
weekly_team_rankings  %>%
        left_join(., team_mapping,
                  by = c("TEAM")) %>%
        left_join(.,
                  team_conference_season,
                  by = c("SEASON", "TEAM")) %>%
        group_by(TEAM, SEASON) %>%
        fill(OFFENSE, DEFENSE, OVERALL, .direction = 'down') %>%
        mutate(TEAM_LABEL = case_when(WEEK == max(WEEK) ~ ABBREVIATION)) %>%
        filter(TEAM %in% c("Texas", "Texas A&M")) %>%
       # filter(CONFERENCE %in% c("Big 12", "Big Ten")) %>%
        ungroup() %>%
        ggplot(., aes(x=WEEK,
                      label = TEAM_LABEL,
                      color = TEAM,
                      y= OFFENSE))+
        facet_wrap(SEASON ~.)+
        geom_hline(yintercept = 0,
                   linetype = 'dashed')+
        geom_point()+
        guides(color = 'none')+
        geom_line(stat = 'smooth',
                      formula = 'y ~ x',
                      method = 'loess',
                      alpha =0.85,
                      span = 0.5,
                      lwd = 1.04)+
        geom_text_repel(fontface = "bold",
                        size = 4,
                        direction = "y",
                        hjust = -1.5,
                        segment.size = .7,
                        segment.alpha = .5,
                        segment.linetype = "dotted",
                        box.padding = .4,
                        segment.curvature = -0.1,
                        segment.ncp = 3,
                        segment.angle = 20)+
        coord_cartesian(xlim = c(-0.5, 18),
                        ylim = c(-0.5, 0.5))+        
        custom_color_teams+
        theme_phil()+
        ylab("Net Team Efficiency per play")
                
```

Look at a sample of teams and games here.

```{r now look at a few teams}

weekly_team_rankings  %>%
        left_join(., team_mapping,
                  by = c("TEAM")) %>%
        left_join(.,
                  team_conference_season,
                  by = c("SEASON", "TEAM")) %>%
        group_by(TEAM) %>%
        fill(OFFENSE, DEFENSE, OVERALL, .direction = 'down') %>%
        mutate(TEAM_LABEL = case_when(WEEK == max(WEEK) ~ ABBREVIATION)) %>%
        filter(TEAM %in% c("Clemson", "Georgia",
                           "Michigan", "Baylor",
                           "Texas", "Cincinatti",
                           "Florida State",
                           "Kansas")) %>%
        ggplot(., aes(x=WEEK,
                      label = TEAM_LABEL,
                      color = TEAM,
                      y= OVERALL))+
        facet_wrap(SEASON ~.)+
        geom_hline(yintercept = 0,
                   linetype = 'dashed')+
       # geom_point()+
        guides(color = 'none')+
        geom_line(stat = 'smooth',
                      formula = 'y ~ x',
                      method = 'loess',
                      alpha =0.85,
                      span = 0.5,
                      lwd = 1.04)+
        geom_text_repel(fontface = "bold",
                        size = 4,
                        direction = "y",
                        hjust = -1.5,
                        segment.size = .7,
                        segment.alpha = .5,
                        segment.linetype = "dotted",
                        box.padding = .4,
                        segment.curvature = -0.1,
                        segment.ncp = 3,
                        segment.angle = 20)+
        coord_cartesian(xlim = c(-0.5, 18),
                        ylim = c(-0.55, 0.55))+
        custom_color_teams+
        theme_phil()+
        ylab("Net Team Efficiency per play")

```

```{r compute raw by week}

raw_weekly_team_rankings = bind_rows(scored_train,
          scored_valid,
          scored_test) %>%
        filter(GARBAGE_TIME == 0) %>%
        group_by(SEASON, OFFENSE_ID) %>%
        summarize(OFFENSE = mean(PPA, na.rm=T),
                  .groups = 'drop') %>%
        mutate(TEAM = gsub(" ", "\\.", gsub("[[:punct:]]", "\\.", OFFENSE_ID))) %>%
        mutate(TYPE = 'raw') %>%
        select(SEASON, TEAM, TYPE, OFFENSE) %>%
        left_join(.,
                  bind_rows(scored_train,
                            scored_valid,
                            scored_test) %>%
                          filter(GARBAGE_TIME == 0) %>%
                        group_by(SEASON, DEFENSE_ID) %>%
                        summarize(DEFENSE = mean(PPA, na.rm=T),
                                  .groups = 'drop') %>%
                          mutate(TEAM = gsub(" ", "\\.", gsub("[[:punct:]]", "\\.", DEFENSE_ID))) %>%
                        mutate(TYPE = 'raw') %>%
                        select(SEASON, TEAM, TYPE, DEFENSE) %>%
                          mutate(DEFENSE = -DEFENSE),
                  by = c("SEASON", "TEAM", "TYPE")) %>%
        mutate(OVERALL = OFFENSE + DEFENSE) %>%
        mutate(MARGIN = OVERALL * 65) %>%
        mutate_if(is.numeric, round, 3) %>%
        arrange(desc(MARGIN)) %>%
        rename(TEAM_ABBR = TEAM) %>%
        left_join(., team_mapping,
                  by = c("TEAM_ABBR")) %>%
        select(-TEAM_ABBR) %>%
        mutate(TYPE = 'raw') %>%
        select(SEASON, TEAM, TYPE, OFFENSE, DEFENSE, OVERALL, MARGIN)

```


```{r get raw weekly ratings}

raw_weekly_team_rankings = bind_rows(scored_train,
          scored_valid,
          scored_test) %>%
        filter(GARBAGE_TIME == 0) %>%
        group_by(SEASON, GAME_ID, WEEK, OFFENSE_ID) %>%
        summarize(OFFENSE = mean(PPA, na.rm=T),
                  .groups = 'drop') %>%
        mutate(TEAM = gsub(" ", "\\.", gsub("[[:punct:]]", "\\.", OFFENSE_ID))) %>%
        mutate(TYPE = 'raw') %>%
        select(SEASON, GAME_ID, WEEK, TEAM, TYPE, OFFENSE) %>%
        left_join(.,
                  bind_rows(scored_train,
                            scored_valid,
                            scored_test) %>%
                          filter(GARBAGE_TIME == 0) %>%
                        group_by(SEASON, GAME_ID, WEEK, DEFENSE_ID) %>%
                        summarize(DEFENSE = mean(PPA, na.rm=T),
                                  .groups = 'drop') %>%
                          mutate(TEAM = gsub(" ", "\\.", gsub("[[:punct:]]", "\\.", DEFENSE_ID))) %>%
                        mutate(TYPE = 'raw') %>%
                        select(SEASON, GAME_ID, WEEK, TEAM, TYPE, DEFENSE) %>%
                          mutate(DEFENSE = -DEFENSE),
                  by = c("SEASON", "GAME_ID", "WEEK", "TEAM", "TYPE")) %>%
        mutate(OVERALL = OFFENSE + DEFENSE) %>%
        mutate_if(is.numeric, round, 3) %>%
        rename(TEAM_ABBR = TEAM) %>%
        left_join(., team_mapping,
                  by = c("TEAM_ABBR")) %>%
        select(-TEAM_ABBR) %>%
        mutate(TYPE = 'raw') %>%
        select(SEASON, GAME_ID, WEEK, TEAM, TYPE, OFFENSE, DEFENSE, OVERALL)

```

```{r adjusted team weekly rankings}

adjusted_weekly_team_rankings = weekly_team_rankings %>%
        mutate(TYPE = 'adjusted') %>%
        left_join(.,
                  raw_weekly_team_rankings %>%
                          select(SEASON, GAME_ID, TEAM, WEEK),
                  by = c("SEASON", "TEAM", "WEEK")) %>%
        select(SEASON, GAME_ID, WEEK, TEAM, TYPE, OFFENSE, DEFENSE, OVERALL) %>%
        mutate_if(is.numeric, round, 3)

```

```{r save the weekly ratings}

weekly_team_rankings = bind_rows(raw_weekly_team_rankings,
                                 adjusted_weekly_team_rankings)

save(weekly_team_rankings,
     file = here::here("data", "weekly_team_rankings.Rdata"))

```

```{r raw by type}

raw_weekly_team_rankings_type = bind_rows(scored_train,
          scored_valid,
          scored_test) %>%
        filter(PLAY_CATEGORY != 'SPECIAL') %>%
        filter(GARBAGE_TIME == 0) %>%
        group_by(SEASON, GAME_ID, PLAY_CATEGORY, WEEK, OFFENSE_ID) %>%
        summarize(OFFENSE = mean(PPA, na.rm=T),
                  .groups = 'drop') %>%
        mutate(TEAM = gsub(" ", "\\.", gsub("[[:punct:]]", "\\.", OFFENSE_ID))) %>%
        mutate(TYPE = 'raw') %>%
        select(SEASON, GAME_ID, WEEK, TEAM, PLAY_CATEGORY, TYPE, OFFENSE) %>%
        left_join(.,
                  bind_rows(scored_train,
                            scored_valid,
                            scored_test) %>%                     
                                  filter(PLAY_CATEGORY != 'SPECIAL') %>%
                          filter(GARBAGE_TIME == 0) %>%
                        group_by(SEASON, GAME_ID, PLAY_CATEGORY, WEEK, DEFENSE_ID) %>%
                        summarize(DEFENSE = mean(PPA, na.rm=T),
                                  .groups = 'drop') %>%
                          mutate(TEAM = gsub(" ", "\\.", gsub("[[:punct:]]", "\\.", DEFENSE_ID))) %>%
                        mutate(TYPE = 'raw') %>%
                        select(SEASON, GAME_ID, WEEK, TEAM, PLAY_CATEGORY, TYPE, DEFENSE) %>%
                          mutate(DEFENSE = -DEFENSE),
                  by = c("SEASON", "GAME_ID", "WEEK", "TEAM", "TYPE", "PLAY_CATEGORY")) %>%
    #    mutate(OVERALL = OFFENSE + DEFENSE) %>%
        mutate_if(is.numeric, round, 3) %>%
        rename(TEAM_ABBR = TEAM) %>%
        left_join(., team_mapping,
                  by = c("TEAM_ABBR")) %>%
        select(-TEAM_ABBR) %>%
        mutate(TYPE = 'raw') %>%
        select(SEASON, GAME_ID, WEEK, TEAM, TYPE, PLAY_CATEGORY, OFFENSE, DEFENSE) %>%
        pivot_wider(id_cols = c("SEASON", "GAME_ID", "WEEK", "TEAM", "TYPE"),
                    names_from = c("PLAY_CATEGORY"),
                    values_from = c("OFFENSE", "DEFENSE"))

save(raw_weekly_team_rankings_type,
     file = here::here("data", "weekly_team_rankings_type.Rdata"))

```

