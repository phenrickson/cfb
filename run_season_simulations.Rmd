---
title: "Simulating the `r params$input_season` CFB Season"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: TRUE #adds a Table of Contents
    theme: cerulean
    number_sections: TRUE #number your headings/sections
    toc_float: TRUE #let your ToC follow you as you scroll
    keep_md: no
    fig.caption: yes
params:
        input_season: 2022
        sim_week: 7
        nsims: 1000
---

```{r setup, include=F}

knitr::opts_chunk$set(echo = F,
                      error = F,
                      warning=F,
                      dev="png",
                      fig.width = 10,
                      fig.height = 6)
options(knitr.duplicate.label = "allow")
options(scipen=999)

```

```{r packages, include=F}

source(here::here("scripts/load_packages.R"))
library(jsonlite)
library(forcats)
library(TTR)
library(flextable)
conflict_prefer("lag", "dplyr")

# parallelization
library(future.apply)
library(furrr)
plan(multisession, workers = 7)

set_flextable_defaults(theme_fun = theme_alafoli,
                       font.color = "grey10",
                       font.size=10,
                       padding.bottom = 6, 
                       padding.top = 6,
                       padding.left = 6,
                       padding.right = 6,
                       background.color = "white")
```

```{r connect to snowflake}

library(DBI)
library(odbc)
library(RODBC)
library(keyring)

### connect to DBS
# connect to snowflake
myconn <- DBI::dbConnect(odbc::odbc(),
                         "SnowflakeDSII",
                         Database = "CFB_DEMO",
                         warehouse = "DEMO_WH",
                         uid="phil.henrickson",
                         pwd=keyring::key_get("AE_Snowflake"))

```

```{r functions and colors}

### functions
source(here::here("functions/get_expected_score.R"))
source(here::here("functions/get_new_elos.R"))
source(here::here("functions/calc_elo_ratings.R"))
source(here::here("functions", "simulateX.R"))
source(here::here("functions", "sim_game_margin.R"))
source(here::here("functions", "calc_elo_ratings.R"))
source(here::here("functions", "sim_elo_ratings.R"))
source(here::here("functions", "sim_rest_of_season.R"))
source(here::here("functions", "theme_phil.R"))
source(here::here("functions", "span_func.R"))
source(here::here("functions", "get_conference_championships.R"))
source(here::here("functions", "get_playoffs.R"))

# color palettes
load(here::here("data", "team_colors.Rdata"))
custom_color_teams <- scale_colour_manual(name = "TEAM", values = team_colors)
custom_fill_teams <- scale_fill_manual(name = "TEAM", values = team_colors)

```

```{r data sources}

### get data sources
# teams raw
teams_raw = DBI::dbGetQuery(myconn,
                            paste('SELECT * FROM CFB_DEMO.CFD_RAW.TEAMS')) %>%
        as_tibble() %>%
        rename(TEAM = SCHOOL,
               TEAM_ID = ID,
               TEAM_MASCOT = MASCOT,
               TEAM_ABBREVIATION = ABBREVIATION)

# get games
games_raw = DBI::dbGetQuery(myconn,
                            paste('SELECT * FROM CFB_DEMO.CFD_RAW.ANALYSIS_GAMES')) %>%
        as_tibble() %>%
        mutate(CONFERENCE_GAME = case_when(CONFERENCE_GAME == 'true' ~ T,
                                           CONFERENCE_GAME == 'false' ~ F)) %>%
        mutate(GAME_DATE = as.Date(START_DATE)) %>%
        mutate(START_DATE = as_datetime(START_DATE)) %>%
        arrange(START_DATE) %>%
        # logic for flagging conference championship games
        group_by(SEASON, SEASON_TYPE, HOME_CONFERENCE) %>%
        mutate(LAST_GAME = START_DATE == max(START_DATE)) %>% 
        ungroup() %>%
        mutate(CONFERENCE_CHAMPIONSHIP = case_when(CONFERENCE_GAME == T & 
                                                           (HOME_CONFERENCE != 'FBS Independents') & 
                                                           (HOME_CONFERENCE != 'FCS Independents') &
                                                           !(HOME_CONFERENCE %in% 'Big Ten' & SEASON < 2014) &
                                                           !(HOME_CONFERENCE %in% 'Western Athletic') &
                                                           (NEUTRAL_SITE == T | 
                                                                    is.na(VENUE) |
                                                                    VENUE == 'Glass Bowl' |
                                                                    VENUE == 'Bright House Networks Stadium' |
                                                                    VENUE == 'Alamodome' |
                                                                    VENUE == 'Georgia Dome' |
                                                                    HOME_CONFERENCE == 'Sun Belt' |
                                                                    HOME_CONFERENCE == 'American Athletic') &
                                                           SEASON > 2000 &
                                                           SEASON_TYPE == 'regular' &
                                                           WEEK > 13 &
                                                           LAST_GAME == T ~ T,
                                                   TRUE ~ F)) %>%
        mutate(HOME_WIN = factor(case_when(HOME_POINTS > AWAY_POINTS ~ 'yes',
                                           HOME_POINTS < AWAY_POINTS ~ 'no',
                                           HOME_POINTS == AWAY_POINTS ~ 'no'),
                                 levels = c("no", "yes"))) %>%
        mutate(HOME_DIVISION  = replace_na(HOME_DIVISION, "missing"),
               AWAY_DIVISION = replace_na(AWAY_DIVISION, "missing")) %>%
        left_join(., teams_raw %>%
                          select(TEAM, TEAM_ABBREVIATION) %>%
                          rename(HOME_TEAM = TEAM,
                                 HOME_TEAM_ABBR = TEAM_ABBREVIATION),
                  by = c("HOME_TEAM")) %>%
        left_join(., teams_raw %>%
                          select(TEAM, TEAM_ABBREVIATION) %>%
                          rename(AWAY_TEAM = TEAM,
                                 AWAY_TEAM_ABBR = TEAM_ABBREVIATION),
                  by = c("AWAY_TEAM"))

# get team conference mapping
team_conference_season = DBI::dbGetQuery(myconn,
                                         paste('SELECT * FROM CFB_DEMO.CFD_RAW.ANALYSIS_TEAM_CONFERENCE_SEASON')) %>%
        as_tibble()

# team mapping function
team_mapping = teams_raw %>%
        mutate(TEAM_ABBR = gsub(" ", "\\.", gsub("[[:punct:]]", "\\.", TEAM))) %>%
        select(TEAM, TEAM_ABBR, TEAM_ABBREVIATION, COLOR, ALT_COLOR) %>%
        mutate(COLOR = case_when(TEAM == 'Toledo' ~ '#003E7E',
                                 TRUE ~ COLOR))

### get historical elo
# games
elo_games = DBI::dbGetQuery(myconn,
                            paste('SELECT * FROM CFB_DEMO.CFD_ANALYTICS.ACTIVE_ELO_GAMES')) %>%
        as_tibble()

# teams
elo_teams = DBI::dbGetQuery(myconn,
                            paste('SELECT * FROM CFB_DEMO.CFD_ANALYTICS.ACTIVE_ELO_TEAMS')) %>%
        as_tibble() %>%
        select(-LOAD_DATE)

### recruiting 
recruiting_teams_raw = DBI::dbGetQuery(myconn,
                                       paste('SELECT * FROM CFB_DEMO.CFD_RAW.RECRUITING_TEAMS ')) %>%
        as_tibble() %>%
        mutate(POINTS = as.numeric(POINTS)) %>%
        rename(RECRUITING_POINTS = POINTS)

# expand
recruiting_teams = expand.grid(TEAM = unique(recruiting_teams_raw$TEAM),
                               YEAR = seq(min(recruiting_teams_raw$YEAR),
                                          max(recruiting_teams_raw$YEAR))) %>%
        left_join(., recruiting_teams_raw,
                  by = c("YEAR", "TEAM")) %>%
        mutate(RECRUITING_POINTS = replace_na(RECRUITING_POINTS, 0)) %>%
        filter(YEAR > 2001) %>%
        left_join(., team_conference_season,
                  by = c("YEAR"="SEASON", "TEAM")) %>%
        filter(DIVISION == 'fbs') %>%
        group_by(TEAM) %>%
        mutate(n = n()) %>%
        filter(n > 4) %>%
        group_by(TEAM) %>%
        select(-n) %>%
        mutate(EMA = EMA(RECRUITING_POINTS, n =4)) %>%
        # now fill with actual in the event that a team doesn't have yet have enough data
        mutate(EMA = case_when(is.na(EMA) & !is.na(RECRUITING_POINTS) ~ RECRUITING_POINTS,
                               TRUE ~ EMA)) %>%
        # mutate_at(c("EMA", "WMA"),
        #           replace_na, 0) %>%
        arrange(TEAM, YEAR)  %>%
        mutate(SEASON = YEAR) %>%
        ungroup() %>%
        select(TEAM, SEASON, CONFERENCE, DIVISION, RANK, RECRUITING_POINTS, EMA)

# get what we need
recruiting = recruiting_teams %>%
        select(TEAM, SEASON, CONFERENCE, RECRUITING_POINTS, EMA) %>%
        rename(RECRUITING_SCORE = EMA)

### efficiency
# season level efficiency rankings
season_team_rankings = DBI::dbGetQuery(myconn,
                                       paste('SELECT * FROM CFB_DEMO.CFD_ANALYTICS.EFFICIENCY_TEAM_SEASON')) %>%
        as_tibble()

# team rankings by play type
load(file=here::here("data", "season_team_rankings_type.Rdata"))

```

```{r clean up games}

# run script to clean games
source(here::here("scripts", "clean_games_2022.R"), local=T)

```

```{r functions for turning elo to list}

## functions for converting elo to list from specified year
teams_to_list = function(x) {
        
        setNames(unlist(x$ELO) %>%
                         split(., seq(nrow(x))),
                 rownames(x))
}

team_seasons_to_list = function(x) {
        
        setNames(unlist(x$SEASON) %>%
                         split(., seq(nrow(x))),
                 rownames(x))
}

```

```{r conference divisions}

# set up conference divisions
load(here::here("data", "season_conference_divisions.Rdata"))

# for this season
conference_divisions = season_conference_divisions %>%
        filter(SEASON == params$input_season)

```

```{r create data for simulating, include=F}

# season
future_seasons = expand.grid(TEAM = season_team_rankings  %>%
                                     select(TEAM) %>%
                                     distinct(TEAM) %>%
                                     pull(),
                             TYPE = c('raw', 'adjusted'),
                             SEASON = params$input_season) %>%
        as_tibble()

# get efficiency and elo for historical + future season
teams_data = season_team_rankings %>%
        filter(SEASON < params$input_season) %>%
        bind_rows(., future_seasons) %>%
        filter(TYPE == 'adjusted') %>%
        select(-TYPE) %>%
        # add in season end elo ratings
        left_join(.,
                  elo_teams %>%
                          group_by(SEASON, TEAM) %>%
                          arrange(GAME_DATE) %>%
                          mutate(WEEK = row_number()) %>%
                          mutate(LAST_GAME = GAME_DATE == max(GAME_DATE)) %>%
                          filter(LAST_GAME ==T) %>%
                          select(SEASON, TEAM, POSTGAME_ELO) %>%
                          rename(ELO = POSTGAME_ELO),
                  by = c("SEASON", "TEAM")) %>%
        # add in season recruiting data
        left_join(., 
                  recruiting %>%
                          select(TEAM, SEASON, RECRUITING_SCORE),
                  by = c("SEASON", "TEAM")) %>%
        arrange(SEASON, TEAM) %>%
        group_by(TEAM) %>%
        mutate(PREVIOUS_OVERALL = lag(OVERALL, 1),
               PREVIOUS_OFFENSE = lag(OFFENSE, 1),
               PREVIOUS_DEFENSE = lag(DEFENSE, 1),
               PREVIOUS_ELO = lag(ELO, 1)) %>%
        ungroup() %>%
        filter(SEASON > 2007)


# split into training and test
teams_train  = teams_data %>%
        filter(SEASON < params$input_season)

teams_test = teams_data %>%
        filter(SEASON == params$input_season)

# create recipe
teams_recipe =      
        recipe(ELO ~.,
               data = teams_train) %>%
        update_role(all_predictors(),
                    new_role = "id") %>%
        update_role(PREVIOUS_OFFENSE,
                    PREVIOUS_DEFENSE,
                    PREVIOUS_ELO,
                    RECRUITING_SCORE,
                    new_role = 'predictor') %>%
        # manual missingness
        step_mutate(RECRUITING_SCORE = replace_na(RECRUITING_SCORE, 0),
                    PREVIOUS_ELO = replace_na(PREVIOUS_ELO, 1200),
                    PREVIOUS_OFFENSE = replace_na(PREVIOUS_OFFENSE,-0.1),
                    PREVIOUS_DEFENSE = replace_na(PREVIOUS_DEFENSE, -0.1)) %>%
        step_normalize(all_predictors())

# linear model
lm_mod = linear_reg(mode = "regression",
                    engine = "lm")

# create workflow
teams_workflow = workflow() %>%
        add_recipe(teams_recipe) %>%
        add_model(lm_mod)

# run workflow
adjusted_teams_test = 
        teams_workflow %>%
        fit(bind_rows(teams_train)) %>%
        augment(bind_rows(teams_test %>%
                                  mutate(dataset = 'test'))) %>%
        select(SEASON, dataset, TEAM, starts_with("PREVIOUS"),
               ELO, .pred) %>%
        mutate_if(is.numeric, round, 3)

# set season to simulate
# set initial games
initial_games = games %>%
        filter(SEASON < params$input_season)

# elo pars
elo_pars = tibble(k = 35,
                  v = 400,
                  reversion = 0,
                  home_field_advantage = 75,
                  recruiting_weight =0)

# train points model
points_model = elo_games %>%
        filter(SEASON >=1970) %>% 
        filter(SEASON < params$input_season) %>%
        mutate(HOME_ELO_DIFF = case_when(NEUTRAL_SITE == F ~ 
                                                 HOME_PREGAME_ELO + 
                                                 elo_pars$home_field_advantage -
                                                 AWAY_PREGAME_ELO,
                                         TRUE ~ HOME_PREGAME_ELO - AWAY_PREGAME_ELO)) %>%
        mutate(HOME_SCORE_DIFF = HOME_POINTS-AWAY_POINTS) %>%
        nest() %>%
        # now fit linear models, i'll do so using stan
        mutate(lm = map(data, ~ lm(HOME_SCORE_DIFF ~ HOME_ELO_DIFF +0,
                                   data = .x))) %>%
        pluck("lm",1)

```

```{r workflow and set up}

# base elo, from historical games
base_teams_elo = elo_teams %>%
        filter(SEASON < params$input_season) %>%
        group_by(TEAM) %>%
        filter(GAME_DATE == max(GAME_DATE)) %>%
        slice_max(POSTGAME_ELO, n=1, with_ties = F) %>%
        ungroup() %>%
        select(TEAM, POSTGAME_ELO) %>%
        rename(ELO = POSTGAME_ELO) %>%
        column_to_rownames("TEAM")

# now adjusted
# get computed elo as input
adjusted_teams_elo = adjusted_teams_test %>%
        filter(SEASON == params$input_season) %>%
        select(TEAM, .pred) %>%
        rename(ELO = .pred) %>%
        column_to_rownames("TEAM")

# get team seasons
team_elo_seasons = elo_teams %>%
        filter(SEASON < params$input_season) %>%
        group_by(TEAM) %>%
        slice_max(., order_by = SEASON, n=1, with_ties =F) %>%
        ungroup() %>%
        select(TEAM, SEASON) %>%
        column_to_rownames("TEAM")

# convert to list
base_teams = teams_to_list(base_teams_elo)
adjusted_teams = teams_to_list(adjusted_teams_elo)
team_seasons = team_seasons_to_list(team_elo_seasons)

# get elo input
elo_input = list(teams = c(adjusted_teams,
                           base_teams[!(names(base_teams) %in% names(adjusted_teams))]),
                         team_seasons = team_seasons)
        

# rm
# rm(base_teams_elo,
#    adjusted_teams_elo,
#    adjusted_teams_test,
#    recruiting_teams_raw,
#    recruiting_teams,
#    recruiting,
#    initial_games,
#    elo_games,
#    elo_teams,
#    teams_test,
#    teams_train,
#    teams_recipe,
#    teams_workflow,
#    teams_raw,
#    future_seasons)

```

# What is this? {.unnumbered}

Which teams are most likely to win their conference in `r params$input_season`? Make the playoff? Win the national championship?

This page displays results from simulating the remaining games in the `r params$input_season` college football season after each week of the regular season. The model is built on historical college football play by play and game data in order to simulate upcoming games for all teams. All data is from collegefootballdata.com.

```{r get week set up}

# get maximum week
max_week = max(games %>%
                       filter(SEASON == params$input_season) %>%
                       filter(SEASON_TYPE == 'regular') %>%
                       pull(WEEK))

# get all weeks
season_weeks = games %>%
        filter(SEASON_TYPE == 'regular') %>%
        filter(CONFERENCE_CHAMPIONSHIP == F) %>%
        filter(SEASON == params$input_season) %>%
        arrange(START_DATE) %>%
        distinct(SEASON, SEASON_TYPE, WEEK) %>%
        group_by(SEASON) %>%
        mutate(WEEK_NUM = row_number()) %>%
        mutate(PREVIOUS_WEEK = dplyr::lag(WEEK, 1, 0)) %>%
        ungroup()

# make empty grid for all teams
season_weeks_teams = expand.grid(SEASON = unique(season_weeks$SEASON),
                                 WEEK = c(0, unique(season_weeks$WEEK)),
                                 TEAM = unique(c(games %>% 
                                                         filter(SEASON == params$input_season) %>%
                                                         filter(SEASON_TYPE == 'regular') %>%
                                                         filter(CONFERENCE_CHAMPIONSHIP == F) %>%
                                                         pull(HOME_TEAM),
                                                 games %>% 
                                                         filter(SEASON == params$input_season) %>%
                                                         filter(SEASON_TYPE == 'regular') %>%
                                                         filter(CONFERENCE_CHAMPIONSHIP == F) %>%
                                                         pull(HOME_TEAM))))

# specify types of conferences to determine logic for championships
# division tiebreaker
conferences_with_divisions = conference_divisions %>%
        filter(!is.na(CONFERENCE_DIVISION)) %>%
        filter(CONFERENCE != 'FBS Independents') %>%
        pull(CONFERENCE) %>%
        unique()

# win percentage
conferences_without_divisions = conference_divisions %>%
        filter(is.na(CONFERENCE_DIVISION)) %>%
        filter(CONFERENCE != 'FBS Independents') %>%
        pull(CONFERENCE) %>%
        unique()

# conference championship games to be played, fill out in each season
conference_championship_games = 
        expand.grid(CONFERENCE = conferences_without_divisions,
                    CONFERENCE_DIVISION = c("1", "2")) %>%
        arrange(CONFERENCE) %>%
        bind_rows(.,
                  conference_divisions %>%
                          filter(!is.na(CONFERENCE_DIVISION)) %>%
                          filter(CONFERENCE != 'FBS Independents') %>% 
                          select(CONFERENCE, CONFERENCE_DIVISION) %>% distinct() 
        ) %>%
        group_by(CONFERENCE) %>%
        mutate(MATCHUP = row_number()) %>%
        ungroup() %>%
        mutate(MATCHUP = case_when(MATCHUP == 1 ~ 'HOME',
                                   MATCHUP == 2 ~ 'AWAY'))

```

```{r compute elo so far, include=F}

# get elo to date
if (params$sim_week == 0) {
        
        # if no games have been played in the season, our input is just our adjusted ratings for the function
        elo_input = list(teams = c(adjusted_teams,
                           base_teams[!(names(base_teams) %in% names(adjusted_teams))]),
                         team_seasons = team_seasons)
        
        # then, the elo for each team so far is that adjustment, which we'll flip to a df
        team_elo_so_far =  do.call(rbind,
                                   c(adjusted_teams,
                                     base_teams[!(names(base_teams) %in% names(adjusted_teams))])) %>% 
                as.data.frame() %>% 
                rownames_to_column("TEAM") %>%
                rename(RATING = V1) %>% 
                mutate(SEASON = params$input_season) %>%
                mutate(WEEK = 0)
        
        # and we'll make an empty dataframe for games
        games_so_far = tibble(WEEK = params$sim_week)
} else 
        {
                # calculate elo
                elo_input = calc_elo_ratings(games %>%
                                                       filter(SEASON == params$input_season) %>%
                                                       filter(WEEK <= params$sim_week & !is.na(HOME_POINTS)),
                                               teams = elo_input$teams,
                                               team_seasons = elo_input$teams,
                                               reversion = elo_pars$reversion,
                                               k = elo_pars$k,
                                               v = elo_pars$v,
                                               home_field_advantage = elo_pars$home_field_advantage)
                
                # get team ratings
                team_elo_so_far =  elo_input$team_outcomes %>%
                                            rename(RATING = POSTGAME_ELO) %>%
                                            select(SEASON, WEEK, TEAM, RATING) %>%
                                            bind_rows(.,
                                                      do.call(rbind,
                                                              c(adjusted_teams,
                                                                base_teams[!(names(base_teams) %in% names(adjusted_teams))])) %>% 
                                                              as.data.frame() %>% 
                                                              rownames_to_column("TEAM") %>%
                                                              rename(RATING = V1) %>% 
                                                              mutate(SEASON = params$input_season) %>%
                                                              mutate(WEEK = 0))
                
                # get games
                games_so_far = elo_input %$%
                        team_outcomes %>%
                        left_join(.,
                                  conference_divisions,
                                  by = c("SEASON", "TEAM", "CONFERENCE")) %>%
                        left_join(.,
                                  conference_divisions %>%
                                          rename(OPPONENT = TEAM,
                                                 OPPONENT_CONFERENCE = CONFERENCE,
                                                 OPPONENT_CONFERENCE_DIVISION = CONFERENCE_DIVISION),
                                  by = c("SEASON", "OPPONENT")) %>%
                        mutate(CONFERENCE_GAME = case_when(CONFERENCE == OPPONENT_CONFERENCE ~ T,
                                                           TRUE ~ F),
                               CONFERENCE_DIVISION_GAME = case_when(CONFERENCE == OPPONENT_CONFERENCE & CONFERENCE_DIVISION == OPPONENT_CONFERENCE_DIVISION ~ T,
                                                                    CONFERENCE == OPPONENT_CONFERENCE & 
                                                                            ((is.na(CONFERENCE_DIVISION) & is.na(OPPONENT_CONFERENCE_DIVISION))) ~ T,
                                                                    TRUE ~ F)) %>%
                        select(-home_field_advantage, -reversion, -k, -v)
                
        }

```

```{r simulate from each week, include=F}

# simulate rest of regular season from starting week
set.seed(52)
season_simulations = sim_rest_of_season(games,
                                           season = params$input_season,
                                           elo_initial = elo_input,
                                           elo_pars = elo_pars,
                                           nsims = params$nsims,
                                           sim_start_week = params$sim_week,
                                           season_start_only = T,
                                           aggregate = F,
                                           points_model = points_model)

```


```{r now conference championships, include=F}

### simulate conference championships and playoff
# applies conference championship tiebreakers
# determines playoff priority
# simulates playoffs 
# simulates national championship

set.seed(52)
# get simulated outcomes for remaining games
sim_remaining_games  = 
        season_simulations %$% 
        team_outcomes %>%
        left_join(.,
                  conference_divisions,
                  by = c("SEASON", "TEAM", "CONFERENCE")) %>%
        left_join(.,
                  conference_divisions %>%
                          rename(OPPONENT = TEAM,
                                 OPPONENT_CONFERENCE = CONFERENCE,
                                 OPPONENT_CONFERENCE_DIVISION = CONFERENCE_DIVISION),
                  by = c("SEASON", "OPPONENT")) %>%
        mutate(CONFERENCE_GAME = case_when(CONFERENCE == OPPONENT_CONFERENCE ~ T,
                                           TRUE ~ F),
               CONFERENCE_DIVISION_GAME = case_when(
                       CONFERENCE == OPPONENT_CONFERENCE & CONFERENCE_DIVISION == OPPONENT_CONFERENCE_DIVISION ~ T,
                       CONFERENCE == OPPONENT_CONFERENCE & ((is.na(CONFERENCE_DIVISION) & is.na(OPPONENT_CONFERENCE_DIVISION))) ~ T,
                       TRUE ~ F)) %>%
        group_by(SEASON, TEAM, SIM_FROM_WEEK) %>%
        mutate(SIM_FROM_DATE = min(GAME_DATE)) %>%
        ungroup() %>%
        select(-home_field_advantage, -reversion, -k, -v)

### conference championships
# get conferece championship matchups for each simulation
set.seed(13)
conference_championship_matchups = sim_remaining_games %>%
        mutate(type = 'sim') %>%
        nest(-.id, -SIM_FROM_WEEK) %>%
        mutate(data = future_map2(data,
                                  SIM_FROM_WEEK,
                                  ~ .x %>%
                                          rename(OUTCOME = SIM_OUTCOME,
                                                 MARGIN = SIM_MARGIN) %>%
                                          bind_rows(.,
                                                    games_so_far %>%
                                                            mutate(type = 'actual') %>%
                                                            filter(WEEK <= .y)))) %>%
        mutate(conference_championships = future_map(data,
                                                     ~ get_conference_championships(input_team_season = .x,
                                                                                    conference_championship_games = conference_championship_games,
                                                                                    conferences_with_divisions = conferences_with_divisions,
                                                                                    conferences_without_divisions = conferences_without_divisions
                                                                                    ))) %>%
        select(.id, SIM_FROM_WEEK, conference_championships) %>%
        unnest()

# simulate the results of each conference championship matchup
set.seed(13)
sim_conference_championships = 
        conference_championship_matchups %>%
        pivot_wider(id_cols = c(".id", "SIM_FROM_WEEK", "SEASON", "CONFERENCE"),
                    names_from = c("MATCHUP"),
                    values_from = c("CONFERENCE_DIVISION", "TEAM", "PREGAME_ELO")) %>%
        mutate(SEASON_TYPE = 'conference_championship') %>%
        nest(-.id, -SIM_FROM_WEEK, -CONFERENCE, -SEASON, -SEASON_TYPE) %>%
        mutate(result =  future_map(data, ~ sim_game_margin(home_rating = .x$PREGAME_ELO_HOME,
                                                            away_rating = .x$PREGAME_ELO_AWAY,
                                                            points_model) %>%
                                            as_tibble() %>%
                                            rename(HOME_SIM_MARGIN = value) %>%
                                            bind_cols(.x, .) %>%
                                            mutate(HOME_SIM_MARGIN = case_when(HOME_SIM_MARGIN == 0 ~ sample(c(-1, 1), 1),
                                                                               TRUE ~ HOME_SIM_MARGIN)) %>%
                                            mutate(WINNER= case_when(HOME_SIM_MARGIN > 0 ~ TEAM_HOME,
                                                                     HOME_SIM_MARGIN <0 ~ TEAM_AWAY),
                                                   RUNNER_UP = case_when(HOME_SIM_MARGIN >= 0 ~ TEAM_AWAY,
                                                                         HOME_SIM_MARGIN <0 ~ TEAM_HOME)))) %>%
        mutate(update = future_map2(data, result, ~ get_new_elos(home_rating = .x$PREGAME_ELO_HOME,
                                                                 away_rating = .x$PREGAME_ELO_AWAY,
                                                                 home_field_advantage = 0,
                                                                 home_margin = .y$HOME_SIM_MARGIN,
                                                                 k = elo_pars$k,
                                                                 v = elo_pars$v) %>%
                                            t() %>%
                                            as_tibble() %>%
                                            set_names(c("HOME_POSTGAME_ELO",
                                                        "AWAY_POSTGAME_ELO",
                                                        "HOME_EXPECTED_SCORE",
                                                        "AWAY_EXPECTED_SCORE")))) %>%
        select(.id, SIM_FROM_WEEK, SEASON, SEASON_TYPE, CONFERENCE, data, result, update) %>%
        unnest() %>%
        ungroup() %>%
        mutate(CONFERENCE_HOME = CONFERENCE,
               CONFERENCE_AWAY = CONFERENCE) %>%
        select(.id, 
               SIM_FROM_WEEK,
               SEASON, 
               SEASON_TYPE,
               CONFERENCE_HOME, 
               CONFERENCE_AWAY, 
               TEAM_HOME, 
               TEAM_AWAY, 
               PREGAME_ELO_HOME,
               PREGAME_ELO_AWAY,
               HOME_POSTGAME_ELO, 
               AWAY_POSTGAME_ELO,
               HOME_SIM_MARGIN, 
               WINNER,
               RUNNER_UP) %>%
        rename(HOME_TEAM = TEAM_HOME,
               AWAY_TEAM = TEAM_AWAY,
               HOME_PREGAME_ELO = PREGAME_ELO_HOME,
               AWAY_PREGAME_ELO = PREGAME_ELO_AWAY,
               HOME_SIM_MARGIN = HOME_SIM_MARGIN,
               HOME_CONFERENCE = CONFERENCE_HOME,
               AWAY_CONFERENCE = CONFERENCE_AWAY) %>%
        mutate(AWAY_SIM_MARGIN = -HOME_SIM_MARGIN) %>%
        mutate(WEEK = max_week + 1) %>%
        select(.id, 
               SIM_FROM_WEEK,
               SEASON, HOME_CONFERENCE, AWAY_CONFERENCE, SEASON_TYPE, WEEK, HOME_TEAM, AWAY_TEAM, HOME_SIM_MARGIN, AWAY_SIM_MARGIN, HOME_PREGAME_ELO, AWAY_PREGAME_ELO, HOME_POSTGAME_ELO, AWAY_POSTGAME_ELO)  %>%
        mutate(HOME_SIM_OUTCOME = case_when(HOME_SIM_MARGIN > 0 ~ 'win',
                                            HOME_SIM_MARGIN < 0 ~ 'loss'),
               AWAY_SIM_OUTCOME = case_when(HOME_SIM_MARGIN > 0 ~ 'loss',
                                            HOME_SIM_MARGIN < 0 ~ 'win'))

# flip to team level for analysis
set.seed(13)
sim_conference_championship_games = sim_conference_championships %>%
        select(.id, 
               SEASON,
               SEASON_TYPE,
               SIM_FROM_WEEK,
               WEEK,
               HOME_TEAM,
               HOME_CONFERENCE,
               HOME_SIM_MARGIN,
               HOME_SIM_OUTCOME,
               HOME_PREGAME_ELO,
               HOME_POSTGAME_ELO,
               AWAY_PREGAME_ELO,
               AWAY_POSTGAME_ELO,
               AWAY_TEAM) %>%
        rename(OPPONENT = AWAY_TEAM,
               OPPONENT_PREGAME_ELO = AWAY_PREGAME_ELO,
               OPPONENT_POSTGAME_ELO = AWAY_POSTGAME_ELO) %>%
        set_names(., gsub("HOME_", "", names(.))) %>%
        bind_rows(.,
                  sim_conference_championships %>% 
                          select(.id,
                                 SEASON,
                                 SEASON_TYPE,
                                 SIM_FROM_WEEK,
                                 WEEK,
                                 AWAY_TEAM,
                                 AWAY_CONFERENCE,
                                 AWAY_SIM_MARGIN,
                                 AWAY_SIM_OUTCOME,
                                 AWAY_PREGAME_ELO,
                                 HOME_PREGAME_ELO,
                                 AWAY_POSTGAME_ELO,
                                 HOME_POSTGAME_ELO,
                                 HOME_TEAM) %>%
                          rename(OPPONENT = HOME_TEAM,
                                 OPPONENT_PREGAME_ELO = HOME_PREGAME_ELO,
                                 OPPONENT_POSTGAME_ELO = HOME_POSTGAME_ELO) %>%
                          set_names(., gsub("AWAY_", "", names(.)))) %>%
        arrange(.id, WEEK) %>%
        left_join(., conference_divisions,
                  by = c("SEASON", "TEAM", "CONFERENCE"))

rm(conference_championship_matchups,
   sim_conference_championships)

playoff_matchups = sim_remaining_games %>%
        mutate(type = 'sim') %>%
        # add in simulated conference championps
        bind_rows(.,
                  sim_conference_championship_games %>%
                          mutate(DIVISION = 'fbs')) %>%
        nest(-.id, -SIM_FROM_WEEK) %>%
        mutate(data = future_map2(data,
                                  SIM_FROM_WEEK,
                                  ~ .x %>%
                                          rename(OUTCOME = SIM_OUTCOME,
                                                 MARGIN = SIM_MARGIN) %>%
                                          bind_rows(.,
                                                    games_so_far %>%
                                                            mutate(type = 'actual') %>%
                                                            filter(WEEK <= .y)))) %>%
        mutate(playoffs = future_map(data,
                                     ~ get_playoffs(.x))) %>%
        select(.id, SIM_FROM_WEEK, playoffs) %>%
        unnest()

# sim the playoff matchups
sim_playoffs = playoff_matchups %>%
        mutate(PREGAME_ELO = RATING) %>%
        select(.id, SIM_FROM_WEEK, SEASON, CONFERENCE, TEAM, PREGAME_ELO, playoff_rank) %>%
        mutate(PLAYOFF_GAME = case_when(playoff_rank %in% c(1,4) ~ '1v4',
                                        playoff_rank %in% c(2,3) ~ '2v3')) %>%
        mutate(MATCHUP = case_when(playoff_rank %in% c(1, 2) ~ 'HOME',
                                   playoff_rank %in% c(3, 4) ~ 'AWAY')) %>%
        pivot_wider(id_cols = c(".id", "SIM_FROM_WEEK", "SEASON", "PLAYOFF_GAME"),
                    names_from = c("MATCHUP"),
                    values_from = c("CONFERENCE", "TEAM", "PREGAME_ELO")) %>%
        mutate(SEASON_TYPE = 'playoff') %>%
        nest(-.id, -SIM_FROM_WEEK, -PLAYOFF_GAME, -SEASON, -SEASON_TYPE) %>%
        mutate(result=  future_map(data, ~ sim_game_margin(home_rating = .x$PREGAME_ELO_HOME,
                                                           away_rating = .x$PREGAME_ELO_AWAY,
                                                           points_model) %>%
                                           as_tibble() %>%
                                           rename(HOME_SIM_MARGIN = value) %>%
                                           bind_cols(.x, .) %>%
                                           mutate(HOME_SIM_MARGIN = case_when(HOME_SIM_MARGIN == 0 ~ sample(c(-1, 1), 1),
                                                                              TRUE ~ HOME_SIM_MARGIN)) %>%
                                           mutate(WINNER= case_when(HOME_SIM_MARGIN > 0 ~ TEAM_HOME,
                                                                    HOME_SIM_MARGIN <0 ~ TEAM_AWAY),
                                                  RUNNER_UP = case_when(HOME_SIM_MARGIN >= 0 ~ TEAM_AWAY,
                                                                        HOME_SIM_MARGIN <0 ~ TEAM_HOME)))) %>%
        mutate(update = future_map2(data, result, ~ get_new_elos(home_rating = .x$PREGAME_ELO_HOME,
                                                                 away_rating = .x$PREGAME_ELO_AWAY,
                                                                 home_field_advantage = 0,
                                                                 home_margin = .y$HOME_SIM_MARGIN,
                                                                 k = elo_pars$k,
                                                                 v = elo_pars$v) %>%
                                            t() %>%
                                            as_tibble() %>%
                                            set_names(c("HOME_POSTGAME_ELO",
                                                        "AWAY_POSTGAME_ELO",
                                                        "HOME_EXPECTED_SCORE",
                                                        "AWAY_EXPECTED_SCORE")))) %>%
        select(.id, SIM_FROM_WEEK, PLAYOFF_GAME, SEASON, SEASON_TYPE, data, result, update) %>%
        unnest() %>%
        ungroup() %>%
        select(.id, 
               SIM_FROM_WEEK,
               PLAYOFF_GAME,
               SEASON, 
               SEASON_TYPE,
               CONFERENCE_HOME, 
               CONFERENCE_AWAY, 
               TEAM_HOME, 
               TEAM_AWAY, 
               PREGAME_ELO_HOME,
               PREGAME_ELO_AWAY,
               HOME_POSTGAME_ELO, 
               AWAY_POSTGAME_ELO,
               HOME_SIM_MARGIN, 
               WINNER,
               RUNNER_UP) %>%
        rename(HOME_TEAM = TEAM_HOME,
               AWAY_TEAM = TEAM_AWAY,
               HOME_PREGAME_ELO = PREGAME_ELO_HOME,
               AWAY_PREGAME_ELO = PREGAME_ELO_AWAY,
               HOME_SIM_MARGIN = HOME_SIM_MARGIN,
               HOME_CONFERENCE = CONFERENCE_HOME,
               AWAY_CONFERENCE = CONFERENCE_AWAY) %>%
        mutate(AWAY_SIM_MARGIN = -HOME_SIM_MARGIN) %>%
        mutate(WEEK = max_week + 2) %>%
        select(.id, 
               SIM_FROM_WEEK,
               PLAYOFF_GAME,
               SEASON, HOME_CONFERENCE, AWAY_CONFERENCE, SEASON_TYPE, WEEK, HOME_TEAM, AWAY_TEAM, HOME_SIM_MARGIN, AWAY_SIM_MARGIN, HOME_PREGAME_ELO, AWAY_PREGAME_ELO, HOME_POSTGAME_ELO, AWAY_POSTGAME_ELO)  %>%
        mutate(HOME_SIM_OUTCOME = case_when(HOME_SIM_MARGIN > 0 ~ 'win',
                                            HOME_SIM_MARGIN < 0 ~ 'loss'),
               AWAY_SIM_OUTCOME = case_when(HOME_SIM_MARGIN > 0 ~ 'loss',
                                            HOME_SIM_MARGIN < 0 ~ 'win'))

# flip to teams
sim_playoff_games  = sim_playoffs %>%
        select(.id, 
               SIM_FROM_WEEK,
               PLAYOFF_GAME,
               SEASON,
               SEASON_TYPE,
               WEEK,
               HOME_TEAM,
               HOME_CONFERENCE,
               HOME_SIM_MARGIN,
               HOME_SIM_OUTCOME,
               HOME_PREGAME_ELO,
               HOME_POSTGAME_ELO,
               AWAY_PREGAME_ELO,
               AWAY_POSTGAME_ELO,
               AWAY_TEAM) %>%
        rename(OPPONENT = AWAY_TEAM,
               OPPONENT_PREGAME_ELO = AWAY_PREGAME_ELO,
               OPPONENT_POSTGAME_ELO = AWAY_POSTGAME_ELO) %>%
        set_names(., gsub("HOME_", "", names(.))) %>%
        bind_rows(.,
                  sim_playoffs %>% 
                          select(.id,
                                 SIM_FROM_WEEK,
                                 PLAYOFF_GAME,
                                 SEASON,
                                 SEASON_TYPE,
                                 WEEK,
                                 AWAY_TEAM,
                                 AWAY_CONFERENCE,
                                 AWAY_SIM_MARGIN,
                                 AWAY_SIM_OUTCOME,
                                 AWAY_PREGAME_ELO,
                                 HOME_PREGAME_ELO,
                                 AWAY_POSTGAME_ELO,
                                 HOME_POSTGAME_ELO,
                                 HOME_TEAM) %>%
                          rename(OPPONENT = HOME_TEAM,
                                 OPPONENT_PREGAME_ELO = HOME_PREGAME_ELO,
                                 OPPONENT_POSTGAME_ELO = HOME_POSTGAME_ELO) %>%
                          set_names(., gsub("AWAY_", "", names(.)))) %>%
        arrange(.id, WEEK) %>%
        left_join(., team_conference_season %>%
                          select(SEASON, TEAM, CONFERENCE, DIVISION),
                  by = c("SEASON", "TEAM", "CONFERENCE")) %>%
        filter(DIVISION == 'fbs')

rm(playoff_matchups,
   sim_playoffs)

# get playoff winners
nc_matchups = sim_playoff_games %>%
        filter(SIM_OUTCOME == 'win') %>%
        select(.id, SIM_FROM_WEEK, SEASON, PLAYOFF_GAME, TEAM, CONFERENCE, POSTGAME_ELO) %>%
        rename(PREGAME_ELO = POSTGAME_ELO) %>%
        arrange(.id, SIM_FROM_WEEK) %>%
        group_by(.id, SIM_FROM_WEEK, SEASON) %>%
        mutate(ID = row_number()) %>%
        ungroup() %>%
        mutate(MATCHUP = case_when(ID == 1 ~ 'HOME',
                                   ID == 2 ~ 'AWAY')) %>%
        select(-PLAYOFF_GAME)

sim_nc = nc_matchups %>%
        pivot_wider(., id_cols = c(".id", "SIM_FROM_WEEK", "SEASON"),
                    names_from = c("MATCHUP"),
                    values_from = c("TEAM", "PREGAME_ELO","CONFERENCE")) %>%
        mutate(SEASON_TYPE = 'national_championship') %>%
        nest(-.id, -SIM_FROM_WEEK, -SEASON, -SEASON_TYPE) %>%
        mutate(result= future_map(data, ~ sim_game_margin(home_rating = .x$PREGAME_ELO_HOME,
                                                          away_rating = .x$PREGAME_ELO_AWAY,
                                                          points_model) %>%
                                          as_tibble() %>%
                                          rename(HOME_SIM_MARGIN = value) %>%
                                          bind_cols(.x, .) %>%
                                          mutate(HOME_SIM_MARGIN = case_when(HOME_SIM_MARGIN == 0 ~ sample(c(-1, 1), 1),
                                                                             TRUE ~ HOME_SIM_MARGIN)) %>%
                                          mutate(WINNER= case_when(HOME_SIM_MARGIN > 0 ~ TEAM_HOME,
                                                                   HOME_SIM_MARGIN <0 ~ TEAM_AWAY),
                                                 RUNNER_UP = case_when(HOME_SIM_MARGIN >= 0 ~ TEAM_AWAY,
                                                                       HOME_SIM_MARGIN <0 ~ TEAM_HOME)))) %>%
        mutate(update = future_map2(data, result, ~ get_new_elos(home_rating = .x$PREGAME_ELO_HOME,
                                                                 away_rating = .x$PREGAME_ELO_AWAY,
                                                                 home_field_advantage = 0,
                                                                 home_margin = .y$HOME_SIM_MARGIN,
                                                                 k = elo_pars$k,
                                                                 v = elo_pars$v) %>%
                                            t() %>%
                                            as_tibble() %>%
                                            set_names(c("HOME_POSTGAME_ELO",
                                                        "AWAY_POSTGAME_ELO",
                                                        "HOME_EXPECTED_SCORE",
                                                        "AWAY_EXPECTED_SCORE")))) %>%
        select(.id, SIM_FROM_WEEK, SEASON, SEASON_TYPE, data, result, update) %>%
        unnest() %>%
        ungroup() %>%
        select(.id, 
               SIM_FROM_WEEK,
               SEASON, 
               SEASON_TYPE,
               CONFERENCE_HOME, 
               CONFERENCE_AWAY, 
               TEAM_HOME, 
               TEAM_AWAY, 
               PREGAME_ELO_HOME,
               PREGAME_ELO_AWAY,
               HOME_POSTGAME_ELO, 
               AWAY_POSTGAME_ELO,
               HOME_SIM_MARGIN, 
               WINNER,
               RUNNER_UP) %>%
        rename(HOME_TEAM = TEAM_HOME,
               AWAY_TEAM = TEAM_AWAY,
               HOME_PREGAME_ELO = PREGAME_ELO_HOME,
               AWAY_PREGAME_ELO = PREGAME_ELO_AWAY,
               HOME_SIM_MARGIN = HOME_SIM_MARGIN,
               HOME_CONFERENCE = CONFERENCE_HOME,
               AWAY_CONFERENCE = CONFERENCE_AWAY) %>%
        mutate(AWAY_SIM_MARGIN = -HOME_SIM_MARGIN) %>%
        mutate(WEEK = max_week + 3) %>%
        select(.id, 
               SIM_FROM_WEEK,
               SEASON, HOME_CONFERENCE, AWAY_CONFERENCE, SEASON_TYPE, WEEK, HOME_TEAM, AWAY_TEAM, HOME_SIM_MARGIN, AWAY_SIM_MARGIN, HOME_PREGAME_ELO, AWAY_PREGAME_ELO, HOME_POSTGAME_ELO, AWAY_POSTGAME_ELO)  %>%
        mutate(HOME_SIM_OUTCOME = case_when(HOME_SIM_MARGIN > 0 ~ 'win',
                                            HOME_SIM_MARGIN < 0 ~ 'loss'),
               AWAY_SIM_OUTCOME = case_when(HOME_SIM_MARGIN > 0 ~ 'loss',
                                            HOME_SIM_MARGIN < 0 ~ 'win'))

sim_nc_games  = sim_nc  %>%
        select(.id, 
               SIM_FROM_WEEK,
               SEASON,
               SEASON_TYPE,
               WEEK,
               HOME_TEAM,
               HOME_CONFERENCE,
               HOME_SIM_MARGIN,
               HOME_SIM_OUTCOME,
               HOME_PREGAME_ELO,
               HOME_POSTGAME_ELO,
               AWAY_PREGAME_ELO,
               AWAY_POSTGAME_ELO,
               AWAY_TEAM) %>%
        rename(OPPONENT = AWAY_TEAM,
               OPPONENT_PREGAME_ELO = AWAY_PREGAME_ELO,
               OPPONENT_POSTGAME_ELO = AWAY_POSTGAME_ELO) %>%
        set_names(., gsub("HOME_", "", names(.))) %>%
        bind_rows(.,
                  sim_nc  %>% 
                          select(.id,
                                 SIM_FROM_WEEK,
                                 SEASON,
                                 SEASON_TYPE,
                                 WEEK,
                                 AWAY_TEAM,
                                 AWAY_CONFERENCE,
                                 AWAY_SIM_MARGIN,
                                 AWAY_SIM_OUTCOME,
                                 AWAY_PREGAME_ELO,
                                 HOME_PREGAME_ELO,
                                 AWAY_POSTGAME_ELO,
                                 HOME_POSTGAME_ELO,
                                 HOME_TEAM) %>%
                          rename(OPPONENT = HOME_TEAM,
                                 OPPONENT_PREGAME_ELO = HOME_PREGAME_ELO,
                                 OPPONENT_POSTGAME_ELO = HOME_POSTGAME_ELO) %>%
                          set_names(., gsub("AWAY_", "", names(.)))) %>%
        arrange(.id, WEEK) %>%
        left_join(., team_conference_season %>%
                          select(SEASON, TEAM, CONFERENCE, DIVISION),
                  by = c("SEASON", "TEAM", "CONFERENCE")) %>%
        filter(DIVISION == 'fbs')

rm(sim_nc,
   nc_matchups)

all_simulations = list("sim_from_week" = params$sim_week, 
                       "sim_remaining_games" = sim_remaining_games,
                       "sim_conference_championship_games" = sim_conference_championship_games,
                       "sim_playoff_games" = sim_playoff_games,
                       "sim_nc_games" = sim_nc_games)

```

```{r aggregate simulations to get game predictions}

# aggregate simulations to get predictions for each game
game_predictions = season_simulations$game_outcomes %>%
                          group_by(GAME_ID, SIM_FROM_WEEK) %>%
                          mutate(HOME_SIM_PRED = case_when(HOME_SIM_MARGIN >0 ~ 1,
                                                           TRUE ~ 0)) %>%
                          summarize(HOME_PREGAME_ELO = mean(HOME_PREGAME_ELO),
                                    AWAY_PREGAME_ELO = mean(AWAY_PREGAME_ELO),
                                    HOME_POSTGAME_ELO = mean(HOME_POSTGAME_ELO),
                                    AWAY_POSTGAME_ELO = mean(AWAY_POSTGAME_ELO),
                                    home_wins = sum(HOME_SIM_PRED),
                                    home_margin = median(HOME_SIM_MARGIN),
                                    n = n(),
                                    .groups = 'drop') %>%
                          mutate(HOME_SIM_PROB = home_wins / n) %>%
                          mutate(HOME_SIM_MARGIN = home_margin) %>%
                          select(SIM_FROM_WEEK, GAME_ID,
                                 HOME_PREGAME_ELO,
                                 AWAY_PREGAME_ELO,
                                 HOME_POSTGAME_ELO,
                                 AWAY_POSTGAME_ELO,
                                 HOME_SIM_PROB,
                                 HOME_SIM_MARGIN)

```


```{r create info for main table}

# create table with all info
team_predictions = all_simulations$sim_remaining_games %>%
        mutate(type = 'sim') %>%
        nest(-.id, -SIM_FROM_WEEK) %>%
        mutate(data =future_map2(data,
                           SIM_FROM_WEEK,
                           ~ .x %>%
                                   rename(OUTCOME = SIM_OUTCOME,
                                          MARGIN = SIM_MARGIN) %>%
                                   bind_rows(.,
                                             games_so_far %>%
                                                     mutate(type = 'actual') %>%
                                                     filter(WEEK <= .y)))) %>%
        unnest() %>%
        filter(DIVISION == 'fbs') %>%
        mutate(sims = n_distinct(.id)) %>%
        mutate(WIN = case_when(OUTCOME == 'win' ~ 1,
                               TRUE ~ 0)) %>%
        group_by(.id, SEASON, SIM_FROM_WEEK, TEAM, OUTCOME) %>%
        count() %>%
        spread(OUTCOME, n) %>%
        ungroup() %>%
        mutate_at(c("loss", "win"),
                  ~ replace_na(., 0)) %>%
        mutate(bowl_game = case_when(win >= 6 ~ 1,
                                     TRUE ~ 0)) %>%
        group_by(SEASON, SIM_FROM_WEEK, TEAM) %>%
        summarize(made_bowl = sum(bowl_game),
                  mean_wins = mean(win),
                  mean_loss = mean(loss),
                  .groups = 'drop') %>%
        # add conference championships
        left_join(.,
                  all_simulations$sim_conference_championship_games %>%
                          group_by(SEASON, SIM_FROM_WEEK, TEAM, SIM_OUTCOME) %>% 
                          count() %>% 
                          spread(SIM_OUTCOME, n) %>% 
                          mutate_at(c("win", "loss"), ~ replace_na(., 0)) %>%
                          ungroup() %>% 
                          mutate(made_conf = win + loss, 
                                 win_conf = win) %>%
                          select(SEASON, SIM_FROM_WEEK, TEAM, made_conf, win_conf),
                  by = c("SEASON", "TEAM", "SIM_FROM_WEEK")) %>%
        # add playoff 
        left_join(.,
                  all_simulations$sim_playoff_games %>%
                          group_by(SEASON, SIM_FROM_WEEK, TEAM, SIM_OUTCOME) %>% 
                          count() %>% 
                          spread(SIM_OUTCOME, n) %>% 
                          mutate_at(c("win", "loss"), ~ replace_na(., 0)) %>%
                          ungroup() %>% 
                          mutate(made_playoff = win + loss, 
                                 made_nc = win) %>%
                          select(SEASON, SIM_FROM_WEEK, TEAM, made_playoff, made_nc),
                  by = c("SEASON", "TEAM", "SIM_FROM_WEEK")) %>%
        # add national championship
        left_join(.,
                  all_simulations$sim_nc_games %>%
                          group_by(SEASON, SIM_FROM_WEEK, TEAM, SIM_OUTCOME) %>% 
                          count() %>% 
                          spread(SIM_OUTCOME, n) %>% 
                          mutate_at(c("win", "loss"), ~ replace_na(., 0)) %>%
                          ungroup() %>% 
                          mutate(win_nc = win) %>%
                          select(SEASON, SIM_FROM_WEEK, TEAM, win_nc),
                  by = c("SEASON", "TEAM", "SIM_FROM_WEEK")) %>%
        mutate_if(is.numeric, replace_na, 0) %>%
        # add actual elo for each week
        left_join(.,
                  season_weeks_teams %>%
                          left_join(.,
                                    team_elo_so_far,
                                    by = c("SEASON", "WEEK", "TEAM")) %>%
                          arrange(SEASON, TEAM, WEEK) %>%
                          group_by(TEAM) %>%
                          fill(RATING, .direction = 'updown') %>%
                          rename(SIM_FROM_WEEK = WEEK),
                  by = c("SEASON", "TEAM", "SIM_FROM_WEEK")) %>%
        left_join(., conference_divisions,
                  by = c("TEAM", "SEASON")) %>%
        # flip to probabilities
        mutate_at(c("made_bowl",
                    "made_conf",
                    "win_conf",
                    "made_playoff",
                    "made_nc",
                    "win_nc"),
                  ~ . / params$nsims)

```

```{r save and load }

# add to list
all_simulations$team_predictions = team_predictions
all_simulations$game_predictions = game_predictions

# save 
save(all_simulations,
     file = here::here("simulations",
                   "season",
                   params$input_season,
                   paste("sims_week_",
                         params$sim_week,
                         ".Rdata",
                         sep="")))

```

```{r rm current}

rm(all_simulations,
   team_predictions,
   game_predictions)

```
